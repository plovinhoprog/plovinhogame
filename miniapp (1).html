<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Treasure Chest</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600;700&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    --gold:       #f0c040;
    --gold-dim:   #a07820;
    --gold-glow:  rgba(240,192,64,0.35);
    --crimson:    #c0392b;
    --emerald:    #27ae60;
    --sapphire:   #2980b9;
    --amethyst:   #8e44ad;
    --legendary:  #f39c12;
    --bg:         #0a0806;
    --bg2:        #110e09;
    --bg3:        #1a1510;
    --panel:      rgba(26,21,16,0.92);
    --border:     rgba(240,192,64,0.18);
    --text:       #e8d8b0;
    --text-dim:   #8a7855;
    --shadow:     rgba(0,0,0,0.8);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  html, body {
    height: 100%; width: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'EB Garamond', serif;
    font-size: 16px;
    overflow: hidden;
    user-select: none;
  }

  /* â”€â”€ Starfield Background â”€â”€ */
  #stars {
    position: fixed; inset: 0; z-index: 0;
    background:
      radial-gradient(ellipse at 20% 50%, rgba(120,80,20,0.12) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 20%, rgba(60,20,10,0.15) 0%, transparent 50%),
      radial-gradient(ellipse at 50% 100%, rgba(80,40,10,0.2) 0%, transparent 60%),
      #0a0806;
    overflow: hidden;
  }
  #stars::before, #stars::after {
    content: '';
    position: absolute; inset: 0;
    background-image:
      radial-gradient(1px 1px at 10% 15%, rgba(255,220,120,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 25% 40%, rgba(255,200,80,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 70% 10%, rgba(255,240,180,0.7) 0%, transparent 100%),
      radial-gradient(1px 1px at 85% 60%, rgba(255,210,100,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 45% 75%, rgba(255,230,140,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 90% 85%, rgba(255,220,120,0.3) 0%, transparent 100%),
      radial-gradient(1.5px 1.5px at 30% 90%, rgba(255,240,180,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 60% 55%, rgba(255,200,80,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 15% 70%, rgba(255,220,120,0.3) 0%, transparent 100%),
      radial-gradient(1.5px 1.5px at 55% 25%, rgba(255,240,180,0.5) 0%, transparent 100%);
    animation: twinkle 4s ease-in-out infinite alternate;
  }
  #stars::after {
    background-image:
      radial-gradient(1px 1px at 5% 30%, rgba(255,220,120,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 40% 5%, rgba(255,200,80,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 75% 45%, rgba(255,240,180,0.3) 0%, transparent 100%),
      radial-gradient(1.5px 1.5px at 95% 20%, rgba(255,220,120,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 20% 55%, rgba(255,210,100,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 65% 80%, rgba(255,230,140,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 80% 95%, rgba(255,220,120,0.3) 0%, transparent 100%);
    animation-delay: 2s; animation-duration: 5s;
  }
  @keyframes twinkle {
    0%   { opacity: 0.6; transform: scale(1); }
    100% { opacity: 1;   transform: scale(1.05); }
  }

  /* â”€â”€ Layout â”€â”€ */
  #app {
    position: relative; z-index: 1;
    height: 100vh; width: 100%;
    display: flex; flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€ Header â”€â”€ */
  header {
    flex-shrink: 0;
    padding: 14px 18px 10px;
    background: linear-gradient(180deg, rgba(10,8,6,0.98) 0%, rgba(10,8,6,0.0) 100%);
    display: flex; align-items: center; justify-content: space-between;
  }
  .logo {
    font-family: 'Cinzel Decorative', serif;
    font-size: 15px; font-weight: 700;
    color: var(--gold);
    text-shadow: 0 0 20px var(--gold-glow), 0 0 40px rgba(240,192,64,0.2);
    letter-spacing: 0.03em;
  }
  .logo span { color: var(--text-dim); font-size: 11px; display: block;
    font-family: 'EB Garamond', serif; font-weight: 400; letter-spacing: 0.1em;
    text-transform: uppercase; margin-top: 1px; }
  .gold-display {
    display: flex; align-items: center; gap: 6px;
    background: rgba(240,192,64,0.08);
    border: 1px solid rgba(240,192,64,0.25);
    border-radius: 20px; padding: 6px 14px;
  }
  .gold-coin { font-size: 16px; animation: spin3d 3s linear infinite; }
  @keyframes spin3d {
    0%   { transform: rotateY(0deg); }
    45%  { transform: rotateY(0deg); }
    50%  { transform: rotateY(90deg); }
    55%  { transform: rotateY(0deg); }
    100% { transform: rotateY(0deg); }
  }
  .gold-amount {
    font-family: 'Cinzel', serif; font-size: 15px; font-weight: 600;
    color: var(--gold);
    text-shadow: 0 0 10px var(--gold-glow);
    min-width: 50px; text-align: right;
    transition: all 0.4s;
  }

  /* â”€â”€ Navigation â”€â”€ */
  nav {
    flex-shrink: 0;
    display: flex; gap: 4px;
    padding: 0 14px 10px;
  }
  .nav-btn {
    flex: 1; padding: 8px 4px;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 10px;
    color: var(--text-dim);
    font-family: 'Cinzel', serif; font-size: 10px;
    font-weight: 600; letter-spacing: 0.05em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.25s;
    display: flex; flex-direction: column; align-items: center; gap: 3px;
  }
  .nav-btn .nav-icon { font-size: 18px; }
  .nav-btn.active {
    background: rgba(240,192,64,0.1);
    border-color: rgba(240,192,64,0.35);
    color: var(--gold);
    text-shadow: 0 0 8px var(--gold-glow);
    box-shadow: 0 0 12px rgba(240,192,64,0.1) inset;
  }
  .nav-btn:active { transform: scale(0.95); }

  /* â”€â”€ Screens â”€â”€ */
  #screens {
    flex: 1; overflow: hidden; position: relative;
  }
  .screen {
    position: absolute; inset: 0;
    overflow-y: auto; overflow-x: hidden;
    padding: 0 14px 20px;
    opacity: 0; transform: translateY(16px);
    pointer-events: none;
    transition: opacity 0.3s, transform 0.3s;
  }
  .screen.active {
    opacity: 1; transform: translateY(0);
    pointer-events: all;
  }
  .screen::-webkit-scrollbar { width: 3px; }
  .screen::-webkit-scrollbar-track { background: transparent; }
  .screen::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 3px; }

  /* â”€â”€ Section Title â”€â”€ */
  .section-title {
    font-family: 'Cinzel', serif; font-size: 11px; font-weight: 600;
    letter-spacing: 0.2em; text-transform: uppercase;
    color: var(--text-dim);
    margin: 16px 0 10px;
    display: flex; align-items: center; gap: 10px;
  }
  .section-title::after {
    content: ''; flex: 1; height: 1px;
    background: linear-gradient(90deg, var(--border), transparent);
  }

  /* â”€â”€ CHEST SCREEN â”€â”€ */
  .chest-grid {
    display: grid; grid-template-columns: 1fr;
    gap: 12px; padding-top: 4px;
  }
  .chest-card {
    position: relative; overflow: hidden;
    border: 1px solid var(--border);
    border-radius: 16px;
    background: var(--panel);
    backdrop-filter: blur(10px);
    padding: 18px 20px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex; align-items: center; gap: 16px;
  }
  .chest-card::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(135deg, rgba(240,192,64,0.06) 0%, transparent 60%);
    opacity: 0; transition: opacity 0.3s;
  }
  .chest-card:active { transform: scale(0.98); }
  .chest-card:active::before { opacity: 1; }
  .chest-card.wooden { border-color: rgba(139,90,43,0.4); }
  .chest-card.silver { border-color: rgba(180,190,200,0.4); }
  .chest-card.golden { border-color: rgba(240,192,64,0.5);
    box-shadow: 0 0 20px rgba(240,192,64,0.08); }

  .chest-icon-wrap {
    font-size: 44px; flex-shrink: 0;
    filter: drop-shadow(0 0 8px rgba(240,192,64,0.3));
    animation: float 3s ease-in-out infinite;
  }
  .chest-card.silver .chest-icon-wrap { animation-delay: 1s; }
  .chest-card.golden .chest-icon-wrap { animation-delay: 2s;
    filter: drop-shadow(0 0 14px rgba(240,192,64,0.6)); }
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50%       { transform: translateY(-5px); }
  }
  .chest-info { flex: 1; }
  .chest-name {
    font-family: 'Cinzel', serif; font-size: 15px; font-weight: 700;
    color: var(--text); margin-bottom: 4px;
  }
  .chest-desc {
    font-size: 13px; color: var(--text-dim);
    font-style: italic; margin-bottom: 8px;
  }
  .chest-odds {
    display: flex; gap: 5px; flex-wrap: wrap;
  }
  .odds-pill {
    font-size: 10px; padding: 2px 7px; border-radius: 10px;
    font-family: 'Cinzel', serif; font-weight: 600;
  }
  .odds-pill.common    { background: rgba(150,150,150,0.15); color: #aaa; border: 1px solid rgba(150,150,150,0.3); }
  .odds-pill.uncommon  { background: rgba(39,174,96,0.15);   color: #2ecc71; border: 1px solid rgba(39,174,96,0.3); }
  .odds-pill.rare      { background: rgba(41,128,185,0.15);  color: #5dade2; border: 1px solid rgba(41,128,185,0.3); }
  .odds-pill.epic      { background: rgba(142,68,173,0.15);  color: #bb8fce; border: 1px solid rgba(142,68,173,0.3); }
  .odds-pill.legendary { background: rgba(243,156,18,0.15);  color: #f0c040; border: 1px solid rgba(243,156,18,0.3); }

  .chest-cost {
    flex-shrink: 0; text-align: center;
  }
  .cost-amount {
    font-family: 'Cinzel', serif; font-size: 18px; font-weight: 700;
    color: var(--gold); display: block;
    text-shadow: 0 0 10px var(--gold-glow);
  }
  .cost-label { font-size: 10px; color: var(--text-dim); letter-spacing: 0.1em; text-transform: uppercase; }
  .chest-card.locked { opacity: 0.45; }

  /* â”€â”€ OPEN ANIMATION OVERLAY â”€â”€ */
  #open-overlay {
    position: fixed; inset: 0; z-index: 100;
    background: rgba(0,0,0,0.92);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 24px;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
  }
  #open-overlay.visible { opacity: 1; pointer-events: all; }

  .opening-chest {
    font-size: 90px;
    animation: shake 0.3s ease-in-out infinite;
    filter: drop-shadow(0 0 30px rgba(240,192,64,0.5));
  }
  @keyframes shake {
    0%,100% { transform: rotate(-3deg) scale(1); }
    50%      { transform: rotate(3deg) scale(1.05); }
  }
  .opening-text {
    font-family: 'Cinzel', serif; font-size: 14px; letter-spacing: 0.3em;
    text-transform: uppercase; color: var(--text-dim);
    animation: pulse-text 0.8s ease-in-out infinite alternate;
  }
  @keyframes pulse-text { from { opacity: 0.4; } to { opacity: 1; } }

  /* â”€â”€ REWARD OVERLAY â”€â”€ */
  #reward-overlay {
    position: fixed; inset: 0; z-index: 101;
    background: rgba(0,0,0,0.88);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 16px;
    opacity: 0; pointer-events: none;
    transition: opacity 0.4s;
  }
  #reward-overlay.visible { opacity: 1; pointer-events: all; }

  .reward-particles {
    position: absolute; inset: 0; pointer-events: none; overflow: hidden;
  }
  .particle {
    position: absolute; border-radius: 50%;
    animation: particle-fly 1.5s ease-out forwards;
    opacity: 0;
  }
  @keyframes particle-fly {
    0%   { transform: translate(0,0) scale(0); opacity: 1; }
    100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
  }

  .reward-badge {
    font-size: 11px; padding: 4px 16px; border-radius: 20px;
    font-family: 'Cinzel', serif; font-weight: 600; letter-spacing: 0.15em;
    text-transform: uppercase;
    animation: badge-drop 0.4s cubic-bezier(0.34,1.56,0.64,1) 0.1s both;
  }
  .reward-badge.Common    { background: rgba(150,150,150,0.2); color: #ccc; border: 1px solid rgba(200,200,200,0.3); }
  .reward-badge.Uncommon  { background: rgba(39,174,96,0.2); color: #2ecc71; border: 1px solid rgba(39,174,96,0.4); }
  .reward-badge.Rare      { background: rgba(41,128,185,0.2); color: #5dade2; border: 1px solid rgba(41,128,185,0.4); }
  .reward-badge.Epic      { background: rgba(142,68,173,0.25); color: #bb8fce; border: 1px solid rgba(142,68,173,0.5); box-shadow: 0 0 20px rgba(142,68,173,0.3); }
  .reward-badge.Legendary { background: rgba(243,156,18,0.2); color: #f0c040; border: 1px solid rgba(243,156,18,0.6); box-shadow: 0 0 30px rgba(240,192,64,0.4); }
  @keyframes badge-drop { from { transform: translateY(-20px) scale(0.8); opacity: 0; } to { transform: none; opacity: 1; } }

  .reward-item-icon {
    font-size: 72px;
    animation: item-appear 0.5s cubic-bezier(0.34,1.56,0.64,1) 0.2s both;
    filter: drop-shadow(0 0 20px rgba(240,192,64,0.4));
  }
  @keyframes item-appear { from { transform: scale(0) rotate(-15deg); opacity: 0; } to { transform: none; opacity: 1; } }

  .reward-item-name {
    font-family: 'Cinzel', serif; font-size: 22px; font-weight: 700;
    color: var(--text); text-align: center;
    animation: item-appear 0.5s cubic-bezier(0.34,1.56,0.64,1) 0.3s both;
  }
  .reward-item-name.Legendary { color: var(--gold); text-shadow: 0 0 20px var(--gold-glow), 0 0 40px var(--gold-glow); }
  .reward-item-name.Epic      { color: #bb8fce; text-shadow: 0 0 15px rgba(142,68,173,0.6); }

  .reward-value {
    font-size: 15px; color: var(--text-dim); font-style: italic;
    animation: item-appear 0.5s ease 0.4s both;
  }
  .reward-value span { color: var(--gold); font-style: normal; font-family: 'Cinzel', serif; }

  .reward-actions {
    display: flex; gap: 10px; margin-top: 8px;
    animation: item-appear 0.4s ease 0.55s both;
  }
  .btn-primary {
    padding: 12px 24px;
    background: linear-gradient(135deg, #a07820, #f0c040, #a07820);
    background-size: 200% 100%; background-position: 100%;
    border: none; border-radius: 12px;
    font-family: 'Cinzel', serif; font-size: 13px; font-weight: 700;
    color: #1a1000; letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(240,192,64,0.3);
  }
  .btn-primary:active { transform: scale(0.96); background-position: 0%; }
  .btn-secondary {
    padding: 12px 20px;
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--border);
    border-radius: 12px;
    font-family: 'Cinzel', serif; font-size: 13px; font-weight: 600;
    color: var(--text-dim); letter-spacing: 0.05em;
    cursor: pointer; transition: all 0.2s;
  }
  .btn-secondary:active { transform: scale(0.96); background: rgba(255,255,255,0.1); }

  /* â”€â”€ INVENTORY â”€â”€ */
  .inv-stats {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 10px; margin-bottom: 4px;
  }
  .stat-card {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 12px; padding: 12px 14px;
    backdrop-filter: blur(8px);
  }
  .stat-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase;
    letter-spacing: 0.1em; font-family: 'Cinzel', serif; margin-bottom: 4px; }
  .stat-value { font-family: 'Cinzel', serif; font-size: 18px; font-weight: 700; color: var(--gold); }

  .sell-all-btn {
    width: 100%; padding: 12px;
    background: rgba(192,57,43,0.12);
    border: 1px solid rgba(192,57,43,0.3);
    border-radius: 12px;
    font-family: 'Cinzel', serif; font-size: 12px; font-weight: 600;
    color: #e74c3c; letter-spacing: 0.1em; text-transform: uppercase;
    cursor: pointer; transition: all 0.2s; margin-bottom: 4px;
  }
  .sell-all-btn:active { background: rgba(192,57,43,0.25); transform: scale(0.98); }

  .inv-item {
    display: flex; align-items: center; gap: 12px;
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 12px; padding: 12px 14px; margin-bottom: 8px;
    cursor: pointer; transition: all 0.2s;
    backdrop-filter: blur(8px);
  }
  .inv-item:active { transform: scale(0.98); background: rgba(240,192,64,0.06); }
  .inv-item.rarity-Legendary { border-color: rgba(240,192,64,0.45);
    box-shadow: 0 0 12px rgba(240,192,64,0.08); }
  .inv-item.rarity-Epic      { border-color: rgba(142,68,173,0.4); }
  .inv-item.rarity-Rare      { border-color: rgba(41,128,185,0.35); }

  .item-emoji { font-size: 28px; flex-shrink: 0; }
  .item-info  { flex: 1; min-width: 0; }
  .item-name  { font-family: 'Cinzel', serif; font-size: 13px; font-weight: 600;
    color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .item-rarity { font-size: 11px; margin-top: 2px; }
  .item-rarity.Common    { color: #aaa; }
  .item-rarity.Uncommon  { color: #2ecc71; }
  .item-rarity.Rare      { color: #5dade2; }
  .item-rarity.Epic      { color: #bb8fce; }
  .item-rarity.Legendary { color: var(--gold); }
  .item-right { text-align: right; flex-shrink: 0; }
  .item-count { font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-dim); }
  .item-value { font-family: 'Cinzel', serif; font-size: 14px; font-weight: 600;
    color: var(--gold); margin-top: 2px; }

  /* â”€â”€ SELL MODAL â”€â”€ */
  #sell-modal {
    position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.85);
    display: flex; align-items: flex-end; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
  }
  #sell-modal.visible { opacity: 1; pointer-events: all; }
  .sell-sheet {
    width: 100%; max-width: 480px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-bottom: none;
    border-radius: 24px 24px 0 0;
    padding: 28px 24px 36px;
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.32,0.72,0,1);
  }
  #sell-modal.visible .sell-sheet { transform: translateY(0); }
  .sell-handle { width: 40px; height: 4px; background: var(--border);
    border-radius: 2px; margin: 0 auto 20px; }
  .sell-item-display { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
  .sell-item-icon { font-size: 52px; }
  .sell-item-details {}
  .sell-item-name  { font-family: 'Cinzel', serif; font-size: 17px; font-weight: 700; color: var(--text); }
  .sell-item-sub   { font-size: 13px; color: var(--text-dim); margin-top: 3px; font-style: italic; }
  .sell-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .sell-option {
    padding: 14px 10px; border-radius: 12px;
    background: rgba(240,192,64,0.06);
    border: 1px solid rgba(240,192,64,0.2);
    text-align: center; cursor: pointer; transition: all 0.2s;
  }
  .sell-option:active { background: rgba(240,192,64,0.15); transform: scale(0.96); }
  .sell-option.sell-all-opt {
    grid-column: 1/-1;
    background: rgba(192,57,43,0.1);
    border-color: rgba(192,57,43,0.3);
  }
  .sell-option.sell-all-opt:active { background: rgba(192,57,43,0.2); }
  .sell-opt-count { font-family: 'Cinzel', serif; font-size: 13px; font-weight: 700;
    color: var(--text); margin-bottom: 2px; }
  .sell-opt-gold  { font-size: 12px; color: var(--gold); }
  .sell-cancel {
    width: 100%; margin-top: 12px; padding: 12px;
    background: transparent; border: 1px solid var(--border);
    border-radius: 12px; color: var(--text-dim);
    font-family: 'Cinzel', serif; font-size: 12px;
    cursor: pointer; transition: all 0.2s;
  }
  .sell-cancel:active { background: rgba(255,255,255,0.05); }

  /* â”€â”€ PROFILE â”€â”€ */
  .profile-hero {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 16px; padding: 20px;
    margin-bottom: 12px; text-align: center;
    backdrop-filter: blur(10px);
    position: relative; overflow: hidden;
  }
  .profile-hero::before {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(240,192,64,0.08) 0%, transparent 70%);
  }
  .profile-avatar { font-size: 56px; margin-bottom: 8px;
    filter: drop-shadow(0 0 16px rgba(240,192,64,0.4)); }
  .profile-name { font-family: 'Cinzel', serif; font-size: 20px; font-weight: 700;
    color: var(--gold); text-shadow: 0 0 12px var(--gold-glow); }
  .profile-sub  { font-size: 13px; color: var(--text-dim); margin-top: 4px; font-style: italic; }

  .profile-stats {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 10px; margin-bottom: 12px;
  }
  .profile-stat {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 12px; padding: 14px;
    backdrop-filter: blur(8px);
  }
  .ps-icon  { font-size: 20px; margin-bottom: 6px; }
  .ps-value { font-family: 'Cinzel', serif; font-size: 20px; font-weight: 700; color: var(--gold); }
  .ps-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase;
    letter-spacing: 0.08em; font-family: 'Cinzel', serif; margin-top: 2px; }

  .ref-card {
    background: var(--panel); border: 1px solid rgba(240,192,64,0.3);
    border-radius: 16px; padding: 18px 20px;
    backdrop-filter: blur(10px);
    position: relative; overflow: hidden;
    margin-bottom: 12px;
  }
  .ref-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    opacity: 0.6;
  }
  .ref-title { font-family: 'Cinzel', serif; font-size: 13px; font-weight: 700;
    color: var(--gold); margin-bottom: 6px; }
  .ref-desc  { font-size: 13px; color: var(--text-dim); font-style: italic; margin-bottom: 14px; }
  .ref-reward { display: flex; align-items: center; gap: 8px; margin-bottom: 14px;
    padding: 10px 14px; background: rgba(240,192,64,0.08); border-radius: 10px;
    border: 1px solid rgba(240,192,64,0.2); }
  .ref-reward-icon { font-size: 20px; }
  .ref-reward-text { font-family: 'Cinzel', serif; font-size: 14px; font-weight: 600;
    color: var(--gold); }
  .ref-reward-sub  { font-size: 12px; color: var(--text-dim); }
  .ref-link-box {
    background: rgba(0,0,0,0.3); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 14px;
    font-size: 12px; color: var(--text-dim);
    font-family: monospace; word-break: break-all;
    margin-bottom: 10px;
  }
  .ref-link-label { font-family: 'Cinzel', serif; font-size: 10px; color: var(--text-dim);
    text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 4px; }
  .ref-share-btn {
    width: 100%; padding: 13px;
    background: linear-gradient(135deg, rgba(240,192,64,0.15), rgba(240,192,64,0.08));
    border: 1px solid rgba(240,192,64,0.35);
    border-radius: 12px;
    font-family: 'Cinzel', serif; font-size: 13px; font-weight: 700;
    color: var(--gold); letter-spacing: 0.08em;
    cursor: pointer; transition: all 0.2s;
  }
  .ref-share-btn:active { background: rgba(240,192,64,0.2); transform: scale(0.98); }

  .referral-list { margin-top: 4px; }
  .ref-person {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 14px; margin-bottom: 8px;
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 12px; backdrop-filter: blur(8px);
  }
  .ref-person-icon { font-size: 24px; }
  .ref-person-name { font-family: 'Cinzel', serif; font-size: 13px; color: var(--text); flex: 1; }
  .ref-person-ts   { font-size: 11px; color: var(--text-dim); }
  .ref-person-gold { font-family: 'Cinzel', serif; font-size: 13px; font-weight: 600;
    color: var(--gold); }

  /* â”€â”€ TOAST â”€â”€ */
  #toast {
    position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px);
    z-index: 300;
    background: rgba(20,16,10,0.95);
    border: 1px solid var(--border);
    border-radius: 12px; padding: 12px 20px;
    font-family: 'Cinzel', serif; font-size: 13px; color: var(--text);
    white-space: nowrap;
    opacity: 0; pointer-events: none;
    transition: all 0.3s;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* â”€â”€ Empty State â”€â”€ */
  .empty-state { text-align: center; padding: 50px 20px; }
  .empty-icon  { font-size: 52px; margin-bottom: 14px; opacity: 0.4; }
  .empty-text  { font-family: 'Cinzel', serif; font-size: 14px; color: var(--text-dim);
    font-weight: 600; margin-bottom: 6px; }
  .empty-sub   { font-size: 13px; color: var(--text-dim); opacity: 0.6; font-style: italic; }
</style>
</head>
<body>

<div id="stars"></div>

<div id="app">
  <header>
    <div class="logo">
      Treasure Chest
      <span>Fantasy Loot Game</span>
    </div>
    <div class="gold-display">
      <span class="gold-coin">ğŸª™</span>
      <span class="gold-amount" id="gold-display">200</span>
    </div>
  </header>

  <nav>
    <button class="nav-btn active" onclick="showScreen('chests')" id="nav-chests">
      <span class="nav-icon">ğŸ“¦</span>Chests
    </button>
    <button class="nav-btn" onclick="showScreen('inventory')" id="nav-inventory">
      <span class="nav-icon">ğŸ’</span>Bag
    </button>
    <button class="nav-btn" onclick="showScreen('profile')" id="nav-profile">
      <span class="nav-icon">ğŸ‘¤</span>Profile
    </button>
  </nav>

  <div id="screens">
    <!-- CHEST SCREEN -->
    <div class="screen active" id="screen-chests">
      <div class="section-title">Choose Your Chest</div>
      <div class="chest-grid">
        <div class="chest-card wooden" onclick="openChest('wooden')">
          <div class="chest-icon-wrap">ğŸªµ</div>
          <div class="chest-info">
            <div class="chest-name">Wooden Chest</div>
            <div class="chest-desc">A basic chest. Always worth a try!</div>
            <div class="chest-odds">
              <span class="odds-pill common">50% Cmn</span>
              <span class="odds-pill uncommon">30% Unc</span>
              <span class="odds-pill rare">15% Rare</span>
              <span class="odds-pill epic">4% Epic</span>
              <span class="odds-pill legendary">1% Leg</span>
            </div>
          </div>
          <div class="chest-cost">
            <span class="cost-amount">30</span>
            <span class="cost-label">Gold</span>
          </div>
        </div>

        <div class="chest-card silver" onclick="openChest('silver')">
          <div class="chest-icon-wrap">ğŸ¥ˆ</div>
          <div class="chest-info">
            <div class="chest-name">Silver Chest</div>
            <div class="chest-desc">Better odds for rarer loot.</div>
            <div class="chest-odds">
              <span class="odds-pill common">44% Cmn</span>
              <span class="odds-pill uncommon">27% Unc</span>
              <span class="odds-pill rare">19% Rare</span>
              <span class="odds-pill epic">6% Epic</span>
              <span class="odds-pill legendary">4% Leg</span>
            </div>
          </div>
          <div class="chest-cost">
            <span class="cost-amount">100</span>
            <span class="cost-label">Gold</span>
          </div>
        </div>

        <div class="chest-card golden" onclick="openChest('golden')">
          <div class="chest-icon-wrap">ğŸ†</div>
          <div class="chest-info">
            <div class="chest-name">Golden Chest</div>
            <div class="chest-desc">High chance of Epic & Legendary!</div>
            <div class="chest-odds">
              <span class="odds-pill common">30% Cmn</span>
              <span class="odds-pill uncommon">20% Unc</span>
              <span class="odds-pill rare">28% Rare</span>
              <span class="odds-pill epic">10% Epic</span>
              <span class="odds-pill legendary">12% Leg</span>
            </div>
          </div>
          <div class="chest-cost">
            <span class="cost-amount">300</span>
            <span class="cost-label">Gold</span>
          </div>
        </div>
      </div>
    </div>

    <!-- INVENTORY SCREEN -->
    <div class="screen" id="screen-inventory">
      <div class="inv-stats">
        <div class="stat-card">
          <div class="stat-label">Items</div>
          <div class="stat-value" id="inv-count">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Value</div>
          <div class="stat-value" id="inv-value">0ğŸª™</div>
        </div>
      </div>
      <button class="sell-all-btn" onclick="sellAll()">ğŸ—‘ï¸ Sell Everything</button>
      <div class="section-title">Your Items</div>
      <div id="inv-list"></div>
    </div>

    <!-- PROFILE SCREEN -->
    <div class="screen" id="screen-profile">
      <div class="profile-hero">
        <div class="profile-avatar">âš”ï¸</div>
        <div class="profile-name" id="profile-name">Adventurer</div>
        <div class="profile-sub">Treasure Hunter</div>
      </div>

      <div class="profile-stats">
        <div class="profile-stat">
          <div class="ps-icon">ğŸ“¦</div>
          <div class="ps-value" id="stat-chests">0</div>
          <div class="ps-label">Chests Opened</div>
        </div>
        <div class="profile-stat">
          <div class="ps-icon">ğŸ’¸</div>
          <div class="ps-value" id="stat-earned">0ğŸª™</div>
          <div class="ps-label">Total Sold</div>
        </div>
        <div class="profile-stat">
          <div class="ps-icon">ğŸ‘¥</div>
          <div class="ps-value" id="stat-refs">0</div>
          <div class="ps-label">Referrals</div>
        </div>
        <div class="profile-stat">
          <div class="ps-icon">ğŸ’</div>
          <div class="ps-value" id="stat-networth">0ğŸª™</div>
          <div class="ps-label">Net Worth</div>
        </div>
      </div>

      <div class="ref-card">
        <div class="ref-title">ğŸ‘¥ Referral Program</div>
        <div class="ref-desc">Invite friends and earn gold for each adventurer who joins!</div>
        <div class="ref-reward">
          <div class="ref-reward-icon">ğŸª™</div>
          <div>
            <div class="ref-reward-text">+500 Gold per referral</div>
            <div class="ref-reward-sub">Paid instantly when they join</div>
          </div>
        </div>
        <div class="ref-link-label">Your Link</div>
        <div class="ref-link-box" id="ref-link-display">Loading...</div>
        <button class="ref-share-btn" onclick="shareReferral()">ğŸ”— Share Referral Link</button>
      </div>

      <div class="section-title">Your Referrals</div>
      <div id="ref-list"></div>
    </div>
  </div>
</div>

<!-- Opening Overlay -->
<div id="open-overlay">
  <div class="opening-chest" id="opening-chest-icon">ğŸ“¦</div>
  <div class="opening-text">Opening Chest...</div>
</div>

<!-- Reward Overlay -->
<div id="reward-overlay">
  <div class="reward-particles" id="reward-particles"></div>
  <div class="reward-badge" id="reward-badge">Common</div>
  <div class="reward-item-icon" id="reward-icon">ğŸ§ª</div>
  <div class="reward-item-name" id="reward-name">Health Potion</div>
  <div class="reward-value">Worth <span id="reward-value">10</span>ğŸª™</div>
  <div class="reward-actions">
    <button class="btn-primary" onclick="keepItem()">Keep It</button>
    <button class="btn-secondary" onclick="sellItem()">Sell Now</button>
  </div>
</div>

<!-- Sell Modal -->
<div id="sell-modal" onclick="closeSellModal(event)">
  <div class="sell-sheet">
    <div class="sell-handle"></div>
    <div class="sell-item-display">
      <div class="sell-item-icon" id="modal-icon">ğŸ§ª</div>
      <div class="sell-item-details">
        <div class="sell-item-name" id="modal-name">Item</div>
        <div class="sell-item-sub" id="modal-rarity">Common Â· 10ğŸª™ each</div>
      </div>
    </div>
    <div class="sell-options" id="sell-options"></div>
    <button class="sell-cancel" onclick="closeSellModal()">Cancel</button>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ITEMS = {
  health_potion:   {name:"Health Potion",    emoji:"ğŸ§ª", rarity:"Common",    value:10},
  wooden_sword:    {name:"Wooden Sword",     emoji:"ğŸ—¡ï¸",  rarity:"Common",    value:15},
  leather_boots:   {name:"Leather Boots",    emoji:"ğŸ‘¢", rarity:"Common",    value:12},
  bread_loaf:      {name:"Bread Loaf",       emoji:"ğŸ", rarity:"Common",    value:5},
  iron_shield:     {name:"Iron Shield",      emoji:"ğŸ›¡ï¸",  rarity:"Common",    value:20},
  mana_potion:     {name:"Mana Potion",      emoji:"ğŸ’™", rarity:"Uncommon",  value:35},
  silver_dagger:   {name:"Silver Dagger",    emoji:"ğŸ”ª", rarity:"Uncommon",  value:50},
  chain_armor:     {name:"Chain Armor",      emoji:"â›“ï¸",  rarity:"Uncommon",  value:60},
  magic_scroll:    {name:"Magic Scroll",     emoji:"ğŸ“œ", rarity:"Uncommon",  value:45},
  enchanted_ring:  {name:"Enchanted Ring",   emoji:"ğŸ’", rarity:"Uncommon",  value:55},
  elven_bow:       {name:"Elven Bow",        emoji:"ğŸ¹", rarity:"Rare",      value:150},
  fire_staff:      {name:"Fire Staff",       emoji:"ğŸ”¥", rarity:"Rare",      value:180},
  dragon_scale:    {name:"Dragon Scale",     emoji:"ğŸ‰", rarity:"Rare",      value:200},
  crystal_amulet:  {name:"Crystal Amulet",   emoji:"ğŸ”®", rarity:"Rare",      value:160},
  thunder_axe:     {name:"Thunder Axe",      emoji:"âš¡", rarity:"Epic",      value:500},
  void_cloak:      {name:"Void Cloak",       emoji:"ğŸŒ‘", rarity:"Epic",      value:550},
  phoenix_feather: {name:"Phoenix Feather",  emoji:"ğŸ¦…", rarity:"Epic",      value:480},
  excalibur:       {name:"Excalibur",        emoji:"âš”ï¸",  rarity:"Legendary", value:2000},
  crown_of_gods:   {name:"Crown of Gods",    emoji:"ğŸ‘‘", rarity:"Legendary", value:2500},
  chaos_orb:       {name:"Chaos Orb",        emoji:"ğŸŒ€", rarity:"Legendary", value:1800},
};

const RARITY_ORDER = ["Common","Uncommon","Rare","Epic","Legendary"];

const CHEST_CONFIGS = {
  wooden: { weights:[50,30,15,4,1], icon:"ğŸ“¦" },
  silver: { weights:[44,27,19,6,4], icon:"ğŸ¥ˆ" },
  golden: { weights:[30,20,28,10,12], icon:"ğŸ†" },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE (localStorage for persistence)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function loadState() {
  try {
    const s = localStorage.getItem('tcg_state');
    if (s) return JSON.parse(s);
  } catch(e) {}
  return {
    gold: 200, inventory: {}, chestsOpened: 0,
    totalEarned: 0, referrals: [], username: "Adventurer"
  };
}
function saveState() { localStorage.setItem('tcg_state', JSON.stringify(state)); }

let state = loadState();
let pendingItem = null;   // item key currently in reward overlay
let modalItem   = null;   // item key in sell modal

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TELEGRAM WEB APP INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const tg = window.Telegram?.WebApp;
if (tg) {
  tg.ready();
  tg.expand();
  if (tg.initDataUnsafe?.user) {
    const u = tg.initDataUnsafe.user;
    state.username = u.first_name || u.username || "Adventurer";
    state.userId   = u.id;
  }
}

const BOT_USERNAME = "plovinhogame_bot";
function getRefLink() {
  const uid = state.userId || "demo";
  return `https://t.me/${BOT_USERNAME}?start=ref_${uid}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROLL LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function rollItem(chestKey) {
  const cfg = CHEST_CONFIGS[chestKey];
  const total = cfg.weights.reduce((a,b)=>a+b,0);
  let r = Math.random() * total;
  let rarityIdx = 0;
  for (let i = 0; i < cfg.weights.length; i++) {
    r -= cfg.weights[i];
    if (r <= 0) { rarityIdx = i; break; }
  }
  const rarity = RARITY_ORDER[rarityIdx];
  const pool   = Object.entries(ITEMS).filter(([,v]) => v.rarity === rarity);
  return pool[Math.floor(Math.random() * pool.length)][0];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI UPDATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateGoldDisplay() {
  const el = document.getElementById('gold-display');
  el.style.transform = 'scale(1.2)';
  el.style.color = '#fff';
  el.textContent = state.gold;
  setTimeout(() => { el.style.transform = ''; el.style.color = ''; }, 300);
}

function updateInventoryScreen() {
  const items = Object.entries(state.inventory).filter(([,v])=>v>0);
  const count = items.reduce((a,[,v])=>a+v,0);
  const value = items.reduce((a,[k,v])=>a+ITEMS[k].value*v,0);

  document.getElementById('inv-count').textContent = count;
  document.getElementById('inv-value').textContent = value+'ğŸª™';

  const sorted = [...items].sort((a,b)=>
    RARITY_ORDER.indexOf(ITEMS[b[0]].rarity) - RARITY_ORDER.indexOf(ITEMS[a[0]].rarity)
  );

  const list = document.getElementById('inv-list');
  if (sorted.length === 0) {
    list.innerHTML = `<div class="empty-state">
      <div class="empty-icon">ğŸ’</div>
      <div class="empty-text">Inventory Empty</div>
      <div class="empty-sub">Open some chests to find loot!</div>
    </div>`;
    return;
  }

  list.innerHTML = sorted.map(([key,cnt]) => {
    const item = ITEMS[key];
    return `<div class="inv-item rarity-${item.rarity}" onclick="openSellModal('${key}')">
      <div class="item-emoji">${item.emoji}</div>
      <div class="item-info">
        <div class="item-name">${item.name}</div>
        <div class="item-rarity ${item.rarity}">â¬¥ ${item.rarity}</div>
      </div>
      <div class="item-right">
        <div class="item-count">Ã—${cnt}</div>
        <div class="item-value">${item.value*cnt}ğŸª™</div>
      </div>
    </div>`;
  }).join('');
}

function updateProfileScreen() {
  document.getElementById('profile-name').textContent = state.username;
  document.getElementById('stat-chests').textContent  = state.chestsOpened;
  document.getElementById('stat-earned').textContent  = state.totalEarned+'ğŸª™';
  document.getElementById('stat-refs').textContent    = state.referrals.length;

  const invVal = Object.entries(state.inventory)
    .reduce((a,[k,v])=>a+ITEMS[k].value*v, 0);
  document.getElementById('stat-networth').textContent = (state.gold+invVal)+'ğŸª™';

  document.getElementById('ref-link-display').textContent = getRefLink();

  const refList = document.getElementById('ref-list');
  if (state.referrals.length === 0) {
    refList.innerHTML = `<div class="empty-state">
      <div class="empty-icon">ğŸ‘¥</div>
      <div class="empty-text">No Referrals Yet</div>
      <div class="empty-sub">Share your link to earn 500ğŸª™ per friend!</div>
    </div>`;
  } else {
    refList.innerHTML = state.referrals.map(r => `
      <div class="ref-person">
        <div class="ref-person-icon">ğŸ‘¤</div>
        <div class="ref-person-name">${r.name}</div>
        <div class="ref-person-ts">${r.ts}</div>
        <div class="ref-person-gold">+500ğŸª™</div>
      </div>`).join('');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
  if (name==='inventory') updateInventoryScreen();
  if (name==='profile')   updateProfileScreen();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHEST OPENING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openChest(chestKey) {
  const costs = {wooden:30, silver:100, golden:300};
  const cost  = costs[chestKey];
  if (state.gold < cost) { showToast('âŒ Not enough gold!'); return; }

  // Lock chests
  document.querySelectorAll('.chest-card').forEach(c=>c.classList.add('locked'));

  // Show opening animation
  const overlay = document.getElementById('open-overlay');
  const icons   = {wooden:'ğŸ“¦', silver:'ğŸ¥ˆ', golden:'ğŸ†'};
  document.getElementById('opening-chest-icon').textContent = icons[chestKey];
  overlay.classList.add('visible');

  // After 1.4s reveal reward
  setTimeout(() => {
    overlay.classList.remove('visible');
    state.gold -= cost;
    state.chestsOpened++;
    const itemKey = rollItem(chestKey);
    state.inventory[itemKey] = (state.inventory[itemKey]||0) + 1;
    pendingItem = itemKey;
    saveState();
    updateGoldDisplay();
    showReward(itemKey);
  }, 1400);
}

function showReward(itemKey) {
  const item = ITEMS[itemKey];
  document.getElementById('reward-badge').textContent  = item.rarity;
  document.getElementById('reward-badge').className    = 'reward-badge ' + item.rarity;
  document.getElementById('reward-icon').textContent   = item.emoji;
  document.getElementById('reward-name').textContent   = item.name;
  document.getElementById('reward-name').className     = 'reward-item-name ' + item.rarity;
  document.getElementById('reward-value').textContent  = item.value;

  // Spawn particles
  const pc = document.getElementById('reward-particles');
  pc.innerHTML = '';
  const colors = {
    Common:'#aaa', Uncommon:'#2ecc71', Rare:'#5dade2',
    Epic:'#bb8fce', Legendary:'#f0c040'
  };
  const col = colors[item.rarity];
  const count = item.rarity==='Legendary' ? 40 : item.rarity==='Epic' ? 25 : 12;
  for (let i=0; i<count; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const size = Math.random()*6+4;
    const tx = (Math.random()-0.5)*300;
    const ty = (Math.random()-0.5)*400;
    p.style.cssText = `
      width:${size}px; height:${size}px;
      background:${col}; opacity:0.8;
      left:50%; top:50%;
      --tx:${tx}px; --ty:${ty}px;
      animation-delay:${Math.random()*0.3}s;
      animation-duration:${Math.random()*0.8+0.8}s;
    `;
    pc.appendChild(p);
  }

  document.getElementById('reward-overlay').classList.add('visible');
  document.querySelectorAll('.chest-card').forEach(c=>c.classList.remove('locked'));

  if (tg?.HapticFeedback) {
    const types = {Common:'light', Uncommon:'medium', Rare:'medium',
                   Epic:'heavy', Legendary:'heavy'};
    tg.HapticFeedback.impactOccurred(types[item.rarity]||'light');
    if (item.rarity==='Legendary') {
      setTimeout(()=>tg.HapticFeedback.notificationOccurred('success'), 300);
    }
  }
}

function keepItem() {
  document.getElementById('reward-overlay').classList.remove('visible');
  pendingItem = null;
  showToast('ğŸ’ Added to inventory!');
}

function sellItem() {
  if (!pendingItem) return;
  const item = ITEMS[pendingItem];
  state.inventory[pendingItem]--;
  if (state.inventory[pendingItem] <= 0) delete state.inventory[pendingItem];
  state.gold += item.value;
  state.totalEarned += item.value;
  pendingItem = null;
  saveState();
  updateGoldDisplay();
  document.getElementById('reward-overlay').classList.remove('visible');
  showToast(`ğŸ’° Sold for ${item.value}ğŸª™!`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SELL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openSellModal(itemKey) {
  modalItem = itemKey;
  const item  = ITEMS[itemKey];
  const count = state.inventory[itemKey] || 0;

  document.getElementById('modal-icon').textContent   = item.emoji;
  document.getElementById('modal-name').textContent   = item.name;
  document.getElementById('modal-rarity').textContent = `${item.rarity} Â· ${item.value}ğŸª™ each`;

  const opts = document.getElementById('sell-options');
  let html = '';
  const addOpt = (label, qty, gold, extra='') =>
    html += `<div class="sell-option ${extra}" onclick="executeSell(${qty})">
      <div class="sell-opt-count">${label}</div>
      <div class="sell-opt-gold">${gold}ğŸª™</div>
    </div>`;

  addOpt('Sell Ã—1', 1, item.value);
  if (count>=5)  addOpt('Sell Ã—5', 5, item.value*5);
  if (count>=10) addOpt('Sell Ã—10', 10, item.value*10);
  if (count>1)   addOpt(`Sell All (Ã—${count})`, count, item.value*count, 'sell-all-opt');
  opts.innerHTML = html;

  document.getElementById('sell-modal').classList.add('visible');
}

function closeSellModal(e) {
  if (e && e.target !== document.getElementById('sell-modal')) return;
  document.getElementById('sell-modal').classList.remove('visible');
  modalItem = null;
}

function executeSell(qty) {
  if (!modalItem) return;
  const item    = ITEMS[modalItem];
  const owned   = state.inventory[modalItem] || 0;
  const actual  = Math.min(qty, owned);
  const earned  = item.value * actual;

  state.inventory[modalItem] = owned - actual;
  if (state.inventory[modalItem] <= 0) delete state.inventory[modalItem];
  state.gold        += earned;
  state.totalEarned += earned;
  saveState();
  updateGoldDisplay();
  updateInventoryScreen();
  document.getElementById('sell-modal').classList.remove('visible');
  modalItem = null;
  showToast(`ğŸ’° Sold Ã—${actual} for ${earned}ğŸª™!`);
}

function sellAll() {
  const items = Object.entries(state.inventory).filter(([,v])=>v>0);
  if (items.length===0) { showToast('ğŸ’ Inventory is empty!'); return; }
  const total = items.reduce((a,[k,v])=>a+ITEMS[k].value*v,0);
  state.inventory   = {};
  state.gold       += total;
  state.totalEarned+= total;
  saveState();
  updateGoldDisplay();
  updateInventoryScreen();
  showToast(`ğŸ’° Sold everything for ${total}ğŸª™!`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REFERRAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function shareReferral() {
  const link = getRefLink();
  const text = `âš”ï¸ Join me on Treasure Chest!\nOpen chests, collect legendary loot.\nYou'll get a bonus when you start! ${link}`;
  if (tg?.openTelegramLink) {
    tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent('âš”ï¸ Join me on Treasure Chest! Open chests, collect legendary loot!')}`);
  } else if (navigator.share) {
    navigator.share({title:'Treasure Chest', text, url:link});
  } else {
    navigator.clipboard?.writeText(link);
    showToast('ğŸ”— Link copied!');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove('show'), 2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

updateGoldDisplay();
</script>
</body>
</html>
