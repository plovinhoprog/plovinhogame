<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Treasure Chest</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600;700&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
  --gold:#f0c040; --gold-dim:#a07820; --gold-glow:rgba(240,192,64,0.4);
  --bg:#08070a; --bg2:#0f0e14; --panel:rgba(22,18,30,0.95);
  --border:rgba(240,192,64,0.15); --text:#e8d8b0; --text-dim:#7a6e55;
  --c-common:#9a9a9a; --c-uncommon:#2ecc71; --c-rare:#5dade2;
  --c-epic:#c39bd3; --c-legendary:#f0c040;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;width:100%;background:var(--bg);color:var(--text);
  font-family:'EB Garamond',serif;overflow:hidden;user-select:none}

/* BG */
#bg-canvas{position:fixed;inset:0;z-index:0;pointer-events:none}

#app{position:relative;z-index:1;height:100vh;display:flex;flex-direction:column;overflow:hidden}

/* HEADER */
header{flex-shrink:0;padding:12px 16px 8px;
  background:linear-gradient(180deg,rgba(8,7,10,.98) 0%,transparent 100%);
  display:flex;align-items:center;justify-content:space-between}
.logo{font-family:'Cinzel Decorative',serif;font-size:14px;font-weight:700;
  color:var(--gold);text-shadow:0 0 20px var(--gold-glow);line-height:1.2}
.logo-sub{font-size:9px;color:var(--text-dim);font-family:'EB Garamond',serif;
  text-transform:uppercase;letter-spacing:.15em}
.gold-pill{display:flex;align-items:center;gap:6px;
  background:rgba(240,192,64,.08);border:1px solid rgba(240,192,64,.22);
  border-radius:20px;padding:5px 12px}
.gold-coin{font-size:15px;animation:coinspin 3s linear infinite}
@keyframes coinspin{0%,44%{transform:rotateY(0)}50%{transform:rotateY(90deg)}56%,100%{transform:rotateY(0)}}
#gold-display{font-family:'Cinzel',serif;font-size:14px;font-weight:600;
  color:var(--gold);text-shadow:0 0 10px var(--gold-glow);min-width:40px;
  text-align:right;transition:all .35s}

/* NAV */
nav{flex-shrink:0;display:flex;gap:3px;padding:0 12px 8px}
.nav-btn{flex:1;padding:7px 4px;background:transparent;border:1px solid transparent;
  border-radius:10px;color:var(--text-dim);font-family:'Cinzel',serif;font-size:9px;
  font-weight:600;letter-spacing:.05em;text-transform:uppercase;cursor:pointer;
  transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:2px}
.nav-btn .ni{font-size:17px}
.nav-btn.active{background:rgba(240,192,64,.09);border-color:rgba(240,192,64,.3);
  color:var(--gold);text-shadow:0 0 8px var(--gold-glow)}
.nav-btn:active{transform:scale(.95)}

/* SCREENS */
#screens{flex:1;overflow:hidden;position:relative}
.screen{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;
  padding:4px 12px 24px;opacity:0;transform:translateY(14px);
  pointer-events:none;transition:opacity .28s,transform .28s}
.screen.active{opacity:1;transform:translateY(0);pointer-events:all}
.screen::-webkit-scrollbar{width:2px}
.screen::-webkit-scrollbar-thumb{background:var(--gold-dim);border-radius:2px}

.sec-title{font-family:'Cinzel',serif;font-size:10px;font-weight:600;
  letter-spacing:.2em;text-transform:uppercase;color:var(--text-dim);
  margin:14px 0 9px;display:flex;align-items:center;gap:8px}
.sec-title::after{content:'';flex:1;height:1px;
  background:linear-gradient(90deg,var(--border),transparent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHEST CARDS â€” main list
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chests-grid{display:flex;flex-direction:column;gap:10px;padding-top:2px}
.chest-card{position:relative;overflow:hidden;border-radius:16px;
  background:var(--panel);cursor:pointer;transition:transform .2s,box-shadow .2s;
  display:flex;align-items:center;gap:0;border:1px solid transparent}
.chest-card:active{transform:scale(.97)}

/* per-tier colors */
.chest-card.t1{border-color:rgba(139,90,43,.45);
  background:linear-gradient(135deg,rgba(22,14,8,.97),rgba(28,18,10,.97))}
.chest-card.t2{border-color:rgba(192,192,192,.3);
  background:linear-gradient(135deg,rgba(16,16,22,.97),rgba(22,22,30,.97))}
.chest-card.t3{border-color:rgba(240,192,64,.35);
  background:linear-gradient(135deg,rgba(20,16,8,.97),rgba(28,22,8,.97));
  box-shadow:0 0 18px rgba(240,192,64,.07)}
.chest-card.t4{border-color:rgba(142,68,173,.45);
  background:linear-gradient(135deg,rgba(16,10,22,.97),rgba(22,12,30,.97));
  box-shadow:0 0 18px rgba(142,68,173,.07)}
.chest-card.t5{border-color:rgba(231,76,60,.5);
  background:linear-gradient(135deg,rgba(20,8,8,.97),rgba(30,10,10,.97));
  box-shadow:0 0 22px rgba(231,76,60,.1)}
.chest-card.t6{border-color:rgba(255,215,0,.6);
  background:linear-gradient(135deg,rgba(20,16,0,.97),rgba(30,24,4,.97));
  box-shadow:0 0 28px rgba(255,215,0,.12)}

.chest-art{width:90px;height:90px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:52px;
  filter:drop-shadow(0 0 10px rgba(240,192,64,.3));
  animation:float 3s ease-in-out infinite}
.chest-card.t2 .chest-art{filter:drop-shadow(0 2px 8px rgba(180,180,200,.3));animation-delay:.5s}
.chest-card.t3 .chest-art{filter:drop-shadow(0 0 16px rgba(240,192,64,.5));animation-delay:1s}
.chest-card.t4 .chest-art{filter:drop-shadow(0 0 16px rgba(142,68,173,.5));animation-delay:1.5s}
.chest-card.t5 .chest-art{filter:drop-shadow(0 0 18px rgba(231,76,60,.5));animation-delay:2s}
.chest-card.t6 .chest-art{filter:drop-shadow(0 0 24px rgba(255,215,0,.7));animation-delay:2.5s}
@keyframes float{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-6px) rotate(2deg)}}

.chest-info{flex:1;padding:14px 14px 14px 4px}
.chest-name{font-family:'Cinzel',serif;font-size:14px;font-weight:700;color:var(--text);margin-bottom:3px}
.chest-tier-badge{display:inline-block;font-family:'Cinzel',serif;font-size:9px;font-weight:600;
  padding:2px 8px;border-radius:8px;margin-bottom:6px;letter-spacing:.05em}
.chest-desc{font-size:12px;color:var(--text-dim);font-style:italic;margin-bottom:8px;line-height:1.4}
.chest-cost-row{display:flex;align-items:center;gap:6px}
.chest-cost-num{font-family:'Cinzel',serif;font-size:16px;font-weight:700;color:var(--gold);
  text-shadow:0 0 10px var(--gold-glow)}
.chest-cost-lbl{font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.05em}

.chest-card.locked{opacity:.4;pointer-events:none}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHEST DETAIL SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#chest-detail{position:absolute;inset:0;z-index:50;
  background:var(--bg);overflow-y:auto;overflow-x:hidden;
  padding:0 0 30px;
  opacity:0;transform:translateX(100%);pointer-events:none;
  transition:opacity .3s,transform .3s}
#chest-detail.open{opacity:1;transform:translateX(0);pointer-events:all}

.detail-header{display:flex;align-items:center;gap:10px;
  padding:14px 14px 0;margin-bottom:4px}
.back-btn{width:36px;height:36px;background:rgba(240,192,64,.08);
  border:1px solid rgba(240,192,64,.2);border-radius:10px;
  color:var(--gold);font-size:18px;cursor:pointer;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;transition:all .2s}
.back-btn:active{transform:scale(.92)}
.detail-title{font-family:'Cinzel',serif;font-size:16px;font-weight:700;color:var(--text)}

.detail-chest-hero{text-align:center;padding:10px 0 6px}
.detail-chest-img{font-size:80px;filter:drop-shadow(0 0 20px rgba(240,192,64,.4));
  animation:float 2.5s ease-in-out infinite;display:inline-block}
.detail-chest-name{font-family:'Cinzel Decorative',serif;font-size:17px;font-weight:700;
  color:var(--gold);text-shadow:0 0 16px var(--gold-glow);margin-top:6px}
.detail-chest-desc{font-size:13px;color:var(--text-dim);font-style:italic;
  margin:4px 14px 0;text-align:center;line-height:1.5}

.open-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:14px 14px 0}
.open-btn{padding:14px 10px;border-radius:14px;font-family:'Cinzel',serif;font-size:13px;
  font-weight:700;cursor:pointer;transition:all .25s;text-align:center;border:none}
.open-btn-slow{background:rgba(240,192,64,.1);border:1px solid rgba(240,192,64,.35);
  color:var(--gold)}
.open-btn-slow:active{background:rgba(240,192,64,.2)}
.open-btn-fast{background:linear-gradient(135deg,#8a6010,#f0c040,#8a6010);
  background-size:200%;background-position:100%;
  color:#1a1000;box-shadow:0 4px 18px rgba(240,192,64,.3)}
.open-btn-fast:active{background-position:0%}
.open-btn .btn-icon{font-size:20px;display:block;margin-bottom:3px}
.open-btn .btn-cost{font-size:11px;opacity:.75;margin-top:2px}

/* drop table */
.drop-table{padding:0 14px}
.drop-row{display:flex;align-items:center;gap:10px;
  padding:9px 12px;border-radius:12px;margin-bottom:6px;
  background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);
  transition:background .2s}
.drop-row:last-child{margin-bottom:0}
.drop-emoji{font-size:24px;flex-shrink:0;width:32px;text-align:center}
.drop-info{flex:1;min-width:0}
.drop-name{font-family:'Cinzel',serif;font-size:12px;font-weight:600}
.drop-name.Common   {color:var(--c-common)}
.drop-name.Uncommon {color:var(--c-uncommon)}
.drop-name.Rare     {color:var(--c-rare)}
.drop-name.Epic     {color:var(--c-epic)}
.drop-name.Legendary{color:var(--c-legendary)}
.drop-val{font-size:11px;color:var(--text-dim);margin-top:1px}
.drop-chance{font-family:'Cinzel',serif;font-size:12px;font-weight:700;flex-shrink:0}
.drop-chance.Common   {color:var(--c-common)}
.drop-chance.Uncommon {color:var(--c-uncommon)}
.drop-chance.Rare     {color:var(--c-rare)}
.drop-chance.Epic     {color:var(--c-epic)}
.drop-chance.Legendary{color:var(--c-legendary)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPIN ANIMATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#spin-screen{position:fixed;inset:0;z-index:100;
  background:rgba(0,0,0,.97);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .3s}
#spin-screen.visible{opacity:1;pointer-events:all}

.spin-chest-anim{font-size:70px;margin-bottom:16px;
  filter:drop-shadow(0 0 20px rgba(240,192,64,.5));
  animation:chest-shake .35s ease-in-out infinite}
@keyframes chest-shake{0%,100%{transform:rotate(-4deg) scale(1)}50%{transform:rotate(4deg) scale(1.06)}}
.spin-chest-anim.fast-mode{animation-duration:.15s}

.spin-status{font-family:'Cinzel',serif;font-size:11px;letter-spacing:.3em;
  text-transform:uppercase;color:var(--text-dim);margin-bottom:20px;
  animation:pulse-txt .7s ease-in-out infinite alternate}
@keyframes pulse-txt{from{opacity:.3}to{opacity:1}}

/* reel */
.reel-wrap{position:relative;width:calc(100vw - 0px);max-width:480px;height:120px;overflow:hidden}
.reel-wrap::before,.reel-wrap::after{content:'';position:absolute;top:0;bottom:0;width:70px;z-index:5;pointer-events:none}
.reel-wrap::before{left:0;background:linear-gradient(90deg,rgba(0,0,0,.97),transparent)}
.reel-wrap::after{right:0;background:linear-gradient(-90deg,rgba(0,0,0,.97),transparent)}
.reel-line{position:absolute;top:0;bottom:0;left:50%;transform:translateX(-50%);
  width:2px;background:var(--gold);z-index:6;
  box-shadow:0 0 10px var(--gold-glow),0 0 24px var(--gold-glow)}
.reel-line::before{content:'â–¼';position:absolute;top:-16px;left:50%;transform:translateX(-50%);
  color:var(--gold);font-size:12px}
.reel-line::after{content:'â–²';position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);
  color:var(--gold);font-size:12px}
.reel-track{display:flex;align-items:center;height:120px;gap:5px;padding:0 5px;will-change:transform}
.reel-item{flex-shrink:0;width:100px;height:108px;border-radius:10px;
  border:1.5px solid rgba(255,255,255,.07);
  background:rgba(16,12,8,.95);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px}
.reel-item::after{content:'';display:block;width:80%;height:2px;border-radius:2px;margin-top:2px}
.reel-item.Common::after   {background:var(--c-common)}
.reel-item.Uncommon::after {background:var(--c-uncommon)}
.reel-item.Rare::after     {background:var(--c-rare);box-shadow:0 0 6px var(--c-rare)}
.reel-item.Epic::after     {background:var(--c-epic);box-shadow:0 0 8px var(--c-epic)}
.reel-item.Legendary::after{background:var(--c-legendary);box-shadow:0 0 12px var(--c-legendary)}
.ri-emoji{font-size:34px;line-height:1}
.ri-name{font-family:'Cinzel',serif;font-size:7.5px;font-weight:600;
  text-align:center;padding:0 3px;color:var(--text-dim)}
.ri-rarity{font-size:7px;font-family:'Cinzel',serif;font-weight:700}
.ri-rarity.Common   {color:var(--c-common)}
.ri-rarity.Uncommon {color:var(--c-uncommon)}
.ri-rarity.Rare     {color:var(--c-rare)}
.ri-rarity.Epic     {color:var(--c-epic)}
.ri-rarity.Legendary{color:var(--c-legendary)}

.reel-item.is-winner{border-color:var(--gold);
  box-shadow:0 0 20px rgba(240,192,64,.4);transform:scale(1.05)}
.reel-item.Legendary.is-winner{animation:leg-winner .5s ease-in-out infinite alternate}
@keyframes leg-winner{from{box-shadow:0 0 20px rgba(240,192,64,.4)}to{box-shadow:0 0 50px rgba(240,192,64,.9)}}

/* result */
#spin-result{margin-top:22px;text-align:center;opacity:0;transform:translateY(16px);
  transition:opacity .4s,transform .4s}
#spin-result.show{opacity:1;transform:translateY(0)}
.res-badge{display:inline-block;font-family:'Cinzel',serif;font-size:10px;font-weight:700;
  padding:3px 14px;border-radius:16px;letter-spacing:.15em;text-transform:uppercase;margin-bottom:8px}
.res-badge.Common   {background:rgba(155,155,155,.15);color:var(--c-common);border:1px solid rgba(155,155,155,.3)}
.res-badge.Uncommon {background:rgba(46,204,113,.12);color:var(--c-uncommon);border:1px solid rgba(46,204,113,.3)}
.res-badge.Rare     {background:rgba(93,173,226,.12);color:var(--c-rare);border:1px solid rgba(93,173,226,.35)}
.res-badge.Epic     {background:rgba(195,155,211,.12);color:var(--c-epic);border:1px solid rgba(195,155,211,.4);box-shadow:0 0 16px rgba(195,155,211,.2)}
.res-badge.Legendary{background:rgba(240,192,64,.12);color:var(--c-legendary);border:1px solid rgba(240,192,64,.5);box-shadow:0 0 24px rgba(240,192,64,.35)}
.res-name{font-family:'Cinzel',serif;font-size:20px;font-weight:700;color:var(--text);margin-bottom:3px}
.res-name.Legendary{color:var(--c-legendary);text-shadow:0 0 20px var(--gold-glow)}
.res-name.Epic{color:var(--c-epic)}
.res-val{font-size:13px;color:var(--text-dim);font-style:italic;margin-bottom:14px}
.res-val span{color:var(--gold);font-style:normal;font-family:'Cinzel',serif}
.res-actions{display:flex;gap:10px;justify-content:center}
.btn-keep{padding:11px 22px;background:linear-gradient(135deg,#8a6010,#f0c040,#8a6010);
  background-size:200%;background-position:100%;
  border:none;border-radius:12px;font-family:'Cinzel',serif;font-size:13px;
  font-weight:700;color:#1a1000;cursor:pointer;transition:all .3s;
  box-shadow:0 4px 18px rgba(240,192,64,.3)}
.btn-keep:active{background-position:0%}
.btn-sell-now{padding:11px 18px;background:rgba(255,255,255,.05);
  border:1px solid var(--border);border-radius:12px;font-family:'Cinzel',serif;
  font-size:13px;font-weight:600;color:var(--text-dim);cursor:pointer;transition:all .2s}
.btn-sell-now:active{transform:scale(.96)}

/* particles */
.particles{position:fixed;inset:0;pointer-events:none;z-index:200;overflow:hidden}
.pt{position:absolute;border-radius:50%;animation:ptfly 2s ease-out forwards;opacity:0}
@keyframes ptfly{0%{transform:translate(0,0) scale(0);opacity:1}100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVENTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.inv-top{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:6px}
.stat-box{background:var(--panel);border:1px solid var(--border);
  border-radius:12px;padding:10px 12px}
.stat-box-lbl{font-size:9px;color:var(--text-dim);text-transform:uppercase;
  letter-spacing:.1em;font-family:'Cinzel',serif;margin-bottom:3px}
.stat-box-val{font-family:'Cinzel',serif;font-size:17px;font-weight:700;color:var(--gold)}
.sell-all-btn{width:100%;padding:11px;background:rgba(192,57,43,.1);
  border:1px solid rgba(192,57,43,.25);border-radius:12px;font-family:'Cinzel',serif;
  font-size:11px;font-weight:600;color:#e74c3c;letter-spacing:.08em;text-transform:uppercase;
  cursor:pointer;transition:all .2s;margin-bottom:4px}
.sell-all-btn:active{background:rgba(192,57,43,.2);transform:scale(.98)}
.inv-item{display:flex;align-items:center;gap:10px;background:var(--panel);
  border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin-bottom:7px;
  cursor:pointer;transition:all .18s}
.inv-item:active{transform:scale(.98);background:rgba(240,192,64,.05)}
.inv-item.rarity-Legendary{border-color:rgba(240,192,64,.4);box-shadow:0 0 10px rgba(240,192,64,.07)}
.inv-item.rarity-Epic{border-color:rgba(195,155,211,.35)}
.inv-item.rarity-Rare{border-color:rgba(93,173,226,.3)}
.ii-emoji{font-size:26px;flex-shrink:0}
.ii-info{flex:1;min-width:0}
.ii-name{font-family:'Cinzel',serif;font-size:12px;font-weight:600;color:var(--text)}
.ii-rarity{font-size:10px;margin-top:1px}
.ii-rarity.Common{color:var(--c-common)}.ii-rarity.Uncommon{color:var(--c-uncommon)}
.ii-rarity.Rare{color:var(--c-rare)}.ii-rarity.Epic{color:var(--c-epic)}.ii-rarity.Legendary{color:var(--c-legendary)}
.ii-right{text-align:right;flex-shrink:0}
.ii-count{font-family:'Cinzel',serif;font-size:11px;color:var(--text-dim)}
.ii-val{font-family:'Cinzel',serif;font-size:13px;font-weight:600;color:var(--gold);margin-top:1px}

/* SELL MODAL */
#sell-modal{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.82);
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .28s}
#sell-modal.visible{opacity:1;pointer-events:all}
.sell-sheet{width:100%;max-width:480px;background:var(--bg2);
  border:1px solid var(--border);border-bottom:none;border-radius:22px 22px 0 0;
  padding:24px 20px 32px;transform:translateY(100%);
  transition:transform .32s cubic-bezier(.32,.72,0,1)}
#sell-modal.visible .sell-sheet{transform:translateY(0)}
.sell-handle{width:36px;height:3px;background:var(--border);border-radius:2px;margin:0 auto 18px}
.sell-item-hdr{display:flex;align-items:center;gap:14px;margin-bottom:18px}
.sell-item-em{font-size:48px}
.sell-item-nm{font-family:'Cinzel',serif;font-size:16px;font-weight:700;color:var(--text)}
.sell-item-sb{font-size:12px;color:var(--text-dim);margin-top:2px;font-style:italic}
.sell-opts{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.sell-opt{padding:13px 8px;border-radius:12px;background:rgba(240,192,64,.05);
  border:1px solid rgba(240,192,64,.18);text-align:center;cursor:pointer;transition:all .18s}
.sell-opt:active{background:rgba(240,192,64,.14);transform:scale(.96)}
.sell-opt.sell-opt-all{grid-column:1/-1;background:rgba(192,57,43,.08);border-color:rgba(192,57,43,.25)}
.so-count{font-family:'Cinzel',serif;font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px}
.so-gold{font-size:11px;color:var(--gold)}
.sell-cancel{width:100%;margin-top:10px;padding:11px;background:transparent;
  border:1px solid var(--border);border-radius:12px;color:var(--text-dim);
  font-family:'Cinzel',serif;font-size:11px;cursor:pointer}

/* PROFILE */
.profile-hero{background:var(--panel);border:1px solid var(--border);
  border-radius:16px;padding:18px;margin-bottom:10px;text-align:center;
  position:relative;overflow:hidden}
.profile-hero::before{content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 50% 0%,rgba(240,192,64,.07) 0%,transparent 70%)}
.ph-avatar{font-size:50px;margin-bottom:6px;filter:drop-shadow(0 0 14px rgba(240,192,64,.35))}
.ph-name{font-family:'Cinzel',serif;font-size:18px;font-weight:700;
  color:var(--gold);text-shadow:0 0 12px var(--gold-glow)}
.ph-sub{font-size:12px;color:var(--text-dim);margin-top:3px;font-style:italic}
.profile-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.ps{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
.ps-icon{font-size:18px;margin-bottom:4px}
.ps-val{font-family:'Cinzel',serif;font-size:18px;font-weight:700;color:var(--gold)}
.ps-lbl{font-size:10px;color:var(--text-dim);text-transform:uppercase;
  letter-spacing:.06em;font-family:'Cinzel',serif;margin-top:1px}
.ref-card{background:var(--panel);border:1px solid rgba(240,192,64,.28);
  border-radius:16px;padding:16px;margin-bottom:10px;position:relative;overflow:hidden}
.ref-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1.5px;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);opacity:.5}
.ref-title{font-family:'Cinzel',serif;font-size:12px;font-weight:700;color:var(--gold);margin-bottom:5px}
.ref-desc{font-size:12px;color:var(--text-dim);font-style:italic;margin-bottom:12px}
.ref-reward-row{display:flex;align-items:center;gap:8px;margin-bottom:12px;
  padding:9px 12px;background:rgba(240,192,64,.07);border-radius:10px;border:1px solid rgba(240,192,64,.18)}
.rr-txt{font-family:'Cinzel',serif;font-size:13px;font-weight:600;color:var(--gold)}
.rr-sub{font-size:11px;color:var(--text-dim)}
.ref-link-lbl{font-family:'Cinzel',serif;font-size:9px;color:var(--text-dim);
  text-transform:uppercase;letter-spacing:.1em;margin-bottom:3px}
.ref-link-box{background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:9px;
  padding:9px 12px;font-size:11px;color:var(--text-dim);font-family:monospace;
  word-break:break-all;margin-bottom:9px}
.ref-share-btn{width:100%;padding:12px;
  background:linear-gradient(135deg,rgba(240,192,64,.12),rgba(240,192,64,.06));
  border:1px solid rgba(240,192,64,.3);border-radius:12px;font-family:'Cinzel',serif;
  font-size:12px;font-weight:700;color:var(--gold);cursor:pointer;transition:all .18s}
.ref-share-btn:active{background:rgba(240,192,64,.18);transform:scale(.98)}
.ref-person{display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:6px;
  background:var(--panel);border:1px solid var(--border);border-radius:12px}
.rp-name{font-family:'Cinzel',serif;font-size:12px;color:var(--text);flex:1}
.rp-ts{font-size:10px;color:var(--text-dim)}
.rp-gold{font-family:'Cinzel',serif;font-size:12px;font-weight:600;color:var(--gold)}

/* SETTINGS */
.settings-card{background:var(--panel);border:1px solid var(--border);
  border-radius:16px;padding:16px;margin-bottom:10px}
.settings-title{font-family:'Cinzel',serif;font-size:12px;font-weight:700;
  color:var(--gold);margin-bottom:14px;letter-spacing:.08em;text-transform:uppercase}
.setting-row{display:flex;align-items:center;justify-content:space-between;
  padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.setting-row:last-child{border-bottom:none;padding-bottom:0}
.setting-lbl{font-family:'Cinzel',serif;font-size:13px;color:var(--text)}
.setting-sub{font-size:11px;color:var(--text-dim);margin-top:2px;font-style:italic}
.toggle{width:44px;height:24px;background:rgba(255,255,255,.1);border-radius:12px;
  position:relative;cursor:pointer;transition:background .25s;flex-shrink:0;border:none}
.toggle.on{background:var(--gold)}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;
  background:#fff;border-radius:50%;transition:transform .25s;
  box-shadow:0 1px 4px rgba(0,0,0,.4)}
.toggle.on::after{transform:translateX(20px)}
.lang-switcher{display:flex;gap:4px}
.lang-btn{padding:4px 10px;border-radius:8px;font-family:'Cinzel',serif;font-size:11px;
  font-weight:600;cursor:pointer;transition:all .2s;border:1px solid var(--border);
  background:transparent;color:var(--text-dim)}
.lang-btn.active{background:rgba(240,192,64,.15);border-color:rgba(240,192,64,.4);color:var(--gold)}

/* TOAST */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(16px);
  z-index:400;background:rgba(16,12,8,.97);border:1px solid var(--border);
  border-radius:12px;padding:10px 18px;font-family:'Cinzel',serif;font-size:12px;
  color:var(--text);white-space:nowrap;opacity:0;pointer-events:none;transition:all .28s;
  box-shadow:0 8px 28px rgba(0,0,0,.5)}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

.empty-state{text-align:center;padding:44px 20px}
.es-icon{font-size:48px;margin-bottom:12px;opacity:.35}
.es-txt{font-family:'Cinzel',serif;font-size:13px;color:var(--text-dim);font-weight:600;margin-bottom:4px}
.es-sub{font-size:12px;color:var(--text-dim);opacity:.5;font-style:italic}
</style>
</head>
<body>
<canvas id="bg-canvas"></canvas>
<div class="particles" id="particles"></div>

<div id="app">
  <header>
    <div>
      <div class="logo" id="logo-txt">Treasure Chest</div>
      <div class="logo-sub" id="logo-sub">Fantasy Loot Game</div>
    </div>
    <div class="gold-pill">
      <span class="gold-coin">ğŸª™</span>
      <span id="gold-display">â€”</span>
    </div>
  </header>

  <nav>
    <button class="nav-btn active" onclick="showScreen('chests')" id="nav-chests">
      <span class="ni">ğŸ—ƒï¸</span><span data-i="nav_chests">Chests</span>
    </button>
    <button class="nav-btn" onclick="showScreen('inventory')" id="nav-inventory">
      <span class="ni">ğŸ’</span><span data-i="nav_inv">Bag</span>
    </button>
    <button class="nav-btn" onclick="showScreen('profile')" id="nav-profile">
      <span class="ni">ğŸ‘¤</span><span data-i="nav_prof">Profile</span>
    </button>
    <button class="nav-btn" onclick="showScreen('settings')" id="nav-settings">
      <span class="ni">âš™ï¸</span><span data-i="nav_set">Settings</span>
    </button>
  </nav>

  <div id="screens" style="position:relative">

    <!-- CHESTS -->
    <div class="screen active" id="screen-chests">
      <div class="sec-title" data-i="choose_chest">Choose Your Chest</div>
      <div class="chests-grid" id="chests-grid"></div>
    </div>

    <!-- INVENTORY -->
    <div class="screen" id="screen-inventory">
      <div class="inv-top">
        <div class="stat-box">
          <div class="stat-box-lbl" data-i="items">Items</div>
          <div class="stat-box-val" id="inv-count">â€”</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-lbl" data-i="total_val">Total Value</div>
          <div class="stat-box-val" id="inv-value">â€”</div>
        </div>
      </div>
      <button class="sell-all-btn" onclick="sellAll()">ğŸ—‘ï¸ <span data-i="sell_all">Sell Everything</span></button>
      <div class="sec-title" data-i="your_items">Your Items</div>
      <div id="inv-list"></div>
    </div>

    <!-- PROFILE -->
    <div class="screen" id="screen-profile">
      <div class="profile-hero">
        <div class="ph-avatar">âš”ï¸</div>
        <div class="ph-name" id="profile-name">Adventurer</div>
        <div class="ph-sub" data-i="treasure_hunter">Treasure Hunter</div>
      </div>
      <div class="profile-stats">
        <div class="ps"><div class="ps-icon">ğŸ“¦</div><div class="ps-val" id="stat-chests">â€”</div><div class="ps-lbl" data-i="chests_opened">Chests Opened</div></div>
        <div class="ps"><div class="ps-icon">ğŸ’¸</div><div class="ps-val" id="stat-earned">â€”</div><div class="ps-lbl" data-i="total_sold">Total Sold</div></div>
        <div class="ps"><div class="ps-icon">ğŸ‘¥</div><div class="ps-val" id="stat-refs">â€”</div><div class="ps-lbl" data-i="referrals">Referrals</div></div>
        <div class="ps"><div class="ps-icon">ğŸ’</div><div class="ps-val" id="stat-nw">â€”</div><div class="ps-lbl" data-i="net_worth">Net Worth</div></div>
      </div>
      <div class="ref-card">
        <div class="ref-title">ğŸ‘¥ <span data-i="ref_program">Referral Program</span></div>
        <div class="ref-desc" data-i="ref_desc">Invite friends and earn gold for each adventurer who joins!</div>
        <div class="ref-reward-row">
          <span style="font-size:18px">ğŸª™</span>
          <div><div class="rr-txt">+500 <span data-i="gold_per_ref">Gold per referral</span></div><div class="rr-sub" data-i="paid_instantly">Paid instantly when they join</div></div>
        </div>
        <div class="ref-link-lbl" data-i="your_link">Your Link</div>
        <div class="ref-link-box" id="ref-link-box">â€”</div>
        <button class="ref-share-btn" onclick="shareRef()">ğŸ”— <span data-i="share_link">Share Referral Link</span></button>
      </div>
      <div class="sec-title" data-i="your_refs">Your Referrals</div>
      <div id="ref-list"></div>
    </div>

    <!-- SETTINGS -->
    <div class="screen" id="screen-settings">
      <div class="settings-card">
        <div class="settings-title" data-i="language">ğŸŒ Language / Ğ¯Ğ·Ñ‹Ğº</div>
        <div class="setting-row">
          <div>
            <div class="setting-lbl">Interface Language</div>
            <div class="setting-sub">Ğ¯Ğ·Ñ‹Ğº Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°</div>
          </div>
          <div class="lang-switcher">
            <button class="lang-btn active" id="lang-en" onclick="setLang('en')">EN</button>
            <button class="lang-btn" id="lang-ru" onclick="setLang('ru')">RU</button>
          </div>
        </div>
      </div>
      <div class="settings-card">
        <div class="settings-title" data-i="about">âš”ï¸ About</div>
        <div class="setting-row">
          <div>
            <div class="setting-lbl">Treasure Chest</div>
            <div class="setting-sub" data-i="about_desc">Fantasy loot game</div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /screens -->

  <!-- CHEST DETAIL -->
  <div id="chest-detail">
    <div class="detail-header">
      <button class="back-btn" onclick="closeDetail()">â€¹</button>
      <div class="detail-title" id="detail-title">â€”</div>
    </div>
    <div class="detail-chest-hero">
      <div class="detail-chest-img" id="detail-chest-img">ğŸ“¦</div>
      <div class="detail-chest-name" id="detail-chest-name">â€”</div>
      <div class="detail-chest-desc" id="detail-chest-desc">â€”</div>
    </div>
    <div class="open-buttons">
      <button class="open-btn open-btn-slow" onclick="doOpen(false)">
        <span class="btn-icon">â³</span>
        <span data-i="open_slow">Open Slowly</span>
        <div class="btn-cost" id="btn-cost-slow">â€” ğŸª™</div>
      </button>
      <button class="open-btn open-btn-fast" onclick="doOpen(true)">
        <span class="btn-icon">âš¡</span>
        <span data-i="open_fast">Open Fast</span>
        <div class="btn-cost" id="btn-cost-fast">â€” ğŸª™</div>
      </button>
    </div>
    <div class="sec-title" style="margin:14px 14px 8px" data-i="possible_drops">Possible Drops</div>
    <div class="drop-table" id="drop-table"></div>
  </div>

</div><!-- /app -->

<!-- SPIN SCREEN -->
<div id="spin-screen">
  <div class="spin-chest-anim" id="spin-chest">ğŸ“¦</div>
  <div class="spin-status" id="spin-status">Opening...</div>
  <div class="reel-wrap">
    <div class="reel-line"></div>
    <div class="reel-track" id="reel-track"></div>
  </div>
  <div id="spin-result">
    <div class="res-badge" id="res-badge">Common</div>
    <div class="res-name" id="res-name">Item</div>
    <div class="res-val"><span data-i="worth">Worth</span> <span id="res-val">0</span>ğŸª™</div>
    <div class="res-actions" style="margin-top:14px">
      <button class="btn-keep" onclick="keepItem()" data-i="keep_it">Keep It</button>
      <button class="btn-sell-now" onclick="sellNow()" data-i="sell_now">Sell Now</button>
    </div>
  </div>
</div>

<!-- SELL MODAL -->
<div id="sell-modal" onclick="closeSellModal(event)">
  <div class="sell-sheet">
    <div class="sell-handle"></div>
    <div class="sell-item-hdr">
      <div class="sell-item-em" id="modal-em">ğŸ§ª</div>
      <div>
        <div class="sell-item-nm" id="modal-nm">â€”</div>
        <div class="sell-item-sb" id="modal-sb">â€”</div>
      </div>
    </div>
    <div class="sell-opts" id="sell-opts"></div>
    <button class="sell-cancel" onclick="closeSellModal()" data-i="cancel">Cancel</button>
  </div>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_BASE     = "http://localhost:8000"; // â† Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸ Ğ½Ğ° Render URL
const BOT_USERNAME = "plovinhogame_bot";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRANSLATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const T = {
  en: {
    nav_chests:"Chests", nav_inv:"Bag", nav_prof:"Profile", nav_set:"Settings",
    choose_chest:"Choose Your Chest",
    items:"Items", total_val:"Total Value", sell_all:"Sell Everything",
    your_items:"Your Items", treasure_hunter:"Treasure Hunter",
    chests_opened:"Chests Opened", total_sold:"Total Sold",
    referrals:"Referrals", net_worth:"Net Worth",
    ref_program:"Referral Program",
    ref_desc:"Invite friends and earn gold for each adventurer who joins!",
    gold_per_ref:"Gold per referral", paid_instantly:"Paid instantly when they join",
    your_link:"Your Link", share_link:"Share Referral Link", your_refs:"Your Referrals",
    language:"ğŸŒ Language / Ğ¯Ğ·Ñ‹Ğº", about:"âš”ï¸ About", about_desc:"Fantasy loot game",
    open_slow:"Open Slowly", open_fast:"Open Fast",
    possible_drops:"Possible Drops",
    opening:"Opening...", keep_it:"Keep It", sell_now:"Sell Now", worth:"Worth",
    cancel:"Cancel",
    not_enough:"âŒ Not enough gold!",
    added_inv:"ğŸ’ Added to inventory!",
    sold_for:"ğŸ’° Sold for",
    sold_all_for:"ğŸ’° Sold everything for",
    inv_empty:"ğŸ’ Inventory is empty!",
    items_label:"items", value_label:"value",
    link_copied:"ğŸ”— Link copied!",
    no_referrals_title:"No Referrals Yet",
    no_referrals_sub:"Share your link to earn 500ğŸª™!",
    no_items_title:"Inventory Empty",
    no_items_sub:"Open some chests to find loot!",
  },
  ru: {
    nav_chests:"ĞšĞµĞ¹ÑÑ‹", nav_inv:"Ğ¡ÑƒĞ¼ĞºĞ°", nav_prof:"ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", nav_set:"ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸",
    choose_chest:"Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ĞšĞµĞ¹Ñ",
    items:"ĞŸÑ€ĞµĞ´Ğ¼ĞµÑ‚Ñ‹", total_val:"ĞĞ±Ñ‰Ğ°Ñ Ñ†ĞµĞ½Ğ°", sell_all:"ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ Ğ²ÑÑ‘",
    your_items:"Ğ¢Ğ²Ğ¾Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ñ‹", treasure_hunter:"ĞÑ…Ğ¾Ñ‚Ğ½Ğ¸Ğº Ğ·Ğ° ÑĞ¾ĞºÑ€Ğ¾Ğ²Ğ¸Ñ‰Ğ°Ğ¼Ğ¸",
    chests_opened:"ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¾ ĞºĞµĞ¹ÑĞ¾Ğ²", total_sold:"ĞŸÑ€Ğ¾Ğ´Ğ°Ğ½Ğ¾ Ğ½Ğ°",
    referrals:"Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹", net_worth:"ĞšĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»",
    ref_program:"Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°",
    ref_desc:"ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞ°Ğ¹ Ğ´Ñ€ÑƒĞ·ĞµĞ¹ Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ğ¹ Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ¾ Ğ·Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°!",
    gold_per_ref:"Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ° Ğ·Ğ° Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ°", paid_instantly:"ĞĞ°Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ÑÑ ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ñ€Ğ¸ Ğ²Ñ…Ğ¾Ğ´Ğµ",
    your_link:"Ğ¢Ğ²Ğ¾Ñ ÑÑÑ‹Ğ»ĞºĞ°", share_link:"ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹", your_refs:"Ğ¢Ğ²Ğ¾Ğ¸ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹",
    language:"ğŸŒ Language / Ğ¯Ğ·Ñ‹Ğº", about:"âš”ï¸ Ğ Ğ¸Ğ³Ñ€Ğµ", about_desc:"Ğ¤ÑĞ½Ñ‚ĞµĞ·Ğ¸Ğ¹Ğ½Ğ°Ñ Ğ»ÑƒÑ‚-Ğ¸Ğ³Ñ€Ğ°",
    open_slow:"ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾", open_fast:"ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾",
    possible_drops:"Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ñ‹",
    opening:"ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼...", keep_it:"ĞÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ", sell_now:"ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ", worth:"Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ",
    cancel:"ĞÑ‚Ğ¼ĞµĞ½Ğ°",
    not_enough:"âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ°!",
    added_inv:"ğŸ’ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ!",
    sold_for:"ğŸ’° ĞŸÑ€Ğ¾Ğ´Ğ°Ğ½Ğ¾ Ğ·Ğ°",
    sold_all_for:"ğŸ’° ĞŸÑ€Ğ¾Ğ´Ğ°Ğ½Ğ¾ Ğ²ÑÑ‘ Ğ·Ğ°",
    inv_empty:"ğŸ’ Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ Ğ¿ÑƒÑÑ‚!",
    items_label:"Ğ¿Ñ€ĞµĞ´Ğ¼.", value_label:"Ñ†ĞµĞ½Ğ°",
    link_copied:"ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°!",
    no_referrals_title:"Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚",
    no_referrals_sub:"ĞŸĞ¾Ğ´ĞµĞ»Ğ¸ÑÑŒ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹ Ğ¸ Ğ·Ğ°Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ¹ 500ğŸª™!",
    no_items_title:"Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ Ğ¿ÑƒÑÑ‚",
    no_items_sub:"ĞÑ‚ĞºÑ€Ğ¾Ğ¹ ĞºĞµĞ¹ÑÑ‹ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ»ÑƒÑ‚!",
  }
};
let LANG = localStorage.getItem("lang") || "en";
function t(key) { return T[LANG][key] || T.en[key] || key; }
function applyLang() {
  document.querySelectorAll("[data-i]").forEach(el => {
    const k = el.getAttribute("data-i");
    el.textContent = t(k);
  });
  document.getElementById("lang-en").classList.toggle("active", LANG==="en");
  document.getElementById("lang-ru").classList.toggle("active", LANG==="ru");
  // Re-render dynamic content
  renderChests();
  if (document.getElementById("screen-inventory").classList.contains("active")) renderInventory();
  if (document.getElementById("screen-profile").classList.contains("active"))   renderProfile();
}
function setLang(l) {
  LANG = l;
  localStorage.setItem("lang", l);
  applyLang();
  showToast(l==="ru" ? "ğŸŒ Ğ ÑƒÑÑĞºĞ¸Ğ¹ ÑĞ·Ñ‹Ğº Ğ²ĞºĞ»ÑÑ‡Ñ‘Ğ½" : "ğŸŒ English language set");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHEST DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHESTS = [
  { key:"wooden",  icon:"ğŸªµ", tier:"t1",
    name:"Wooden Chest",
    desc_en:"A battered old chest. Cheap thrills for the brave!",
    desc_ru:"ĞŸĞ¾Ñ‚Ñ€Ñ‘Ğ¿Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ÑÑƒĞ½Ğ´ÑƒĞº. Ğ”Ñ‘ÑˆĞµĞ²Ğ¾ Ğ¸ ÑĞµÑ€Ğ´Ğ¸Ñ‚Ğ¾!",
    cost:30,
    badge_en:"âšª Starter", badge_ru:"âšª Ğ¡Ñ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ñ‹Ğ¹",
    badge_color:"rgba(150,150,150,.2)", badge_text:"#aaa",
  },
  { key:"bone",    icon:"ğŸ¦´", tier:"t2",
    name:"Bone Chest",
    desc_en:"Crafted from ancient bones. Uncommon finds await!",
    desc_ru:"Ğ¡Ğ´ĞµĞ»Ğ°Ğ½ Ğ¸Ğ· Ğ´Ñ€ĞµĞ²Ğ½Ğ¸Ñ… ĞºĞ¾ÑÑ‚ĞµĞ¹. Ğ–Ğ´Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¾Ğº!",
    cost:60,
    badge_en:"ğŸŸ¢ Uncommon", badge_ru:"ğŸŸ¢ ĞĞµĞ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹",
    badge_color:"rgba(46,204,113,.15)", badge_text:"#2ecc71",
  },
  { key:"silver",  icon:"ğŸ¥ˆ", tier:"t2",
    name:"Silver Chest",
    desc_en:"A polished silver chest. Better odds for rare loot.",
    desc_ru:"ĞĞ°Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞµÑ€ĞµĞ±Ñ€ÑĞ½Ñ‹Ğ¹ ÑÑƒĞ½Ğ´ÑƒĞº. Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ ÑˆĞ°Ğ½ÑĞ¾Ğ² Ğ½Ğ° Ñ€ĞµĞ´ĞºĞ¸Ğ¹ Ğ»ÑƒÑ‚.",
    cost:100,
    badge_en:"ğŸ”µ Rare+", badge_ru:"ğŸ”µ Ğ ĞµĞ´ĞºĞ¸Ğ¹+",
    badge_color:"rgba(93,173,226,.15)", badge_text:"#5dade2",
  },
  { key:"shadow",  icon:"ğŸŒ‘", tier:"t4",
    name:"Shadow Chest",
    desc_en:"From the void. Epic and Legendary chances boosted!",
    desc_ru:"Ğ˜Ğ· Ğ¿ÑƒÑÑ‚Ğ¾Ñ‚Ñ‹. ĞŸĞ¾Ğ²Ñ‹ÑˆĞµĞ½Ğ½Ñ‹Ğ¹ ÑˆĞ°Ğ½Ñ Ğ½Ğ° Ğ­Ğ¿Ğ¸Ğº Ğ¸ Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ğµ!",
    cost:200,
    badge_en:"ğŸŸ£ Epic+", badge_ru:"ğŸŸ£ Ğ­Ğ¿Ğ¸Ğº+",
    badge_color:"rgba(142,68,173,.18)", badge_text:"#c39bd3",
  },
  { key:"dragon",  icon:"ğŸ‰", tier:"t5",
    name:"Dragon Chest",
    desc_en:"Forged in dragon fire. Legendary loot is close!",
    desc_ru:"Ğ’Ñ‹ĞºĞ¾Ğ²Ğ°Ğ½ Ğ² Ğ¾Ğ³Ğ½Ğµ Ğ´Ñ€Ğ°ĞºĞ¾Ğ½Ğ°. Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ğ¹ Ğ»ÑƒÑ‚ ÑĞ¾Ğ²ÑĞµĞ¼ Ğ±Ğ»Ğ¸Ğ·ĞºĞ¾!",
    cost:500,
    badge_en:"ğŸ”´ Legendary", badge_ru:"ğŸ”´ Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ğ¹",
    badge_color:"rgba(231,76,60,.18)", badge_text:"#e74c3c",
  },
  { key:"golden",  icon:"âœ¨", tier:"t6",
    name:"Golden Chest",
    desc_en:"The pinnacle of treasure. Legendary items guaranteed!*",
    desc_ru:"Ğ’ĞµÑ€ÑˆĞ¸Ğ½Ğ° ÑĞ¾ĞºÑ€Ğ¾Ğ²Ğ¸Ñ‰. Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ğµ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ñ‹ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹!*",
    cost:1000,
    badge_en:"ğŸŒŸ Mythic", badge_ru:"ğŸŒŸ ĞœĞ¸Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹",
    badge_color:"rgba(255,215,0,.2)", badge_text:"#ffd700",
  },
];

// Chest odds per tier (rarity weights: Common/Uncommon/Rare/Epic/Legendary)
const CHEST_ODDS = {
  wooden: [50,30,15,4,1],
  bone:   [30,40,22,6,2],
  silver: [20,30,32,12,6],
  shadow: [10,20,30,28,12],
  dragon: [5,10,20,30,35],
  golden: [0,5,10,25,60],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ITEMS DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ITEMS = {
  health_potion:   {name:"Health Potion",   emoji:"ğŸ§ª", rarity:"Common",    value:10},
  wooden_sword:    {name:"Wooden Sword",    emoji:"ğŸ—¡ï¸",  rarity:"Common",    value:15},
  leather_boots:   {name:"Leather Boots",   emoji:"ğŸ‘¢", rarity:"Common",    value:12},
  bread_loaf:      {name:"Bread Loaf",      emoji:"ğŸ", rarity:"Common",    value:5},
  iron_shield:     {name:"Iron Shield",     emoji:"ğŸ›¡ï¸",  rarity:"Common",    value:20},
  mana_potion:     {name:"Mana Potion",     emoji:"ğŸ’™", rarity:"Uncommon",  value:35},
  silver_dagger:   {name:"Silver Dagger",   emoji:"ğŸ”ª", rarity:"Uncommon",  value:50},
  chain_armor:     {name:"Chain Armor",     emoji:"â›“ï¸",  rarity:"Uncommon",  value:60},
  magic_scroll:    {name:"Magic Scroll",    emoji:"ğŸ“œ", rarity:"Uncommon",  value:45},
  enchanted_ring:  {name:"Enchanted Ring",  emoji:"ğŸ’", rarity:"Uncommon",  value:55},
  elven_bow:       {name:"Elven Bow",       emoji:"ğŸ¹", rarity:"Rare",      value:150},
  fire_staff:      {name:"Fire Staff",      emoji:"ğŸ”¥", rarity:"Rare",      value:180},
  dragon_scale:    {name:"Dragon Scale",    emoji:"ğŸ‰", rarity:"Rare",      value:200},
  crystal_amulet:  {name:"Crystal Amulet",  emoji:"ğŸ”®", rarity:"Rare",      value:160},
  thunder_axe:     {name:"Thunder Axe",     emoji:"âš¡", rarity:"Epic",      value:500},
  void_cloak:      {name:"Void Cloak",      emoji:"ğŸŒ‘", rarity:"Epic",      value:550},
  phoenix_feather: {name:"Phoenix Feather", emoji:"ğŸ¦…", rarity:"Epic",      value:480},
  excalibur:       {name:"Excalibur",       emoji:"âš”ï¸",  rarity:"Legendary", value:2000},
  crown_of_gods:   {name:"Crown of Gods",   emoji:"ğŸ‘‘", rarity:"Legendary", value:2500},
  chaos_orb:       {name:"Chaos Orb",       emoji:"ğŸŒ€", rarity:"Legendary", value:1800},
};
const ITEM_KEYS    = Object.keys(ITEMS);
const RARITY_ORDER = ["Common","Uncommon","Rare","Epic","Legendary"];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {gold:0,inventory:{},chests_opened:0,total_earned:0,referrals:[],first_name:"Adventurer"};
let pendingItem  = null;
let modalItem    = null;
let isSpinning   = false;
let currentChest = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TELEGRAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const tg = window.Telegram?.WebApp;
if(tg){tg.ready();tg.expand();}
const initData = tg?.initData||"";
function apiHeaders(){
  const h={"Content-Type":"application/json"};
  if(initData) h["X-Telegram-Init-Data"]=initData;
  else if(tg?.initDataUnsafe?.user?.id) h["X-User-Id"]=String(tg.initDataUnsafe.user.id);
  return h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiFetch(path, opts={}){
  try{
    const r=await fetch(API_BASE+path,{headers:apiHeaders(),...opts});
    if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.detail||"Error");}
    return await r.json();
  }catch(e){ showToast("âŒ "+e.message); throw e; }
}
async function loadPlayer(){
  const d=await apiFetch("/api/player");
  state={...state,...d}; updateGold();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKGROUND CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const c=document.getElementById("bg-canvas");
  const ctx=c.getContext("2d");
  const stars=[];
  function resize(){ c.width=innerWidth; c.height=innerHeight; }
  resize(); window.addEventListener("resize",resize);
  for(let i=0;i<120;i++) stars.push({
    x:Math.random(),y:Math.random(),
    r:Math.random()*1.2+.3,
    a:Math.random(),da:(Math.random()-.5)*.008,
  });
  function draw(){
    ctx.clearRect(0,0,c.width,c.height);
    stars.forEach(s=>{
      s.a=Math.max(.1,Math.min(1,s.a+s.da));
      if(s.a<=.1||s.a>=1) s.da*=-1;
      ctx.globalAlpha=s.a*.7;
      ctx.fillStyle="#f0d878";
      ctx.beginPath();
      ctx.arc(s.x*c.width,s.y*c.height,s.r,0,Math.PI*2);
      ctx.fill();
    });
    ctx.globalAlpha=1;
    requestAnimationFrame(draw);
  }
  draw();
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHEST LIST RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChests(){
  const grid=document.getElementById("chests-grid");
  grid.innerHTML=CHESTS.map(ch=>{
    const badge = LANG==="ru" ? ch.badge_ru : ch.badge_en;
    const desc  = LANG==="ru" ? ch.desc_ru  : ch.desc_en;
    const canOpen = state.gold >= ch.cost;
    return `<div class="chest-card ${ch.tier}${canOpen?"":" locked"}" onclick="openDetail('${ch.key}')">
      <div class="chest-art">${ch.icon}</div>
      <div class="chest-info">
        <div class="chest-name">${ch.name}</div>
        <div class="chest-tier-badge" style="background:${ch.badge_color};color:${ch.badge_text};border:1px solid ${ch.badge_text}44">${badge}</div>
        <div class="chest-desc">${desc}</div>
        <div class="chest-cost-row">
          <span class="chest-cost-num">${ch.cost}</span>
          <span class="chest-cost-lbl">ğŸª™ gold</span>
        </div>
      </div>
    </div>`;
  }).join("");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHEST DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetail(chestKey){
  currentChest = CHESTS.find(c=>c.key===chestKey);
  if(!currentChest) return;

  document.getElementById("detail-title").textContent = currentChest.name;
  document.getElementById("detail-chest-img").textContent = currentChest.icon;
  document.getElementById("detail-chest-name").textContent = currentChest.name;
  document.getElementById("detail-chest-desc").textContent =
    LANG==="ru" ? currentChest.desc_ru : currentChest.desc_en;
  document.getElementById("btn-cost-slow").textContent = `${currentChest.cost} ğŸª™`;
  document.getElementById("btn-cost-fast").textContent = `${currentChest.cost} ğŸª™`;

  // Build drop table
  const odds = CHEST_ODDS[chestKey];
  const totalWeight = odds.reduce((a,b)=>a+b,0);
  const dropEl = document.getElementById("drop-table");

  // Group items by rarity
  const byRarity = {};
  ITEM_KEYS.forEach(k=>{ const r=ITEMS[k].rarity; if(!byRarity[r]) byRarity[r]=[]; byRarity[r].push(k); });

  let html="";
  RARITY_ORDER.forEach((rarity,ri)=>{
    if(!byRarity[rarity]||odds[ri]===0) return;
    const rarityChance = odds[ri];
    const itemsInRarity = byRarity[rarity].length;
    byRarity[rarity].forEach(key=>{
      const item = ITEMS[key];
      const chance = (rarityChance / itemsInRarity / totalWeight * 100).toFixed(1);
      html+=`<div class="drop-row">
        <div class="drop-emoji">${item.emoji}</div>
        <div class="drop-info">
          <div class="drop-name ${rarity}">${item.name}</div>
          <div class="drop-val">${item.value}ğŸª™ Â· ${rarity}</div>
        </div>
        <div class="drop-chance ${rarity}">${chance}%</div>
      </div>`;
    });
  });
  dropEl.innerHTML = html;

  document.getElementById("chest-detail").classList.add("open");
  if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
}

function closeDetail(){
  document.getElementById("chest-detail").classList.remove("open");
  currentChest=null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OPEN CHEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doOpen(fast){
  if(!currentChest||isSpinning) return;
  if(state.gold<currentChest.cost){ showToast(t("not_enough")); return; }

  isSpinning=true;
  closeDetail();

  // Show spin screen
  const ss=document.getElementById("spin-screen");
  document.getElementById("spin-result").classList.remove("show");
  document.getElementById("spin-chest").textContent=currentChest.icon;
  document.getElementById("spin-chest").className="spin-chest-anim"+(fast?" fast-mode":"");
  document.getElementById("spin-status").textContent=t("opening");
  ss.classList.add("visible");

  try{
    const result=await apiFetch("/api/open_chest",{
      method:"POST",
      body:JSON.stringify({chest_type:currentChest.key}),
    });
    state.gold=result.gold;
    state.inventory[result.item_key]=(state.inventory[result.item_key]||0)+1;
    pendingItem=result.item_key;
    updateGold();

    // Run spin animation
    const duration = fast ? 1800 : 4500;
    await runSpin(result.item_key, duration);

  }catch(e){
    ss.classList.remove("visible");
    isSpinning=false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPIN ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ITEM_W = 105; // item width + gap

function buildReel(winnerKey){
  const track=document.getElementById("reel-track");
  track.innerHTML="";
  const total=60, winPos=45;
  const arr=[];
  for(let i=0;i<total;i++) arr.push(i===winPos ? winnerKey : randomReelItem());
  arr.forEach((key,i)=>{
    const item=ITEMS[key];
    const el=document.createElement("div");
    el.className=`reel-item ${item.rarity}`;
    if(i===winPos) el.id="reel-winner";
    el.innerHTML=`<div class="ri-emoji">${item.emoji}</div>
      <div class="ri-name">${item.name}</div>
      <div class="ri-rarity ${item.rarity}">${item.rarity}</div>`;
    track.appendChild(el);
  });
  return winPos;
}

function randomReelItem(){
  // Weighted pool biased towards commons for visual variety
  const w={Common:50,Uncommon:30,Rare:15,Epic:4,Legendary:1};
  const pool=[];
  ITEM_KEYS.forEach(k=>{ for(let i=0;i<(w[ITEMS[k].rarity]||1);i++) pool.push(k); });
  return pool[Math.floor(Math.random()*pool.length)];
}

function runSpin(winnerKey, duration){
  return new Promise(resolve=>{
    const track=document.getElementById("reel-track");
    track.style.transition="none";
    track.style.transform="translateX(200px)";

    const ww=document.querySelector(".reel-wrap").offsetWidth;
    const center=ww/2;
    const winPos=buildReel(winnerKey);
    const targetX=-(winPos*ITEM_W)+center-ITEM_W/2;
    const jitter=(Math.random()-.5)*20;
    const finalX=targetX+jitter;
    const startX=200;
    const start=performance.now();

    // Easing: quartic out
    function ease(t){ return 1-Math.pow(1-t,4); }

    let hapticDone=false;
    function step(now){
      const elapsed=now-start;
      const pct=Math.min(elapsed/duration,1);
      const ex=ease(pct);
      track.style.transform=`translateX(${startX+(finalX-startX)*ex}px)`;

      // Haptic feedback when slowing down
      if(pct>0.72&&!hapticDone){
        hapticDone=true;
        if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("medium");
      }

      if(pct<1){ requestAnimationFrame(step); }
      else{
        // Snap to exact center
        track.style.transform=`translateX(${targetX}px)`;
        const winner=document.getElementById("reel-winner");
        if(winner) winner.classList.add("is-winner");
        setTimeout(()=>{ showSpinResult(ITEMS[winnerKey]); resolve(); }, 350);
      }
    }
    requestAnimationFrame(step);
  });
}

function showSpinResult(item){
  if(tg?.HapticFeedback){
    const hap={Common:"light",Uncommon:"medium",Rare:"medium",Epic:"heavy",Legendary:"heavy"};
    tg.HapticFeedback.impactOccurred(hap[item.rarity]||"light");
    if(item.rarity==="Legendary") setTimeout(()=>tg.HapticFeedback.notificationOccurred("success"),200);
  }
  if(["Epic","Legendary"].includes(item.rarity)) spawnParticles(item.rarity);

  document.getElementById("res-badge").textContent = item.rarity;
  document.getElementById("res-badge").className   = "res-badge "+item.rarity;
  document.getElementById("res-name").textContent  = item.name;
  document.getElementById("res-name").className    = "res-name "+item.rarity;
  document.getElementById("res-val").textContent   = item.value;

  // Update worth label
  const worthEl = document.querySelector("#spin-result .res-val [data-i='worth']");
  if(worthEl) worthEl.textContent=t("worth");
  document.querySelector(".btn-keep").textContent=t("keep_it");
  document.querySelector(".btn-sell-now").textContent=t("sell_now");

  document.getElementById("spin-result").classList.add("show");
  document.getElementById("spin-status").style.display="none";
}

function keepItem(){
  document.getElementById("spin-screen").classList.remove("visible");
  document.getElementById("spin-status").style.display="";
  document.getElementById("particles").innerHTML="";
  pendingItem=null; isSpinning=false;
  showToast(t("added_inv"));
}

async function sellNow(){
  if(!pendingItem) return;
  try{
    const d=await apiFetch("/api/sell",{method:"POST",body:JSON.stringify({item_key:pendingItem,quantity:1})});
    state.gold=d.gold;
    state.inventory[pendingItem]=(state.inventory[pendingItem]||1)-1;
    if(state.inventory[pendingItem]<=0) delete state.inventory[pendingItem];
    updateGold();
    showToast(`${t("sold_for")} ${d.earnings}ğŸª™!`);
  }catch(e){}
  document.getElementById("spin-screen").classList.remove("visible");
  document.getElementById("spin-status").style.display="";
  document.getElementById("particles").innerHTML="";
  pendingItem=null; isSpinning=false;
}

function spawnParticles(rarity){
  const pc=document.getElementById("particles");
  pc.innerHTML="";
  const col={Epic:"#c39bd3",Legendary:"#f0c040"}[rarity];
  const n=rarity==="Legendary"?55:25;
  for(let i=0;i<n;i++){
    const p=document.createElement("div");
    p.className="pt";
    const sz=Math.random()*9+4;
    p.style.cssText=`width:${sz}px;height:${sz}px;background:${col};
      left:${20+Math.random()*60}%;top:${25+Math.random()*35}%;
      --tx:${(Math.random()-.5)*420}px;--ty:${(Math.random()-.5)*520}px;
      animation-delay:${Math.random()*.45}s;animation-duration:${Math.random()*1.2+1}s`;
    pc.appendChild(p);
  }
  setTimeout(()=>pc.innerHTML="",2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateGold(){
  const el=document.getElementById("gold-display");
  el.style.transform="scale(1.18)"; el.style.color="#fff";
  el.textContent=state.gold;
  setTimeout(()=>{el.style.transform="";el.style.color=""},320);
  renderChests(); // update locked state
}

function showScreen(name){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
  document.getElementById("screen-"+name).classList.add("active");
  document.getElementById("nav-"+name).classList.add("active");
  if(name==="inventory") renderInventory();
  if(name==="profile")   renderProfile();
}

function renderInventory(){
  const items=Object.entries(state.inventory).filter(([,v])=>v>0);
  const count=items.reduce((a,[,v])=>a+v,0);
  const value=items.reduce((a,[k,v])=>a+(ITEMS[k]?.value||0)*v,0);
  document.getElementById("inv-count").textContent=count;
  document.getElementById("inv-value").textContent=value+"ğŸª™";
  const sorted=[...items].sort((a,b)=>RARITY_ORDER.indexOf(ITEMS[b[0]]?.rarity)-RARITY_ORDER.indexOf(ITEMS[a[0]]?.rarity));
  const list=document.getElementById("inv-list");
  if(!sorted.length){
    list.innerHTML=`<div class="empty-state"><div class="es-icon">ğŸ’</div>
      <div class="es-txt">${t("no_items_title")}</div>
      <div class="es-sub">${t("no_items_sub")}</div></div>`;
    return;
  }
  list.innerHTML=sorted.map(([key,cnt])=>{
    const item=ITEMS[key]||{};
    return `<div class="inv-item rarity-${item.rarity}" onclick="openSellModal('${key}')">
      <div class="ii-emoji">${item.emoji||"ğŸ“¦"}</div>
      <div class="ii-info">
        <div class="ii-name">${item.name||key}</div>
        <div class="ii-rarity ${item.rarity}">â¬¥ ${item.rarity}</div>
      </div>
      <div class="ii-right">
        <div class="ii-count">Ã—${cnt}</div>
        <div class="ii-val">${(item.value||0)*cnt}ğŸª™</div>
      </div>
    </div>`;
  }).join("");
}

function renderProfile(){
  document.getElementById("profile-name").textContent=state.first_name||"Adventurer";
  document.getElementById("stat-chests").textContent=state.chests_opened;
  document.getElementById("stat-earned").textContent=state.total_earned+"ğŸª™";
  document.getElementById("stat-refs").textContent=state.referrals.length;
  const invVal=Object.entries(state.inventory).reduce((a,[k,v])=>a+(ITEMS[k]?.value||0)*v,0);
  document.getElementById("stat-nw").textContent=(state.gold+invVal)+"ğŸª™";
  const uid=tg?.initDataUnsafe?.user?.id||"demo";
  document.getElementById("ref-link-box").textContent=`https://t.me/${BOT_USERNAME}?start=ref_${uid}`;
  const rl=document.getElementById("ref-list");
  if(!state.referrals.length){
    rl.innerHTML=`<div class="empty-state"><div class="es-icon">ğŸ‘¥</div>
      <div class="es-txt">${t("no_referrals_title")}</div>
      <div class="es-sub">${t("no_referrals_sub")}</div></div>`;
  } else {
    rl.innerHTML=state.referrals.map(r=>`
      <div class="ref-person">
        <span style="font-size:22px">ğŸ‘¤</span>
        <span class="rp-name">${r.name}</span>
        <span class="rp-ts">${r.ts}</span>
        <span class="rp-gold">+500ğŸª™</span>
      </div>`).join("");
  }
}

// SELL MODAL
function openSellModal(key){
  modalItem=key;
  const item=ITEMS[key]; const count=state.inventory[key]||0;
  document.getElementById("modal-em").textContent=item.emoji;
  document.getElementById("modal-nm").textContent=item.name;
  document.getElementById("modal-sb").textContent=`${item.rarity} Â· ${item.value}ğŸª™ each`;
  let html="";
  const opt=(lbl,qty,gold,cls="")=>
    html+=`<div class="sell-opt ${cls}" onclick="execSell(${qty})">
      <div class="so-count">${lbl}</div><div class="so-gold">${gold}ğŸª™</div></div>`;
  opt("Ã—1",1,item.value);
  if(count>=5)  opt("Ã—5",5,item.value*5);
  if(count>=10) opt("Ã—10",10,item.value*10);
  if(count>1)   opt(`${t("sell_all")} (Ã—${count})`,-1,item.value*count,"sell-opt-all");
  document.getElementById("sell-opts").innerHTML=html;
  document.getElementById("sell-modal").classList.add("visible");
}
function closeSellModal(e){
  if(e&&e.target!==document.getElementById("sell-modal")) return;
  document.getElementById("sell-modal").classList.remove("visible");
  modalItem=null;
}
async function execSell(qty){
  if(!modalItem) return;
  try{
    const d=await apiFetch("/api/sell",{method:"POST",body:JSON.stringify({item_key:modalItem,quantity:qty})});
    state.gold=d.gold;
    state.inventory[modalItem]=(state.inventory[modalItem]||0)-d.sold;
    if(state.inventory[modalItem]<=0) delete state.inventory[modalItem];
    updateGold(); renderInventory();
    showToast(`${t("sold_for")} ${d.earnings}ğŸª™!`);
  }catch(e){}
  document.getElementById("sell-modal").classList.remove("visible");
  modalItem=null;
}
async function sellAll(){
  const items=Object.entries(state.inventory).filter(([,v])=>v>0);
  if(!items.length){showToast(t("inv_empty"));return;}
  try{
    const d=await apiFetch("/api/sell_all",{method:"POST"});
    state.gold=d.gold; state.inventory={};
    updateGold(); renderInventory();
    showToast(`${t("sold_all_for")} ${d.earnings}ğŸª™!`);
  }catch(e){}
}

function shareRef(){
  const uid=tg?.initDataUnsafe?.user?.id||"demo";
  const link=`https://t.me/${BOT_USERNAME}?start=ref_${uid}`;
  const txt=LANG==="ru"
    ? "âš”ï¸ ĞŸÑ€Ğ¸ÑĞ¾ĞµĞ´Ğ¸Ğ½ÑĞ¹ÑÑ ĞºĞ¾ Ğ¼Ğ½Ğµ Ğ² Treasure Chest â€” Ñ„ÑĞ½Ñ‚ĞµĞ·Ğ¸Ğ¹Ğ½Ğ°Ñ Ğ»ÑƒÑ‚-Ğ¸Ğ³Ñ€Ğ°!"
    : "âš”ï¸ Join me in Treasure Chest â€” a fantasy loot game!";
  if(tg?.openTelegramLink) tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(txt)}`);
  else if(navigator.share) navigator.share({url:link,text:txt});
  else { navigator.clipboard?.writeText(link); showToast(t("link_copied")); }
}

let toastTmr;
function showToast(msg){
  const el=document.getElementById("toast");
  el.textContent=msg; el.classList.add("show");
  clearTimeout(toastTmr);
  toastTmr=setTimeout(()=>el.classList.remove("show"),2400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async()=>{
  applyLang();
  renderChests();
  try{ await loadPlayer(); renderChests(); } catch(e){ console.warn(e); }
})();
</script>
</body>
</html>
