<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Treasure Chest</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600;700&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
  --gold:#f0c040;--gold-dim:#a07820;--gold-glow:rgba(240,192,64,.4);
  --bg:#08070a;--bg2:#0f0e14;--panel:rgba(22,18,30,.95);
  --border:rgba(240,192,64,.15);--text:#e8d8b0;--text-dim:#7a6e55;
  --c-common:#9a9a9a;--c-uncommon:#2ecc71;--c-rare:#5dade2;
  --c-epic:#c39bd3;--c-legendary:#f0c040;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;width:100%;background:var(--bg);color:var(--text);
  font-family:'EB Garamond',serif;overflow:hidden;user-select:none}
canvas#bgc{position:fixed;inset:0;z-index:0;pointer-events:none}
#app{position:relative;z-index:1;height:100vh;display:flex;flex-direction:column;overflow:hidden}

/* HEADER */
header{flex-shrink:0;padding:12px 16px 8px;
  background:linear-gradient(180deg,rgba(8,7,10,.98),transparent);
  display:flex;align-items:center;justify-content:space-between}
.logo{font-family:'Cinzel Decorative',serif;font-size:14px;font-weight:700;
  color:var(--gold);text-shadow:0 0 20px var(--gold-glow)}
.logo-sub{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.15em}
.gold-pill{display:flex;align-items:center;gap:6px;
  background:rgba(240,192,64,.08);border:1px solid rgba(240,192,64,.22);
  border-radius:20px;padding:5px 12px}
.gold-coin{font-size:15px;animation:coinspin 3s linear infinite}
@keyframes coinspin{0%,44%{transform:rotateY(0)}50%{transform:rotateY(90deg)}56%,100%{transform:rotateY(0)}}
#gold-disp{font-family:'Cinzel',serif;font-size:14px;font-weight:600;
  color:var(--gold);min-width:40px;text-align:right;transition:all .3s}

/* NAV */
nav{flex-shrink:0;display:flex;gap:3px;padding:0 12px 8px}
.nb{flex:1;padding:7px 4px;background:transparent;border:1px solid transparent;
  border-radius:10px;color:var(--text-dim);font-family:'Cinzel',serif;font-size:9px;
  font-weight:600;letter-spacing:.05em;text-transform:uppercase;cursor:pointer;
  transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:2px}
.nb .ni{font-size:17px}
.nb.active{background:rgba(240,192,64,.09);border-color:rgba(240,192,64,.3);color:var(--gold)}
.nb:active{transform:scale(.95)}

/* SCREENS */
#screens{flex:1;overflow:hidden;position:relative}
.screen{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;
  padding:4px 12px 24px;opacity:0;transform:translateY(14px);
  pointer-events:none;transition:opacity .28s,transform .28s}
.screen.active{opacity:1;transform:translateY(0);pointer-events:all}
.screen::-webkit-scrollbar{width:2px}
.screen::-webkit-scrollbar-thumb{background:var(--gold-dim);border-radius:2px}
.sec-title{font-family:'Cinzel',serif;font-size:10px;font-weight:600;
  letter-spacing:.2em;text-transform:uppercase;color:var(--text-dim);
  margin:14px 0 9px;display:flex;align-items:center;gap:8px}
.sec-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}

/* CHEST CARDS */
.chests-grid{display:flex;flex-direction:column;gap:10px;padding-top:2px}
.chest-card{position:relative;overflow:hidden;border-radius:16px;
  background:var(--panel);cursor:pointer;transition:transform .2s;
  display:flex;align-items:center;border:1px solid transparent}
.chest-card:active{transform:scale(.97)}
.chest-card.t1{border-color:rgba(139,90,43,.45);background:linear-gradient(135deg,rgba(22,14,8,.97),rgba(28,18,10,.97))}
.chest-card.t2{border-color:rgba(46,204,113,.3);background:linear-gradient(135deg,rgba(10,18,12,.97),rgba(14,24,16,.97))}
.chest-card.t3{border-color:rgba(93,173,226,.35);background:linear-gradient(135deg,rgba(8,14,22,.97),rgba(10,18,28,.97))}
.chest-card.t4{border-color:rgba(195,155,211,.4);background:linear-gradient(135deg,rgba(16,10,22,.97),rgba(22,12,30,.97))}
.chest-card.t5{border-color:rgba(231,76,60,.45);background:linear-gradient(135deg,rgba(20,8,8,.97),rgba(30,10,10,.97))}
.chest-card.t6{border-color:rgba(255,215,0,.55);background:linear-gradient(135deg,rgba(20,16,0,.97),rgba(30,24,4,.97));box-shadow:0 0 24px rgba(255,215,0,.1)}
.chest-art{width:88px;height:88px;flex-shrink:0;display:flex;align-items:center;
  justify-content:center;font-size:50px;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-6px) rotate(2deg)}}
.chest-info{flex:1;padding:14px 14px 14px 4px}
.chest-name{font-family:'Cinzel',serif;font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px}
.chest-tier{display:inline-block;font-family:'Cinzel',serif;font-size:9px;font-weight:600;
  padding:2px 8px;border-radius:8px;margin-bottom:6px;letter-spacing:.05em}
.chest-desc{font-size:12px;color:var(--text-dim);font-style:italic;margin-bottom:8px;line-height:1.4}
.chest-cost-row{display:flex;align-items:center;gap:6px}
.chest-cost-num{font-family:'Cinzel',serif;font-size:16px;font-weight:700;
  color:var(--gold);text-shadow:0 0 10px var(--gold-glow)}
.chest-cost-lbl{font-size:10px;color:var(--text-dim);text-transform:uppercase}
.chest-card.locked{opacity:.4;pointer-events:none}

/* DETAIL PANEL */
#detail{position:absolute;inset:0;z-index:50;background:var(--bg);
  overflow-y:auto;opacity:0;transform:translateX(100%);pointer-events:none;
  transition:opacity .3s,transform .3s;padding-bottom:30px}
#detail.open{opacity:1;transform:translateX(0);pointer-events:all}
.det-hdr{display:flex;align-items:center;gap:10px;padding:14px 14px 0;margin-bottom:4px}
.back-btn{width:36px;height:36px;background:rgba(240,192,64,.08);
  border:1px solid rgba(240,192,64,.2);border-radius:10px;color:var(--gold);
  font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.back-btn:active{transform:scale(.9)}
.det-title{font-family:'Cinzel',serif;font-size:16px;font-weight:700;color:var(--text)}
.det-hero{text-align:center;padding:10px 0 4px}
.det-icon{font-size:80px;animation:float 2.5s ease-in-out infinite;display:inline-block;
  filter:drop-shadow(0 0 20px rgba(240,192,64,.4))}
.det-name{font-family:'Cinzel Decorative',serif;font-size:16px;font-weight:700;
  color:var(--gold);text-shadow:0 0 14px var(--gold-glow);margin-top:6px}
.det-desc{font-size:13px;color:var(--text-dim);font-style:italic;
  margin:4px 14px 0;text-align:center;line-height:1.5}
.open-btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:14px}
.obtn{padding:16px 10px;border-radius:14px;font-family:'Cinzel',serif;font-size:13px;
  font-weight:700;cursor:pointer;transition:all .25s;text-align:center;border:none;outline:none}
.obtn-slow{background:rgba(240,192,64,.1);border:1px solid rgba(240,192,64,.35);color:var(--gold)}
.obtn-slow:active{background:rgba(240,192,64,.22)}
.obtn-fast{background:linear-gradient(135deg,#8a6010,#f0c040,#8a6010);
  background-size:200%;background-position:100%;color:#1a1000;
  box-shadow:0 4px 18px rgba(240,192,64,.3)}
.obtn-fast:active{background-position:0%}
.obtn .oi{font-size:22px;display:block;margin-bottom:4px}
.obtn .oc{font-size:11px;opacity:.7;margin-top:3px}
.drop-table{padding:0 14px}
.drop-row{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:12px;
  margin-bottom:6px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06)}
.drop-em{font-size:24px;flex-shrink:0;width:32px;text-align:center}
.drop-info{flex:1}
.drop-name{font-family:'Cinzel',serif;font-size:12px;font-weight:600}
.drop-name.Common{color:var(--c-common)}.drop-name.Uncommon{color:var(--c-uncommon)}
.drop-name.Rare{color:var(--c-rare)}.drop-name.Epic{color:var(--c-epic)}.drop-name.Legendary{color:var(--c-legendary)}
.drop-sub{font-size:10px;color:var(--text-dim);margin-top:1px}
.drop-pct{font-family:'Cinzel',serif;font-size:12px;font-weight:700;flex-shrink:0}
.drop-pct.Common{color:var(--c-common)}.drop-pct.Uncommon{color:var(--c-uncommon)}
.drop-pct.Rare{color:var(--c-rare)}.drop-pct.Epic{color:var(--c-epic)}.drop-pct.Legendary{color:var(--c-legendary)}

/* ‚ïê‚ïê‚ïê SPIN OVERLAY ‚ïê‚ïê‚ïê */
#spin-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.97);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:0;opacity:0;pointer-events:none;transition:opacity .3s}
#spin-overlay.on{opacity:1;pointer-events:all}

.spin-chest{font-size:72px;margin-bottom:14px;
  filter:drop-shadow(0 0 24px rgba(240,192,64,.5))}
.spin-chest.shake{animation:shake .3s ease-in-out infinite}
.spin-chest.shake.fast{animation-duration:.12s}
@keyframes shake{0%,100%{transform:rotate(-5deg) scale(1)}50%{transform:rotate(5deg) scale(1.07)}}

.spin-label{font-family:'Cinzel',serif;font-size:11px;letter-spacing:.3em;
  text-transform:uppercase;color:var(--text-dim);margin-bottom:18px;
  animation:blink .6s ease-in-out infinite alternate}
@keyframes blink{from{opacity:.3}to{opacity:1}}

/* REEL */
.reel-wrap{position:relative;width:100%;max-width:480px;height:124px;overflow:hidden}
.reel-wrap::before,.reel-wrap::after{content:'';position:absolute;top:0;bottom:0;
  width:72px;z-index:5;pointer-events:none}
.reel-wrap::before{left:0;background:linear-gradient(90deg,rgba(0,0,0,.97),transparent)}
.reel-wrap::after{right:0;background:linear-gradient(-90deg,rgba(0,0,0,.97),transparent)}
.reel-line{position:absolute;top:0;bottom:0;left:50%;transform:translateX(-50%);
  width:2px;z-index:6;background:var(--gold);
  box-shadow:0 0 10px var(--gold-glow),0 0 24px var(--gold-glow)}
.reel-line::before{content:'‚ñº';position:absolute;top:-15px;left:50%;
  transform:translateX(-50%);color:var(--gold);font-size:12px}
.reel-line::after{content:'‚ñ≤';position:absolute;bottom:-15px;left:50%;
  transform:translateX(-50%);color:var(--gold);font-size:12px}
.reel-track{display:flex;align-items:center;height:124px;gap:5px;padding:0 5px;will-change:transform}
.ri{flex-shrink:0;width:100px;height:112px;border-radius:10px;
  border:1.5px solid rgba(255,255,255,.07);background:rgba(14,10,8,.95);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;
  position:relative}
.ri::after{content:'';position:absolute;bottom:0;left:10%;right:10%;height:2px;border-radius:2px}
.ri.Common::after{background:var(--c-common)}
.ri.Uncommon::after{background:var(--c-uncommon)}
.ri.Rare::after{background:var(--c-rare);box-shadow:0 0 6px var(--c-rare)}
.ri.Epic::after{background:var(--c-epic);box-shadow:0 0 10px var(--c-epic)}
.ri.Legendary::after{background:var(--c-legendary);box-shadow:0 0 14px var(--c-legendary)}
.ri.Common{background:rgba(150,150,150,.06)}
.ri.Uncommon{background:rgba(46,204,113,.06)}
.ri.Rare{background:rgba(93,173,226,.07)}
.ri.Epic{background:rgba(195,155,211,.08)}
.ri.Legendary{background:rgba(240,192,64,.09)}
.ri-em{font-size:36px;line-height:1}
.ri-nm{font-family:'Cinzel',serif;font-size:7.5px;font-weight:600;
  text-align:center;padding:0 3px;color:var(--text-dim)}
.ri-rar{font-size:7px;font-family:'Cinzel',serif;font-weight:700}
.ri-rar.Common{color:var(--c-common)}.ri-rar.Uncommon{color:var(--c-uncommon)}
.ri-rar.Rare{color:var(--c-rare)}.ri-rar.Epic{color:var(--c-epic)}.ri-rar.Legendary{color:var(--c-legendary)}
.ri.winner{border-color:var(--gold) !important;
  box-shadow:0 0 20px rgba(240,192,64,.5);transform:scale(1.06)}
.ri.Legendary.winner{animation:legwin .5s ease-in-out infinite alternate}
@keyframes legwin{from{box-shadow:0 0 20px rgba(240,192,64,.4)}to{box-shadow:0 0 50px rgba(240,192,64,.9)}}

/* RESULT */
#spin-result{margin-top:20px;text-align:center;opacity:0;transform:translateY(14px);
  transition:opacity .4s,transform .4s;pointer-events:none}
#spin-result.show{opacity:1;transform:translateY(0);pointer-events:all}
.res-badge{display:inline-block;font-family:'Cinzel',serif;font-size:10px;font-weight:700;
  padding:3px 14px;border-radius:16px;letter-spacing:.15em;text-transform:uppercase;margin-bottom:8px}
.res-badge.Common{background:rgba(155,155,155,.15);color:var(--c-common);border:1px solid rgba(155,155,155,.3)}
.res-badge.Uncommon{background:rgba(46,204,113,.12);color:var(--c-uncommon);border:1px solid rgba(46,204,113,.3)}
.res-badge.Rare{background:rgba(93,173,226,.12);color:var(--c-rare);border:1px solid rgba(93,173,226,.35)}
.res-badge.Epic{background:rgba(195,155,211,.12);color:var(--c-epic);border:1px solid rgba(195,155,211,.4);box-shadow:0 0 16px rgba(195,155,211,.2)}
.res-badge.Legendary{background:rgba(240,192,64,.12);color:var(--c-legendary);border:1px solid rgba(240,192,64,.5);box-shadow:0 0 24px rgba(240,192,64,.35)}
.res-name{font-family:'Cinzel',serif;font-size:20px;font-weight:700;color:var(--text);margin-bottom:3px}
.res-name.Legendary{color:var(--c-legendary);text-shadow:0 0 20px var(--gold-glow)}
.res-name.Epic{color:var(--c-epic)}.res-name.Rare{color:var(--c-rare)}
.res-val{font-size:13px;color:var(--text-dim);font-style:italic;margin-bottom:16px}
.res-val b{color:var(--gold);font-style:normal;font-family:'Cinzel',serif}
.res-btns{display:flex;gap:10px;justify-content:center}
.btn-keep{padding:12px 22px;background:linear-gradient(135deg,#8a6010,#f0c040,#8a6010);
  background-size:200%;background-position:100%;border:none;border-radius:12px;
  font-family:'Cinzel',serif;font-size:13px;font-weight:700;color:#1a1000;cursor:pointer;
  transition:all .3s;box-shadow:0 4px 18px rgba(240,192,64,.3)}
.btn-keep:active{background-position:0%;transform:scale(.96)}
.btn-sell-r{padding:12px 18px;background:rgba(255,255,255,.05);
  border:1px solid var(--border);border-radius:12px;font-family:'Cinzel',serif;
  font-size:13px;font-weight:600;color:var(--text-dim);cursor:pointer;transition:all .2s}
.btn-sell-r:active{transform:scale(.96)}

/* PARTICLES */
.pts{position:fixed;inset:0;pointer-events:none;z-index:300;overflow:hidden}
.pt{position:absolute;border-radius:50%;animation:ptfly 2s ease-out forwards;opacity:0}
@keyframes ptfly{0%{transform:translate(0,0) scale(0);opacity:1}100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0}}

/* INVENTORY */
.inv-top{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:6px}
.sbox{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
.sbox-lbl{font-size:9px;color:var(--text-dim);text-transform:uppercase;
  letter-spacing:.1em;font-family:'Cinzel',serif;margin-bottom:3px}
.sbox-val{font-family:'Cinzel',serif;font-size:17px;font-weight:700;color:var(--gold)}
.sell-all-btn{width:100%;padding:11px;background:rgba(192,57,43,.1);
  border:1px solid rgba(192,57,43,.25);border-radius:12px;font-family:'Cinzel',serif;
  font-size:11px;font-weight:600;color:#e74c3c;letter-spacing:.08em;text-transform:uppercase;
  cursor:pointer;transition:all .2s;margin-bottom:4px}
.sell-all-btn:active{background:rgba(192,57,43,.2);transform:scale(.98)}
.inv-item{display:flex;align-items:center;gap:10px;background:var(--panel);
  border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin-bottom:7px;
  cursor:pointer;transition:all .18s}
.inv-item:active{transform:scale(.98);background:rgba(240,192,64,.05)}
.inv-item.rL{border-color:rgba(240,192,64,.4);box-shadow:0 0 10px rgba(240,192,64,.07)}
.inv-item.rE{border-color:rgba(195,155,211,.35)}
.inv-item.rR{border-color:rgba(93,173,226,.3)}
.ii-em{font-size:26px;flex-shrink:0}
.ii-info{flex:1;min-width:0}
.ii-name{font-family:'Cinzel',serif;font-size:12px;font-weight:600;color:var(--text)}
.ii-rar{font-size:10px;margin-top:1px}
.ii-rar.Common{color:var(--c-common)}.ii-rar.Uncommon{color:var(--c-uncommon)}
.ii-rar.Rare{color:var(--c-rare)}.ii-rar.Epic{color:var(--c-epic)}.ii-rar.Legendary{color:var(--c-legendary)}
.ii-right{text-align:right;flex-shrink:0}
.ii-cnt{font-family:'Cinzel',serif;font-size:11px;color:var(--text-dim)}
.ii-val{font-family:'Cinzel',serif;font-size:13px;font-weight:600;color:var(--gold);margin-top:1px}

/* SELL MODAL */
#sell-modal{position:fixed;inset:0;z-index:400;background:rgba(0,0,0,.82);
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .28s}
#sell-modal.on{opacity:1;pointer-events:all}
.sell-sheet{width:100%;max-width:480px;background:var(--bg2);
  border:1px solid var(--border);border-bottom:none;border-radius:22px 22px 0 0;
  padding:22px 20px 30px;transform:translateY(100%);
  transition:transform .32s cubic-bezier(.32,.72,0,1)}
#sell-modal.on .sell-sheet{transform:translateY(0)}
.sell-handle{width:36px;height:3px;background:var(--border);border-radius:2px;margin:0 auto 16px}
.sell-hdr{display:flex;align-items:center;gap:14px;margin-bottom:16px}
.sell-em{font-size:46px}
.sell-nm{font-family:'Cinzel',serif;font-size:16px;font-weight:700;color:var(--text)}
.sell-sb{font-size:12px;color:var(--text-dim);margin-top:2px;font-style:italic}
.sell-opts{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.sopt{padding:13px 8px;border-radius:12px;background:rgba(240,192,64,.05);
  border:1px solid rgba(240,192,64,.18);text-align:center;cursor:pointer;transition:all .18s}
.sopt:active{background:rgba(240,192,64,.14);transform:scale(.96)}
.sopt.sopt-all{grid-column:1/-1;background:rgba(192,57,43,.08);border-color:rgba(192,57,43,.25)}
.sopt-cnt{font-family:'Cinzel',serif;font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px}
.sopt-g{font-size:11px;color:var(--gold)}
.sell-cancel{width:100%;margin-top:10px;padding:11px;background:transparent;
  border:1px solid var(--border);border-radius:12px;color:var(--text-dim);
  font-family:'Cinzel',serif;font-size:11px;cursor:pointer}

/* PROFILE */
.prof-hero{background:var(--panel);border:1px solid var(--border);
  border-radius:16px;padding:18px;margin-bottom:10px;text-align:center;
  position:relative;overflow:hidden}
.prof-hero::before{content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 50% 0%,rgba(240,192,64,.07),transparent 70%)}
.ph-av{font-size:50px;margin-bottom:6px;filter:drop-shadow(0 0 14px rgba(240,192,64,.35))}
.ph-nm{font-family:'Cinzel',serif;font-size:18px;font-weight:700;
  color:var(--gold);text-shadow:0 0 12px var(--gold-glow)}
.ph-sb{font-size:12px;color:var(--text-dim);margin-top:3px;font-style:italic}
.prof-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.pst{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
.pst-ic{font-size:18px;margin-bottom:4px}
.pst-v{font-family:'Cinzel',serif;font-size:18px;font-weight:700;color:var(--gold)}
.pst-l{font-size:10px;color:var(--text-dim);text-transform:uppercase;
  letter-spacing:.06em;font-family:'Cinzel',serif;margin-top:1px}
.ref-card{background:var(--panel);border:1px solid rgba(240,192,64,.28);
  border-radius:16px;padding:16px;margin-bottom:10px;position:relative;overflow:hidden}
.ref-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1.5px;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);opacity:.5}
.ref-title{font-family:'Cinzel',serif;font-size:12px;font-weight:700;color:var(--gold);margin-bottom:5px}
.ref-desc{font-size:12px;color:var(--text-dim);font-style:italic;margin-bottom:12px}
.ref-rew{display:flex;align-items:center;gap:8px;margin-bottom:12px;
  padding:9px 12px;background:rgba(240,192,64,.07);border-radius:10px;border:1px solid rgba(240,192,64,.18)}
.ref-rew-t{font-family:'Cinzel',serif;font-size:13px;font-weight:600;color:var(--gold)}
.ref-rew-s{font-size:11px;color:var(--text-dim)}
.ref-lbl{font-family:'Cinzel',serif;font-size:9px;color:var(--text-dim);
  text-transform:uppercase;letter-spacing:.1em;margin-bottom:3px}
.ref-link{background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:9px;
  padding:9px 12px;font-size:11px;color:var(--text-dim);font-family:monospace;
  word-break:break-all;margin-bottom:9px}
.ref-share{width:100%;padding:12px;
  background:linear-gradient(135deg,rgba(240,192,64,.12),rgba(240,192,64,.06));
  border:1px solid rgba(240,192,64,.3);border-radius:12px;font-family:'Cinzel',serif;
  font-size:12px;font-weight:700;color:var(--gold);cursor:pointer;transition:all .18s}
.ref-share:active{background:rgba(240,192,64,.18);transform:scale(.98)}
.ref-pers{display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:6px;
  background:var(--panel);border:1px solid var(--border);border-radius:12px}
.rp-nm{font-family:'Cinzel',serif;font-size:12px;color:var(--text);flex:1}
.rp-ts{font-size:10px;color:var(--text-dim)}
.rp-g{font-family:'Cinzel',serif;font-size:12px;font-weight:600;color:var(--gold)}

/* SETTINGS */
.set-card{background:var(--panel);border:1px solid var(--border);
  border-radius:16px;padding:16px;margin-bottom:10px}
.set-card-title{font-family:'Cinzel',serif;font-size:11px;font-weight:700;
  color:var(--gold);margin-bottom:12px;letter-spacing:.08em;text-transform:uppercase}
.set-row{display:flex;align-items:center;justify-content:space-between;
  padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.set-row:last-child{border-bottom:none;padding-bottom:0}
.set-lbl{font-family:'Cinzel',serif;font-size:13px;color:var(--text)}
.set-sub{font-size:11px;color:var(--text-dim);margin-top:2px;font-style:italic}
.lang-sw{display:flex;gap:4px}
.lang-btn{padding:4px 10px;border-radius:8px;font-family:'Cinzel',serif;font-size:11px;
  font-weight:600;cursor:pointer;transition:all .2s;border:1px solid var(--border);
  background:transparent;color:var(--text-dim)}
.lang-btn.on{background:rgba(240,192,64,.15);border-color:rgba(240,192,64,.4);color:var(--gold)}

/* TOAST */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(14px);
  z-index:500;background:rgba(14,10,8,.97);border:1px solid var(--border);
  border-radius:12px;padding:10px 18px;font-family:'Cinzel',serif;font-size:12px;
  color:var(--text);white-space:nowrap;opacity:0;pointer-events:none;transition:all .28s}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

.empty{text-align:center;padding:44px 20px}
.empty-ic{font-size:48px;margin-bottom:12px;opacity:.35}
.empty-t{font-family:'Cinzel',serif;font-size:13px;color:var(--text-dim);font-weight:600;margin-bottom:4px}
.empty-s{font-size:12px;color:var(--text-dim);opacity:.5;font-style:italic}
</style>
</head>
<body>
<canvas id="bgc"></canvas>
<div class="pts" id="pts"></div>

<div id="app">
  <header>
    <div>
      <div class="logo" id="logo-t">Treasure Chest</div>
      <div class="logo-sub" id="logo-s">–§—ç–Ω—Ç–µ–∑–∏–π–Ω–∞—è –ª—É—Ç-–∏–≥—Ä–∞</div>
    </div>
    <div class="gold-pill">
      <span class="gold-coin">ü™ô</span>
      <span id="gold-disp">‚Äî</span>
    </div>
  </header>

  <nav>
    <button class="nb active" onclick="showScr('chests')" id="nav-chests">
      <span class="ni">üóÉÔ∏è</span><span id="nl-chests">–ö–µ–π—Å—ã</span>
    </button>
    <button class="nb" onclick="showScr('inv')" id="nav-inv">
      <span class="ni">üéí</span><span id="nl-inv">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span>
    </button>
    <button class="nb" onclick="showScr('profile')" id="nav-profile">
      <span class="ni">üë§</span><span id="nl-profile">–ü—Ä–æ—Ñ–∏–ª—å</span>
    </button>
    <button class="nb" onclick="showScr('settings')" id="nav-settings">
      <span class="ni">‚öôÔ∏è</span><span id="nl-settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
    </button>
  </nav>

  <div id="screens">
    <!-- CHESTS -->
    <div class="screen active" id="screen-chests">
      <div class="sec-title" id="t-choose">–í—ã–±–µ—Ä–∏ –∫–µ–π—Å</div>
      <div class="chests-grid" id="chests-grid"></div>
    </div>

    <!-- INVENTORY -->
    <div class="screen" id="screen-inv">
      <div class="inv-top">
        <div class="sbox"><div class="sbox-lbl" id="t-items">–ü—Ä–µ–¥–º–µ—Ç—ã</div><div class="sbox-val" id="inv-count">‚Äî</div></div>
        <div class="sbox"><div class="sbox-lbl" id="t-tval">–û–±—â–∞—è —Ü–µ–Ω–∞</div><div class="sbox-val" id="inv-val">‚Äî</div></div>
      </div>
      <button class="sell-all-btn" onclick="sellAll()">üóëÔ∏è <span id="t-sellall">–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë</span></button>
      <div class="sec-title" id="t-youritems">–¢–≤–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</div>
      <div id="inv-list"></div>
    </div>

    <!-- PROFILE -->
    <div class="screen" id="screen-profile">
      <div class="prof-hero">
        <div class="ph-av">‚öîÔ∏è</div>
        <div class="ph-nm" id="prof-name">–ê–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç</div>
        <div class="ph-sb" id="t-hunter">–û—Ö–æ—Ç–Ω–∏–∫ –∑–∞ —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏</div>
      </div>
      <div class="prof-stats">
        <div class="pst"><div class="pst-ic">üì¶</div><div class="pst-v" id="s-chests">‚Äî</div><div class="pst-l" id="t-opened">–û—Ç–∫—Ä—ã—Ç–æ –∫–µ–π—Å–æ–≤</div></div>
        <div class="pst"><div class="pst-ic">üí∏</div><div class="pst-v" id="s-earned">‚Äî</div><div class="pst-l" id="t-sold">–ü—Ä–æ–¥–∞–Ω–æ –Ω–∞</div></div>
        <div class="pst"><div class="pst-ic">üë•</div><div class="pst-v" id="s-refs">‚Äî</div><div class="pst-l" id="t-refs">–†–µ—Ñ–µ—Ä–∞–ª—ã</div></div>
        <div class="pst"><div class="pst-ic">üíé</div><div class="pst-v" id="s-nw">‚Äî</div><div class="pst-l" id="t-nw">–ö–∞–ø–∏—Ç–∞–ª</div></div>
      </div>
      <div class="ref-card">
        <div class="ref-title">üë• <span id="t-refprog">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</span></div>
        <div class="ref-desc" id="t-refdesc">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π –∑–æ–ª–æ—Ç–æ –∑–∞ –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞!</div>
        <div class="ref-rew"><span style="font-size:18px">ü™ô</span>
          <div><div class="ref-rew-t">+500 <span id="t-perref">–∑–æ–ª–æ—Ç–∞ –∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞</span></div>
          <div class="ref-rew-s" id="t-instant">–ù–∞—á–∏—Å–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ –≤—Ö–æ–¥–µ</div></div>
        </div>
        <div class="ref-lbl" id="t-yourlink">–¢–≤–æ—è —Å—Å—ã–ª–∫–∞</div>
        <div class="ref-link" id="ref-link-box">‚Äî</div>
        <button class="ref-share" onclick="shareRef()">üîó <span id="t-sharelink">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π</span></button>
      </div>
      <div class="sec-title" id="t-yourrefs">–¢–≤–æ–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</div>
      <div id="ref-list"></div>
    </div>

    <!-- SETTINGS -->
    <div class="screen" id="screen-settings">
      <div class="set-card">
        <div class="set-card-title">üåê Language / –Ø–∑—ã–∫</div>
        <div class="set-row">
          <div><div class="set-lbl">Interface Language</div><div class="set-sub">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div></div>
          <div class="lang-sw">
            <button class="lang-btn" id="lb-en" onclick="setLang('en')">EN</button>
            <button class="lang-btn on" id="lb-ru" onclick="setLang('ru')">RU</button>
          </div>
        </div>
      </div>
      <div class="set-card">
        <div class="set-card-title" id="t-about">‚öîÔ∏è –û –∏–≥—Ä–µ</div>
        <div class="set-row">
          <div><div class="set-lbl">Treasure Chest v2.0</div>
          <div class="set-sub" id="t-aboutd">–§—ç–Ω—Ç–µ–∑–∏–π–Ω–∞—è –ª—É—Ç-–∏–≥—Ä–∞</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHEST DETAIL -->
  <div id="detail">
    <div class="det-hdr">
      <button class="back-btn" onclick="closeDetail()">‚Äπ</button>
      <div class="det-title" id="det-title">‚Äî</div>
    </div>
    <div class="det-hero">
      <div class="det-icon" id="det-icon">üì¶</div>
      <div class="det-name" id="det-name">‚Äî</div>
      <div class="det-desc" id="det-desc">‚Äî</div>
    </div>
    <div class="open-btns">
      <button class="obtn obtn-slow" id="obtn-slow" onclick="doOpen(false)">
        <span class="oi">‚è≥</span>
        <span id="t-openslow">–û—Ç–∫—Ä—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ</span>
        <div class="oc" id="cost-slow">‚Äî ü™ô</div>
      </button>
      <button class="obtn obtn-fast" id="obtn-fast" onclick="doOpen(true)">
        <span class="oi">‚ö°</span>
        <span id="t-openfast">–û—Ç–∫—Ä—ã—Ç—å –±—ã—Å—Ç—Ä–æ</span>
        <div class="oc" id="cost-fast">‚Äî ü™ô</div>
      </button>
    </div>
    <div class="sec-title" style="margin:14px 14px 8px" id="t-drops">–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã</div>
    <div class="drop-table" id="drop-table"></div>
  </div>
</div>

<!-- SPIN OVERLAY -->
<div id="spin-overlay">
  <div class="spin-chest" id="spin-chest">üì¶</div>
  <div class="spin-label" id="spin-label">–û—Ç–∫—Ä—ã–≤–∞–µ–º...</div>
  <div class="reel-wrap">
    <div class="reel-line"></div>
    <div class="reel-track" id="reel-track"></div>
  </div>
  <div id="spin-result">
    <div class="res-badge" id="res-badge">Common</div>
    <div class="res-name" id="res-name">‚Äî</div>
    <div class="res-val">–°—Ç–æ–∏–º–æ—Å—Ç—å: <b id="res-val">0</b>ü™ô</div>
    <div class="res-btns">
      <button class="btn-keep" onclick="keepItem()" id="btn-keep">–í –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
      <button class="btn-sell-r" onclick="sellNow()" id="btn-sell-r">–ü—Ä–æ–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- SELL MODAL -->
<div id="sell-modal" onclick="closeSellModal(event)">
  <div class="sell-sheet">
    <div class="sell-handle"></div>
    <div class="sell-hdr">
      <div class="sell-em" id="modal-em">üß™</div>
      <div><div class="sell-nm" id="modal-nm">‚Äî</div><div class="sell-sb" id="modal-sb">‚Äî</div></div>
    </div>
    <div class="sell-opts" id="sell-opts"></div>
    <button class="sell-cancel" onclick="closeSellModal()" id="t-cancel">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG ‚Äî –∑–∞–º–µ–Ω–∏ URL!
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_BASE     = "https://treasure-chest-bot.onrender.com";
const BOT_USERNAME = "plovinhogame_bot";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRANSLATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TR = {
  ru:{
    nav_chests:"–ö–µ–π—Å—ã",nav_inv:"–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å",nav_profile:"–ü—Ä–æ—Ñ–∏–ª—å",nav_settings:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
    choose:"–í—ã–±–µ—Ä–∏ –∫–µ–π—Å",items:"–ü—Ä–µ–¥–º–µ—Ç—ã",tval:"–û–±—â–∞—è —Ü–µ–Ω–∞",sellall:"–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë",
    youritems:"–¢–≤–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã",hunter:"–û—Ö–æ—Ç–Ω–∏–∫ –∑–∞ —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏",
    opened:"–û—Ç–∫—Ä—ã—Ç–æ –∫–µ–π—Å–æ–≤",sold:"–ü—Ä–æ–¥–∞–Ω–æ –Ω–∞",refs:"–†–µ—Ñ–µ—Ä–∞–ª—ã",nw:"–ö–∞–ø–∏—Ç–∞–ª",
    refprog:"–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞",
    refdesc:"–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π –∑–æ–ª–æ—Ç–æ –∑–∞ –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞!",
    perref:"–∑–æ–ª–æ—Ç–∞ –∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞",instant:"–ù–∞—á–∏—Å–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ –≤—Ö–æ–¥–µ",
    yourlink:"–¢–≤–æ—è —Å—Å—ã–ª–∫–∞",sharelink:"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π",yourrefs:"–¢–≤–æ–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã",
    about:"‚öîÔ∏è –û –∏–≥—Ä–µ",aboutd:"–§—ç–Ω—Ç–µ–∑–∏–π–Ω–∞—è –ª—É—Ç-–∏–≥—Ä–∞",
    openslow:"–û—Ç–∫—Ä—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ",openfast:"–û—Ç–∫—Ä—ã—Ç—å –±—ã—Å—Ç—Ä–æ",drops:"–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã",
    opening:"–û—Ç–∫—Ä—ã–≤–∞–µ–º...",keep:"–í –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å",sell_r:"–ü—Ä–æ–¥–∞—Ç—å",cancel:"–û—Ç–º–µ–Ω–∞",
    worth:"–°—Ç–æ–∏–º–æ—Å—Ç—å",
    no_gold:"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞!",
    added:"üéí –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!",
    sold_for:"üí∞ –ü—Ä–æ–¥–∞–Ω–æ –∑–∞",sold_all:"üí∞ –ü—Ä–æ–¥–∞–Ω–æ –≤—Å—ë –∑–∞",
    inv_empty:"üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç!",
    link_copied:"üîó –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!",
    no_refs_t:"–†–µ—Ñ–µ—Ä–∞–ª–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç",no_refs_s:"–ü–æ–¥–µ–ª–∏—Å—å —Å—Å—ã–ª–∫–æ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π 500ü™ô!",
    no_items_t:"–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç",no_items_s:"–û—Ç–∫—Ä–æ–π –∫–µ–π—Å—ã —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ª—É—Ç!",
    logo_sub:"–§—ç–Ω—Ç–µ–∑–∏–π–Ω–∞—è –ª—É—Ç-–∏–≥—Ä–∞",
  },
  en:{
    nav_chests:"Chests",nav_inv:"Inventory",nav_profile:"Profile",nav_settings:"Settings",
    choose:"Choose Your Chest",items:"Items",tval:"Total Value",sellall:"Sell Everything",
    youritems:"Your Items",hunter:"Treasure Hunter",
    opened:"Chests Opened",sold:"Total Sold",refs:"Referrals",nw:"Net Worth",
    refprog:"Referral Program",
    refdesc:"Invite friends and earn gold for each adventurer who joins!",
    perref:"Gold per referral",instant:"Paid instantly when they join",
    yourlink:"Your Link",sharelink:"Share Referral Link",yourrefs:"Your Referrals",
    about:"‚öîÔ∏è About",aboutd:"Fantasy loot game",
    openslow:"Open Slowly",openfast:"Open Fast",drops:"Possible Drops",
    opening:"Opening...",keep:"Keep It",sell_r:"Sell Now",cancel:"Cancel",
    worth:"Worth",
    no_gold:"‚ùå Not enough gold!",
    added:"üéí Added to inventory!",
    sold_for:"üí∞ Sold for",sold_all:"üí∞ Sold everything for",
    inv_empty:"üéí Inventory is empty!",
    link_copied:"üîó Link copied!",
    no_refs_t:"No Referrals Yet",no_refs_s:"Share your link to earn 500ü™ô!",
    no_items_t:"Inventory Empty",no_items_s:"Open some chests to find loot!",
    logo_sub:"Fantasy Loot Game",
  }
};
let LANG = localStorage.getItem("lang")||"ru";
const t = k => TR[LANG][k]||TR.en[k]||k;

function applyLang(){
  const m={
    "nl-chests":"nav_chests","nl-inv":"nav_inv","nl-profile":"nav_profile","nl-settings":"nav_settings",
    "t-choose":"choose","t-items":"items","t-tval":"tval","t-sellall":"sellall",
    "t-youritems":"youritems","t-hunter":"hunter","t-opened":"opened","t-sold":"sold",
    "t-refs":"refs","t-nw":"nw","t-refprog":"refprog","t-refdesc":"refdesc",
    "t-perref":"perref","t-instant":"instant","t-yourlink":"yourlink","t-sharelink":"sharelink",
    "t-yourrefs":"yourrefs","t-about":"about","t-aboutd":"aboutd",
    "t-openslow":"openslow","t-openfast":"openfast","t-drops":"drops",
    "spin-label":"opening","btn-keep":"keep","btn-sell-r":"sell_r","t-cancel":"cancel",
    "logo-s":"logo_sub",
  };
  Object.entries(m).forEach(([id,key])=>{
    const el=document.getElementById(id);
    if(el) el.textContent=t(key);
  });
  document.getElementById("lb-en").classList.toggle("on",LANG==="en");
  document.getElementById("lb-ru").classList.toggle("on",LANG==="ru");
  renderChests();
  if(document.getElementById("screen-inv").classList.contains("active")) renderInv();
  if(document.getElementById("screen-profile").classList.contains("active")) renderProfile();
}
function setLang(l){
  LANG=l; localStorage.setItem("lang",l); applyLang();
  showToast(l==="ru"?"üåê –†—É—Å—Å–∫–∏–π —è–∑—ã–∫ –≤–∫–ª—é—á—ë–Ω":"üåê English language set");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CHESTS = [
  {key:"wooden",icon:"ü™µ",tier:"t1",cost:30,
   name:"Wooden Chest",
   desc_ru:"–ü–æ—Ç—Ä—ë–ø–∞–Ω–Ω—ã–π –¥–µ—Ä–µ–≤—è–Ω–Ω—ã–π —Å—É–Ω–¥—É–∫. –î—ë—à–µ–≤–æ –∏ —Å–µ—Ä–¥–∏—Ç–æ!",
   desc_en:"A battered chest. Cheap thrills for the brave!",
   badge_ru:"‚ö™ –°—Ç–∞—Ä—Ç–æ–≤—ã–π",badge_en:"‚ö™ Starter",
   bc:"rgba(150,150,150,.18)",bt:"#aaa"},
  {key:"bone",icon:"ü¶¥",tier:"t2",cost:60,
   name:"Bone Chest",
   desc_ru:"–°–¥–µ–ª–∞–Ω –∏–∑ –¥—Ä–µ–≤–Ω–∏—Ö –∫–æ—Å—Ç–µ–π. –ñ–¥–∏ –Ω–µ–æ–±—ã—á–Ω—ã—Ö –Ω–∞—Ö–æ–¥–æ–∫!",
   desc_en:"Crafted from ancient bones. Uncommon finds await!",
   badge_ru:"üü¢ –ù–µ–æ–±—ã—á–Ω—ã–π",badge_en:"üü¢ Uncommon",
   bc:"rgba(46,204,113,.18)",bt:"#2ecc71"},
  {key:"silver",icon:"ü•à",tier:"t3",cost:100,
   name:"Silver Chest",
   desc_ru:"–ù–∞—á–∏—â–µ–Ω–Ω—ã–π —Å–µ—Ä–µ–±—Ä—è–Ω—ã–π —Å—É–Ω–¥—É–∫. –ë–æ–ª—å—à–µ —à–∞–Ω—Å–æ–≤ –Ω–∞ —Ä–µ–¥–∫–∏–π –ª—É—Ç.",
   desc_en:"A polished silver chest. Better odds for rare loot.",
   badge_ru:"üîµ –†–µ–¥–∫–∏–π+",badge_en:"üîµ Rare+",
   bc:"rgba(93,173,226,.18)",bt:"#5dade2"},
  {key:"shadow",icon:"üåë",tier:"t4",cost:200,
   name:"Shadow Chest",
   desc_ru:"–ò–∑ –ø—É—Å—Ç–æ—Ç—ã. –ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —à–∞–Ω—Å –Ω–∞ –≠–ø–∏–∫ –∏ –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ!",
   desc_en:"From the void. Epic and Legendary chances boosted!",
   badge_ru:"üü£ –≠–ø–∏–∫+",badge_en:"üü£ Epic+",
   bc:"rgba(195,155,211,.18)",bt:"#c39bd3"},
  {key:"dragon",icon:"üêâ",tier:"t5",cost:500,
   name:"Dragon Chest",
   desc_ru:"–í—ã–∫–æ–≤–∞–Ω –≤ –æ–≥–Ω–µ –¥—Ä–∞–∫–æ–Ω–∞. –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ª—É—Ç —Å–æ–≤—Å–µ–º –±–ª–∏–∑–∫–æ!",
   desc_en:"Forged in dragon fire. Legendary loot is close!",
   badge_ru:"üî¥ –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π",badge_en:"üî¥ Legendary",
   bc:"rgba(231,76,60,.18)",bt:"#e74c3c"},
  {key:"golden",icon:"‚ú®",tier:"t6",cost:1000,
   name:"Golden Chest",
   desc_ru:"–í–µ—Ä—à–∏–Ω–∞ —Å–æ–∫—Ä–æ–≤–∏—â. –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã!",
   desc_en:"The pinnacle of treasure. Legendary almost guaranteed!",
   badge_ru:"üåü –ú–∏—Ñ–∏—á–µ—Å–∫–∏–π",badge_en:"üåü Mythic",
   bc:"rgba(255,215,0,.22)",bt:"#ffd700"},
];

const CHEST_ODDS = {
  wooden:[50,30,15,4,1],
  bone:  [30,40,22,6,2],
  silver:[20,30,32,12,6],
  shadow:[10,20,30,28,12],
  dragon:[5,10,20,30,35],
  golden:[0,5,10,25,60],
};

const ITEMS = {
  health_potion:  {name:"Health Potion",  emoji:"üß™",rarity:"Common",   value:10},
  wooden_sword:   {name:"Wooden Sword",   emoji:"üó°Ô∏è", rarity:"Common",   value:15},
  leather_boots:  {name:"Leather Boots",  emoji:"üë¢",rarity:"Common",   value:12},
  bread_loaf:     {name:"Bread Loaf",     emoji:"üçû",rarity:"Common",   value:5},
  iron_shield:    {name:"Iron Shield",    emoji:"üõ°Ô∏è", rarity:"Common",   value:20},
  mana_potion:    {name:"Mana Potion",    emoji:"üíô",rarity:"Uncommon", value:35},
  silver_dagger:  {name:"Silver Dagger",  emoji:"üî™",rarity:"Uncommon", value:50},
  chain_armor:    {name:"Chain Armor",    emoji:"‚õìÔ∏è", rarity:"Uncommon", value:60},
  magic_scroll:   {name:"Magic Scroll",   emoji:"üìú",rarity:"Uncommon", value:45},
  enchanted_ring: {name:"Enchanted Ring", emoji:"üíç",rarity:"Uncommon", value:55},
  elven_bow:      {name:"Elven Bow",      emoji:"üèπ",rarity:"Rare",     value:150},
  fire_staff:     {name:"Fire Staff",     emoji:"üî•",rarity:"Rare",     value:180},
  dragon_scale:   {name:"Dragon Scale",   emoji:"üêâ",rarity:"Rare",     value:200},
  crystal_amulet: {name:"Crystal Amulet", emoji:"üîÆ",rarity:"Rare",     value:160},
  thunder_axe:    {name:"Thunder Axe",    emoji:"‚ö°",rarity:"Epic",     value:500},
  void_cloak:     {name:"Void Cloak",     emoji:"üåë",rarity:"Epic",     value:550},
  phoenix_feather:{name:"Phoenix Feather",emoji:"ü¶Ö",rarity:"Epic",     value:480},
  excalibur:      {name:"Excalibur",      emoji:"‚öîÔ∏è", rarity:"Legendary",value:2000},
  crown_of_gods:  {name:"Crown of Gods",  emoji:"üëë",rarity:"Legendary",value:2500},
  chaos_orb:      {name:"Chaos Orb",      emoji:"üåÄ",rarity:"Legendary",value:1800},
};
const IKEYS = Object.keys(ITEMS);
const RORD  = ["Common","Uncommon","Rare","Epic","Legendary"];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let S = {gold:0,inventory:{},chests_opened:0,total_earned:0,referrals:[],first_name:""};
let pendingItem  = null;
let modalItem    = null;
let spinning     = false;
let curChest     = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TELEGRAM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const tg = window.Telegram?.WebApp;
if(tg){tg.ready();tg.expand();}
const initData = tg?.initData||"";
function apiH(){
  const h={"Content-Type":"application/json"};
  if(initData) h["X-Telegram-Init-Data"]=initData;
  else if(tg?.initDataUnsafe?.user?.id) h["X-User-Id"]=String(tg.initDataUnsafe.user.id);
  return h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function api(path,opts={}){
  const r=await fetch(API_BASE+path,{headers:apiH(),...opts});
  if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.detail||"Error");}
  return r.json();
}
async function loadPlayer(){
  const d=await api("/api/player");
  S={...S,...d}; updateGold();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BG CANVAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(()=>{
  const c=document.getElementById("bgc"),ctx=c.getContext("2d"),stars=[];
  function resize(){c.width=innerWidth;c.height=innerHeight;}
  resize();window.addEventListener("resize",resize);
  for(let i=0;i<100;i++) stars.push({x:Math.random(),y:Math.random(),
    r:Math.random()*1.2+.3,a:Math.random(),da:(Math.random()-.5)*.007});
  (function draw(){
    ctx.clearRect(0,0,c.width,c.height);
    stars.forEach(s=>{
      s.a=Math.max(.1,Math.min(1,s.a+s.da));
      if(s.a<=.1||s.a>=1)s.da*=-1;
      ctx.globalAlpha=s.a*.65;ctx.fillStyle="#f0d878";
      ctx.beginPath();ctx.arc(s.x*c.width,s.y*c.height,s.r,0,Math.PI*2);ctx.fill();
    });
    ctx.globalAlpha=1;requestAnimationFrame(draw);
  })();
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHEST LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderChests(){
  const g=document.getElementById("chests-grid");
  g.innerHTML=CHESTS.map(ch=>{
    const badge=LANG==="ru"?ch.badge_ru:ch.badge_en;
    const desc =LANG==="ru"?ch.desc_ru:ch.desc_en;
    const can  =S.gold>=ch.cost;
    return `<div class="chest-card ${ch.tier}${can?"":" locked"}" onclick="openDetail('${ch.key}')">
      <div class="chest-art">${ch.icon}</div>
      <div class="chest-info">
        <div class="chest-name">${ch.name}</div>
        <div class="chest-tier" style="background:${ch.bc};color:${ch.bt};border:1px solid ${ch.bt}44">${badge}</div>
        <div class="chest-desc">${desc}</div>
        <div class="chest-cost-row">
          <span class="chest-cost-num">${ch.cost}</span>
          <span class="chest-cost-lbl">ü™ô gold</span>
        </div>
      </div>
    </div>`;
  }).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHEST DETAIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDetail(key){
  curChest=CHESTS.find(c=>c.key===key);
  if(!curChest)return;
  document.getElementById("det-title").textContent=curChest.name;
  document.getElementById("det-icon").textContent=curChest.icon;
  document.getElementById("det-name").textContent=curChest.name;
  document.getElementById("det-desc").textContent=LANG==="ru"?curChest.desc_ru:curChest.desc_en;
  document.getElementById("cost-slow").textContent=curChest.cost+" ü™ô";
  document.getElementById("cost-fast").textContent=curChest.cost+" ü™ô";
  document.getElementById("t-openslow").textContent=t("openslow");
  document.getElementById("t-openfast").textContent=t("openfast");

  // build drop table
  const odds=CHEST_ODDS[key];
  const total=odds.reduce((a,b)=>a+b,0);
  const byRar={};
  IKEYS.forEach(k=>{const r=ITEMS[k].rarity;(byRar[r]=byRar[r]||[]).push(k);});
  let html="";
  RORD.forEach((rar,ri)=>{
    if(!byRar[rar]||!odds[ri])return;
    byRar[rar].forEach(k=>{
      const it=ITEMS[k];
      const pct=(odds[ri]/byRar[rar].length/total*100).toFixed(1);
      html+=`<div class="drop-row">
        <div class="drop-em">${it.emoji}</div>
        <div class="drop-info">
          <div class="drop-name ${rar}">${it.name}</div>
          <div class="drop-sub">${it.value}ü™ô ¬∑ ${rar}</div>
        </div>
        <div class="drop-pct ${rar}">${pct}%</div>
      </div>`;
    });
  });
  document.getElementById("drop-table").innerHTML=html;
  document.getElementById("detail").classList.add("open");
  if(tg?.HapticFeedback)tg.HapticFeedback.impactOccurred("light");
}
function closeDetail(){
  document.getElementById("detail").classList.remove("open");
  curChest=null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OPEN CHEST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doOpen(fast){
  if(!curChest||spinning)return;
  if(S.gold<curChest.cost){showToast(t("no_gold"));return;}

  spinning=true;
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
  document.getElementById("obtn-slow").disabled=true;
  document.getElementById("obtn-fast").disabled=true;

  // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å—É–Ω–¥—É–∫ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
  const chest=curChest;
  closeDetail();

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
  const ov=document.getElementById("spin-overlay");
  document.getElementById("spin-result").classList.remove("show");
  document.getElementById("spin-result").style.pointerEvents="none";
  const sc=document.getElementById("spin-chest");
  sc.textContent=chest.icon;
  sc.className="spin-chest shake"+(fast?" fast":"");
  document.getElementById("spin-label").textContent=t("opening");
  ov.classList.add("on");

  try{
    // –ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
    const result=await api("/api/open_chest",{
      method:"POST",
      body:JSON.stringify({chest_type:chest.key}),
    });

    S.gold=result.gold;
    S.inventory[result.item_key]=(S.inventory[result.item_key]||0)+1;
    pendingItem=result.item_key;
    updateGold();

    // –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    const dur=fast?1600:4200;
    await runReel(result.item_key,dur);

  }catch(e){
    // –û—à–∏–±–∫–∞ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
    ov.classList.remove("on");
    spinning=false;
    document.getElementById("obtn-slow").disabled=false;
    document.getElementById("obtn-fast").disabled=false;
    showToast("‚ùå "+e.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REEL ANIMATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const IW=105; // —à–∏—Ä–∏–Ω–∞ item + gap

function buildReel(winKey){
  const track=document.getElementById("reel-track");
  track.innerHTML="";
  const total=60,winPos=46;
  for(let i=0;i<total;i++){
    const key=i===winPos?winKey:randItem();
    const item=ITEMS[key];
    const el=document.createElement("div");
    el.className=`ri ${item.rarity}`;
    if(i===winPos)el.id="reel-winner";
    el.innerHTML=`<div class="ri-em">${item.emoji}</div>
      <div class="ri-nm">${item.name}</div>
      <div class="ri-rar ${item.rarity}">${item.rarity}</div>`;
    track.appendChild(el);
  }
  return winPos;
}

function randItem(){
  const w={Common:50,Uncommon:30,Rare:15,Epic:4,Legendary:1};
  const pool=[];
  IKEYS.forEach(k=>{for(let i=0;i<(w[ITEMS[k].rarity]||1);i++)pool.push(k);});
  return pool[Math.floor(Math.random()*pool.length)];
}

function runReel(winKey,dur){
  return new Promise(resolve=>{
    const track=document.getElementById("reel-track");
    // –°–±—Ä–æ—Å –ø–æ–∑–∏—Ü–∏–∏
    track.style.transition="none";
    track.style.transform="translateX(200px)";

    const ww=document.querySelector(".reel-wrap").offsetWidth;
    const winPos=buildReel(winKey);
    const targetX=-(winPos*IW)+(ww/2)-(IW/2);
    const jitter=(Math.random()-.5)*18;
    const finalX=targetX+jitter;
    const startX=200;
    const t0=performance.now();
    let hapticDone=false;

    function ease(p){return 1-Math.pow(1-p,4);}

    function step(now){
      const p=Math.min((now-t0)/dur,1);
      const ep=ease(p);
      track.style.transform=`translateX(${startX+(finalX-startX)*ep}px)`;

      if(p>0.73&&!hapticDone){
        hapticDone=true;
        if(tg?.HapticFeedback)tg.HapticFeedback.impactOccurred("medium");
      }

      if(p<1){requestAnimationFrame(step);}
      else{
        track.style.transform=`translateX(${targetX}px)`;
        const w=document.getElementById("reel-winner");
        if(w)w.classList.add("winner");
        setTimeout(()=>showResult(ITEMS[winKey]),400);
        resolve();
      }
    }
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã DOM –æ–±–Ω–æ–≤–∏–ª—Å—è
    requestAnimationFrame(()=>requestAnimationFrame(step));
  });
}

function showResult(item){
  // –°—Ç–æ–ø –∞–Ω–∏–º–∞—Ü–∏—è —Å—É–Ω–¥—É–∫–∞
  document.getElementById("spin-chest").className="spin-chest";
  document.getElementById("spin-label").style.display="none";

  // –•–∞–ø—Ç–∏–∫
  if(tg?.HapticFeedback){
    const h={Common:"light",Uncommon:"medium",Rare:"medium",Epic:"heavy",Legendary:"heavy"};
    tg.HapticFeedback.impactOccurred(h[item.rarity]||"light");
    if(item.rarity==="Legendary")setTimeout(()=>tg.HapticFeedback.notificationOccurred("success"),200);
  }

  // –ß–∞—Å—Ç–∏—Ü—ã
  if(["Epic","Legendary"].includes(item.rarity))spawnPts(item.rarity);

  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  document.getElementById("res-badge").textContent=item.rarity;
  document.getElementById("res-badge").className="res-badge "+item.rarity;
  document.getElementById("res-name").textContent=item.name;
  document.getElementById("res-name").className="res-name "+item.rarity;
  document.getElementById("res-val").textContent=item.value;
  document.getElementById("btn-keep").textContent=t("keep");
  document.getElementById("btn-sell-r").textContent=t("sell_r");

  const rv=document.getElementById("spin-result");
  rv.style.pointerEvents="all";
  rv.classList.add("show");
}

function keepItem(){
  document.getElementById("spin-overlay").classList.remove("on");
  document.getElementById("spin-label").style.display="";
  document.getElementById("pts").innerHTML="";
  pendingItem=null; spinning=false;
  document.getElementById("obtn-slow").disabled=false;
  document.getElementById("obtn-fast").disabled=false;
  showToast(t("added"));
}

async function sellNow(){
  if(!pendingItem)return;
  try{
    const d=await api("/api/sell",{method:"POST",body:JSON.stringify({item_key:pendingItem,quantity:1})});
    S.gold=d.gold;
    S.inventory[pendingItem]=(S.inventory[pendingItem]||1)-1;
    if(S.inventory[pendingItem]<=0)delete S.inventory[pendingItem];
    updateGold();
    showToast(`${t("sold_for")} ${d.earnings}ü™ô!`);
  }catch(e){}
  document.getElementById("spin-overlay").classList.remove("on");
  document.getElementById("spin-label").style.display="";
  document.getElementById("pts").innerHTML="";
  pendingItem=null; spinning=false;
  document.getElementById("obtn-slow").disabled=false;
  document.getElementById("obtn-fast").disabled=false;
}

function spawnPts(rarity){
  const pc=document.getElementById("pts");
  pc.innerHTML="";
  const col={Epic:"#c39bd3",Legendary:"#f0c040"}[rarity];
  const n=rarity==="Legendary"?55:25;
  for(let i=0;i<n;i++){
    const p=document.createElement("div");
    p.className="pt";
    const sz=Math.random()*9+4;
    p.style.cssText=`width:${sz}px;height:${sz}px;background:${col};
      left:${20+Math.random()*60}%;top:${25+Math.random()*35}%;
      --tx:${(Math.random()-.5)*420}px;--ty:${(Math.random()-.5)*520}px;
      animation-delay:${Math.random()*.45}s;animation-duration:${Math.random()*1.2+1}s`;
    pc.appendChild(p);
  }
  setTimeout(()=>pc.innerHTML="",2800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateGold(){
  const el=document.getElementById("gold-disp");
  el.style.transform="scale(1.18)";el.style.color="#fff";
  el.textContent=S.gold;
  setTimeout(()=>{el.style.transform="";el.style.color=""},320);
  renderChests();
}

function showScr(name){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll(".nb").forEach(b=>b.classList.remove("active"));
  document.getElementById("screen-"+name).classList.add("active");
  document.getElementById("nav-"+name).classList.add("active");
  if(name==="inv")     renderInv();
  if(name==="profile") renderProfile();
}

function renderInv(){
  const items=Object.entries(S.inventory).filter(([,v])=>v>0);
  const cnt=items.reduce((a,[,v])=>a+v,0);
  const val=items.reduce((a,[k,v])=>a+(ITEMS[k]?.value||0)*v,0);
  document.getElementById("inv-count").textContent=cnt;
  document.getElementById("inv-val").textContent=val+"ü™ô";
  const sorted=[...items].sort((a,b)=>RORD.indexOf(ITEMS[b[0]]?.rarity)-RORD.indexOf(ITEMS[a[0]]?.rarity));
  const list=document.getElementById("inv-list");
  if(!sorted.length){
    list.innerHTML=`<div class="empty"><div class="empty-ic">üéí</div>
      <div class="empty-t">${t("no_items_t")}</div>
      <div class="empty-s">${t("no_items_s")}</div></div>`;
    return;
  }
  const rc={Legendary:"rL",Epic:"rE",Rare:"rR"};
  list.innerHTML=sorted.map(([key,cnt])=>{
    const it=ITEMS[key]||{};
    return `<div class="inv-item ${rc[it.rarity]||""}" onclick="openSellModal('${key}')">
      <div class="ii-em">${it.emoji||"üì¶"}</div>
      <div class="ii-info">
        <div class="ii-name">${it.name||key}</div>
        <div class="ii-rar ${it.rarity}">‚¨• ${it.rarity}</div>
      </div>
      <div class="ii-right">
        <div class="ii-cnt">√ó${cnt}</div>
        <div class="ii-val">${(it.value||0)*cnt}ü™ô</div>
      </div>
    </div>`;
  }).join("");
}

function renderProfile(){
  document.getElementById("prof-name").textContent=S.first_name||"–ê–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç";
  document.getElementById("s-chests").textContent=S.chests_opened;
  document.getElementById("s-earned").textContent=S.total_earned+"ü™ô";
  document.getElementById("s-refs").textContent=S.referrals.length;
  const iv=Object.entries(S.inventory).reduce((a,[k,v])=>a+(ITEMS[k]?.value||0)*v,0);
  document.getElementById("s-nw").textContent=(S.gold+iv)+"ü™ô";
  const uid=tg?.initDataUnsafe?.user?.id||"demo";
  document.getElementById("ref-link-box").textContent=`https://t.me/${BOT_USERNAME}?start=ref_${uid}`;
  const rl=document.getElementById("ref-list");
  if(!S.referrals.length){
    rl.innerHTML=`<div class="empty"><div class="empty-ic">üë•</div>
      <div class="empty-t">${t("no_refs_t")}</div>
      <div class="empty-s">${t("no_refs_s")}</div></div>`;
  }else{
    rl.innerHTML=S.referrals.map(r=>`<div class="ref-pers">
      <span style="font-size:22px">üë§</span>
      <span class="rp-nm">${r.name}</span>
      <span class="rp-ts">${r.ts}</span>
      <span class="rp-g">+500ü™ô</span>
    </div>`).join("");
  }
}

// SELL MODAL
function openSellModal(key){
  modalItem=key;
  const it=ITEMS[key],cnt=S.inventory[key]||0;
  document.getElementById("modal-em").textContent=it.emoji;
  document.getElementById("modal-nm").textContent=it.name;
  document.getElementById("modal-sb").textContent=`${it.rarity} ¬∑ ${it.value}ü™ô each`;
  let html="";
  const opt=(lbl,qty,gold,cls="")=>
    html+=`<div class="sopt ${cls}" onclick="execSell(${qty})">
      <div class="sopt-cnt">${lbl}</div><div class="sopt-g">${gold}ü™ô</div></div>`;
  opt("√ó1",1,it.value);
  if(cnt>=5) opt("√ó5",5,it.value*5);
  if(cnt>=10)opt("√ó10",10,it.value*10);
  if(cnt>1)  opt(`${t("sellall")} (√ó${cnt})`,-1,it.value*cnt,"sopt-all");
  document.getElementById("sell-opts").innerHTML=html;
  document.getElementById("t-cancel").textContent=t("cancel");
  document.getElementById("sell-modal").classList.add("on");
}
function closeSellModal(e){
  if(e&&e.target!==document.getElementById("sell-modal"))return;
  document.getElementById("sell-modal").classList.remove("on");
  modalItem=null;
}
async function execSell(qty){
  if(!modalItem)return;
  try{
    const d=await api("/api/sell",{method:"POST",body:JSON.stringify({item_key:modalItem,quantity:qty})});
    S.gold=d.gold;
    S.inventory[modalItem]=(S.inventory[modalItem]||0)-d.sold;
    if(S.inventory[modalItem]<=0)delete S.inventory[modalItem];
    updateGold();renderInv();
    showToast(`${t("sold_for")} ${d.earnings}ü™ô!`);
  }catch(e){}
  document.getElementById("sell-modal").classList.remove("on");
  modalItem=null;
}
async function sellAll(){
  const items=Object.entries(S.inventory).filter(([,v])=>v>0);
  if(!items.length){showToast(t("inv_empty"));return;}
  try{
    const d=await api("/api/sell_all",{method:"POST"});
    S.gold=d.gold;S.inventory={};
    updateGold();renderInv();
    showToast(`${t("sold_all")} ${d.earnings}ü™ô!`);
  }catch(e){}
}

function shareRef(){
  const uid=tg?.initDataUnsafe?.user?.id||"demo";
  const link=`https://t.me/${BOT_USERNAME}?start=ref_${uid}`;
  const txt=LANG==="ru"
    ?"‚öîÔ∏è –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ Treasure Chest ‚Äî —Ñ—ç–Ω—Ç–µ–∑–∏–π–Ω–∞—è –ª—É—Ç-–∏–≥—Ä–∞!"
    :"‚öîÔ∏è Join me in Treasure Chest ‚Äî a fantasy loot game!";
  if(tg?.openTelegramLink)tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(txt)}`);
  else if(navigator.share)navigator.share({url:link,text:txt});
  else{navigator.clipboard?.writeText(link);showToast(t("link_copied"));}
}

let toastTmr;
function showToast(msg){
  const el=document.getElementById("toast");
  el.textContent=msg;el.classList.add("show");
  clearTimeout(toastTmr);
  toastTmr=setTimeout(()=>el.classList.remove("show"),2400);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async()=>{
  applyLang();
  renderChests();
  try{
    await loadPlayer();
    renderChests();
  }catch(e){
    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:",e.message);
    showToast("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
  }
})();
</script>
</body>
</html>
