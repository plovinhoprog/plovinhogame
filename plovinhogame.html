<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Treasure Chest</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600;700&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    --gold:#f0c040; --gold-dim:#a07820; --gold-glow:rgba(240,192,64,0.35);
    --bg:#0a0806; --bg2:#110e09; --panel:rgba(26,21,16,0.92);
    --border:rgba(240,192,64,0.18); --text:#e8d8b0; --text-dim:#8a7855;
  }
  * { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
  html,body { height:100%; width:100%; background:var(--bg); color:var(--text);
    font-family:'EB Garamond',serif; overflow:hidden; user-select:none; }

  #stars { position:fixed; inset:0; z-index:0;
    background:radial-gradient(ellipse at 20% 50%,rgba(120,80,20,.12) 0%,transparent 60%),
               radial-gradient(ellipse at 80% 20%,rgba(60,20,10,.15) 0%,transparent 50%),#0a0806; }
  #stars::before,#stars::after { content:''; position:absolute; inset:0;
    background-image:
      radial-gradient(1px 1px at 10% 15%,rgba(255,220,120,.6) 0%,transparent 100%),
      radial-gradient(1px 1px at 70% 10%,rgba(255,240,180,.7) 0%,transparent 100%),
      radial-gradient(1.5px 1.5px at 30% 90%,rgba(255,240,180,.6) 0%,transparent 100%),
      radial-gradient(1px 1px at 85% 60%,rgba(255,210,100,.5) 0%,transparent 100%),
      radial-gradient(1px 1px at 55% 25%,rgba(255,240,180,.5) 0%,transparent 100%);
    animation:twinkle 4s ease-in-out infinite alternate; }
  #stars::after { animation-delay:2s; animation-duration:5s; }
  @keyframes twinkle { 0%{opacity:.6}100%{opacity:1} }

  #app { position:relative; z-index:1; height:100vh; width:100%;
    display:flex; flex-direction:column; overflow:hidden; }

  header { flex-shrink:0; padding:14px 18px 10px;
    background:linear-gradient(180deg,rgba(10,8,6,.98) 0%,transparent 100%);
    display:flex; align-items:center; justify-content:space-between; }
  .logo { font-family:'Cinzel Decorative',serif; font-size:15px; font-weight:700;
    color:var(--gold); text-shadow:0 0 20px var(--gold-glow); }
  .logo span { color:var(--text-dim); font-size:11px; display:block;
    font-family:'EB Garamond',serif; text-transform:uppercase; margin-top:1px; }
  .gold-display { display:flex; align-items:center; gap:6px;
    background:rgba(240,192,64,.08); border:1px solid rgba(240,192,64,.25);
    border-radius:20px; padding:6px 14px; }
  .gold-coin { font-size:16px; animation:spin3d 3s linear infinite; }
  @keyframes spin3d { 0%,45%{transform:rotateY(0)} 50%{transform:rotateY(90deg)} 55%,100%{transform:rotateY(0)} }
  .gold-amount { font-family:'Cinzel',serif; font-size:15px; font-weight:600;
    color:var(--gold); text-shadow:0 0 10px var(--gold-glow); min-width:50px;
    text-align:right; transition:all .4s; }

  nav { flex-shrink:0; display:flex; gap:4px; padding:0 14px 10px; }
  .nav-btn { flex:1; padding:8px 4px; background:transparent; border:1px solid transparent;
    border-radius:10px; color:var(--text-dim); font-family:'Cinzel',serif; font-size:10px;
    font-weight:600; letter-spacing:.05em; text-transform:uppercase; cursor:pointer;
    transition:all .25s; display:flex; flex-direction:column; align-items:center; gap:3px; }
  .nav-btn .nav-icon { font-size:18px; }
  .nav-btn.active { background:rgba(240,192,64,.1); border-color:rgba(240,192,64,.35);
    color:var(--gold); text-shadow:0 0 8px var(--gold-glow); }
  .nav-btn:active { transform:scale(.95); }

  #screens { flex:1; overflow:hidden; position:relative; }
  .screen { position:absolute; inset:0; overflow-y:auto; overflow-x:hidden;
    padding:0 14px 20px; opacity:0; transform:translateY(16px);
    pointer-events:none; transition:opacity .3s,transform .3s; }
  .screen.active { opacity:1; transform:translateY(0); pointer-events:all; }
  .screen::-webkit-scrollbar { width:3px; }
  .screen::-webkit-scrollbar-thumb { background:var(--gold-dim); border-radius:3px; }

  .section-title { font-family:'Cinzel',serif; font-size:11px; font-weight:600;
    letter-spacing:.2em; text-transform:uppercase; color:var(--text-dim);
    margin:16px 0 10px; display:flex; align-items:center; gap:10px; }
  .section-title::after { content:''; flex:1; height:1px;
    background:linear-gradient(90deg,var(--border),transparent); }

  /* Loading */
  .loading-wrap { display:flex; flex-direction:column; align-items:center;
    justify-content:center; height:200px; gap:12px; }
  .spinner { width:36px; height:36px; border:3px solid rgba(240,192,64,.2);
    border-top-color:var(--gold); border-radius:50%; animation:spin .8s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loading-text { font-family:'Cinzel',serif; font-size:12px; color:var(--text-dim);
    letter-spacing:.2em; text-transform:uppercase; }

  /* Chests */
  .chest-grid { display:grid; grid-template-columns:1fr; gap:12px; padding-top:4px; }
  .chest-card { position:relative; overflow:hidden; border:1px solid var(--border);
    border-radius:16px; background:var(--panel); backdrop-filter:blur(10px);
    padding:18px 20px; cursor:pointer; transition:all .3s;
    display:flex; align-items:center; gap:16px; }
  .chest-card::before { content:''; position:absolute; inset:0;
    background:linear-gradient(135deg,rgba(240,192,64,.06) 0%,transparent 60%);
    opacity:0; transition:opacity .3s; }
  .chest-card:active { transform:scale(.98); }
  .chest-card:active::before { opacity:1; }
  .chest-card.wooden { border-color:rgba(139,90,43,.4); }
  .chest-card.silver { border-color:rgba(180,190,200,.4); }
  .chest-card.golden { border-color:rgba(240,192,64,.5); box-shadow:0 0 20px rgba(240,192,64,.08); }
  .chest-card.locked { opacity:.45; pointer-events:none; }
  .chest-icon-wrap { font-size:44px; flex-shrink:0;
    filter:drop-shadow(0 0 8px rgba(240,192,64,.3));
    animation:float 3s ease-in-out infinite; }
  .chest-card.golden .chest-icon-wrap { filter:drop-shadow(0 0 14px rgba(240,192,64,.6)); }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
  .chest-info { flex:1; }
  .chest-name { font-family:'Cinzel',serif; font-size:15px; font-weight:700;
    color:var(--text); margin-bottom:4px; }
  .chest-desc { font-size:13px; color:var(--text-dim); font-style:italic; margin-bottom:8px; }
  .chest-odds { display:flex; gap:5px; flex-wrap:wrap; }
  .odds-pill { font-size:10px; padding:2px 7px; border-radius:10px;
    font-family:'Cinzel',serif; font-weight:600; }
  .odds-pill.common    { background:rgba(150,150,150,.15); color:#aaa; border:1px solid rgba(150,150,150,.3); }
  .odds-pill.uncommon  { background:rgba(39,174,96,.15); color:#2ecc71; border:1px solid rgba(39,174,96,.3); }
  .odds-pill.rare      { background:rgba(41,128,185,.15); color:#5dade2; border:1px solid rgba(41,128,185,.3); }
  .odds-pill.epic      { background:rgba(142,68,173,.15); color:#bb8fce; border:1px solid rgba(142,68,173,.3); }
  .odds-pill.legendary { background:rgba(243,156,18,.15); color:#f0c040; border:1px solid rgba(243,156,18,.3); }
  .chest-cost { flex-shrink:0; text-align:center; }
  .cost-amount { font-family:'Cinzel',serif; font-size:18px; font-weight:700;
    color:var(--gold); display:block; text-shadow:0 0 10px var(--gold-glow); }
  .cost-label { font-size:10px; color:var(--text-dim); text-transform:uppercase; }

  /* Open overlay */
  #open-overlay { position:fixed; inset:0; z-index:100; background:rgba(0,0,0,.92);
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px;
    opacity:0; pointer-events:none; transition:opacity .3s; }
  #open-overlay.visible { opacity:1; pointer-events:all; }
  .opening-chest { font-size:90px; animation:shake .3s ease-in-out infinite;
    filter:drop-shadow(0 0 30px rgba(240,192,64,.5)); }
  @keyframes shake { 0%,100%{transform:rotate(-3deg) scale(1)} 50%{transform:rotate(3deg) scale(1.05)} }
  .opening-text { font-family:'Cinzel',serif; font-size:14px; letter-spacing:.3em;
    text-transform:uppercase; color:var(--text-dim);
    animation:pulse-text .8s ease-in-out infinite alternate; }
  @keyframes pulse-text { from{opacity:.4} to{opacity:1} }

  /* Reward overlay */
  #reward-overlay { position:fixed; inset:0; z-index:101; background:rgba(0,0,0,.88);
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px;
    opacity:0; pointer-events:none; transition:opacity .4s; }
  #reward-overlay.visible { opacity:1; pointer-events:all; }
  .reward-particles { position:absolute; inset:0; pointer-events:none; overflow:hidden; }
  .particle { position:absolute; border-radius:50%;
    animation:particle-fly 1.5s ease-out forwards; opacity:0; }
  @keyframes particle-fly { 0%{transform:translate(0,0) scale(0);opacity:1} 100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0} }
  .reward-badge { font-size:11px; padding:4px 16px; border-radius:20px;
    font-family:'Cinzel',serif; font-weight:600; letter-spacing:.15em; text-transform:uppercase;
    animation:badge-drop .4s cubic-bezier(.34,1.56,.64,1) .1s both; }
  .reward-badge.Common    { background:rgba(150,150,150,.2); color:#ccc; border:1px solid rgba(200,200,200,.3); }
  .reward-badge.Uncommon  { background:rgba(39,174,96,.2); color:#2ecc71; border:1px solid rgba(39,174,96,.4); }
  .reward-badge.Rare      { background:rgba(41,128,185,.2); color:#5dade2; border:1px solid rgba(41,128,185,.4); }
  .reward-badge.Epic      { background:rgba(142,68,173,.25); color:#bb8fce; border:1px solid rgba(142,68,173,.5); box-shadow:0 0 20px rgba(142,68,173,.3); }
  .reward-badge.Legendary { background:rgba(243,156,18,.2); color:#f0c040; border:1px solid rgba(243,156,18,.6); box-shadow:0 0 30px rgba(240,192,64,.4); }
  @keyframes badge-drop { from{transform:translateY(-20px) scale(.8);opacity:0} to{transform:none;opacity:1} }
  .reward-item-icon { font-size:72px; animation:item-appear .5s cubic-bezier(.34,1.56,.64,1) .2s both;
    filter:drop-shadow(0 0 20px rgba(240,192,64,.4)); }
  @keyframes item-appear { from{transform:scale(0) rotate(-15deg);opacity:0} to{transform:none;opacity:1} }
  .reward-item-name { font-family:'Cinzel',serif; font-size:22px; font-weight:700;
    color:var(--text); text-align:center; animation:item-appear .5s cubic-bezier(.34,1.56,.64,1) .3s both; }
  .reward-item-name.Legendary { color:var(--gold); text-shadow:0 0 20px var(--gold-glow),0 0 40px var(--gold-glow); }
  .reward-item-name.Epic { color:#bb8fce; text-shadow:0 0 15px rgba(142,68,173,.6); }
  .reward-value { font-size:15px; color:var(--text-dim); font-style:italic;
    animation:item-appear .5s ease .4s both; }
  .reward-value span { color:var(--gold); font-style:normal; font-family:'Cinzel',serif; }
  .reward-actions { display:flex; gap:10px; margin-top:8px; animation:item-appear .4s ease .55s both; }
  .btn-primary { padding:12px 24px;
    background:linear-gradient(135deg,#a07820,#f0c040,#a07820);
    background-size:200% 100%; background-position:100%;
    border:none; border-radius:12px; font-family:'Cinzel',serif; font-size:13px;
    font-weight:700; color:#1a1000; cursor:pointer; transition:all .3s;
    box-shadow:0 4px 20px rgba(240,192,64,.3); }
  .btn-primary:active { transform:scale(.96); background-position:0%; }
  .btn-secondary { padding:12px 20px; background:rgba(255,255,255,.06);
    border:1px solid var(--border); border-radius:12px; font-family:'Cinzel',serif;
    font-size:13px; font-weight:600; color:var(--text-dim); cursor:pointer; transition:all .2s; }
  .btn-secondary:active { transform:scale(.96); }

  /* Inventory */
  .inv-stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:4px; }
  .stat-card { background:var(--panel); border:1px solid var(--border);
    border-radius:12px; padding:12px 14px; backdrop-filter:blur(8px); }
  .stat-label { font-size:10px; color:var(--text-dim); text-transform:uppercase;
    letter-spacing:.1em; font-family:'Cinzel',serif; margin-bottom:4px; }
  .stat-value { font-family:'Cinzel',serif; font-size:18px; font-weight:700; color:var(--gold); }
  .sell-all-btn { width:100%; padding:12px; background:rgba(192,57,43,.12);
    border:1px solid rgba(192,57,43,.3); border-radius:12px; font-family:'Cinzel',serif;
    font-size:12px; font-weight:600; color:#e74c3c; letter-spacing:.1em; text-transform:uppercase;
    cursor:pointer; transition:all .2s; margin-bottom:4px; }
  .sell-all-btn:active { background:rgba(192,57,43,.25); transform:scale(.98); }
  .inv-item { display:flex; align-items:center; gap:12px; background:var(--panel);
    border:1px solid var(--border); border-radius:12px; padding:12px 14px; margin-bottom:8px;
    cursor:pointer; transition:all .2s; backdrop-filter:blur(8px); }
  .inv-item:active { transform:scale(.98); background:rgba(240,192,64,.06); }
  .inv-item.rarity-Legendary { border-color:rgba(240,192,64,.45); box-shadow:0 0 12px rgba(240,192,64,.08); }
  .inv-item.rarity-Epic { border-color:rgba(142,68,173,.4); }
  .inv-item.rarity-Rare { border-color:rgba(41,128,185,.35); }
  .item-emoji { font-size:28px; flex-shrink:0; }
  .item-info  { flex:1; min-width:0; }
  .item-name  { font-family:'Cinzel',serif; font-size:13px; font-weight:600; color:var(--text); }
  .item-rarity { font-size:11px; margin-top:2px; }
  .item-rarity.Common { color:#aaa; } .item-rarity.Uncommon { color:#2ecc71; }
  .item-rarity.Rare { color:#5dade2; } .item-rarity.Epic { color:#bb8fce; }
  .item-rarity.Legendary { color:var(--gold); }
  .item-right { text-align:right; flex-shrink:0; }
  .item-count { font-family:'Cinzel',serif; font-size:12px; color:var(--text-dim); }
  .item-value { font-family:'Cinzel',serif; font-size:14px; font-weight:600; color:var(--gold); margin-top:2px; }

  /* Sell modal */
  #sell-modal { position:fixed; inset:0; z-index:200; background:rgba(0,0,0,.85);
    display:flex; align-items:flex-end; justify-content:center;
    opacity:0; pointer-events:none; transition:opacity .3s; }
  #sell-modal.visible { opacity:1; pointer-events:all; }
  .sell-sheet { width:100%; max-width:480px; background:var(--bg2);
    border:1px solid var(--border); border-bottom:none; border-radius:24px 24px 0 0;
    padding:28px 24px 36px; transform:translateY(100%);
    transition:transform .35s cubic-bezier(.32,.72,0,1); }
  #sell-modal.visible .sell-sheet { transform:translateY(0); }
  .sell-handle { width:40px; height:4px; background:var(--border); border-radius:2px; margin:0 auto 20px; }
  .sell-item-display { display:flex; align-items:center; gap:16px; margin-bottom:20px; }
  .sell-item-icon { font-size:52px; }
  .sell-item-name { font-family:'Cinzel',serif; font-size:17px; font-weight:700; color:var(--text); }
  .sell-item-sub  { font-size:13px; color:var(--text-dim); margin-top:3px; font-style:italic; }
  .sell-options { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .sell-option { padding:14px 10px; border-radius:12px; background:rgba(240,192,64,.06);
    border:1px solid rgba(240,192,64,.2); text-align:center; cursor:pointer; transition:all .2s; }
  .sell-option:active { background:rgba(240,192,64,.15); transform:scale(.96); }
  .sell-option.sell-all-opt { grid-column:1/-1; background:rgba(192,57,43,.1); border-color:rgba(192,57,43,.3); }
  .sell-opt-count { font-family:'Cinzel',serif; font-size:13px; font-weight:700; color:var(--text); margin-bottom:2px; }
  .sell-opt-gold  { font-size:12px; color:var(--gold); }
  .sell-cancel { width:100%; margin-top:12px; padding:12px; background:transparent;
    border:1px solid var(--border); border-radius:12px; color:var(--text-dim);
    font-family:'Cinzel',serif; font-size:12px; cursor:pointer; transition:all .2s; }

  /* Profile */
  .profile-hero { background:var(--panel); border:1px solid var(--border);
    border-radius:16px; padding:20px; margin-bottom:12px; text-align:center;
    backdrop-filter:blur(10px); position:relative; overflow:hidden; }
  .profile-hero::before { content:''; position:absolute; inset:0;
    background:radial-gradient(ellipse at 50% 0%,rgba(240,192,64,.08) 0%,transparent 70%); }
  .profile-avatar { font-size:56px; margin-bottom:8px; filter:drop-shadow(0 0 16px rgba(240,192,64,.4)); }
  .profile-name { font-family:'Cinzel',serif; font-size:20px; font-weight:700;
    color:var(--gold); text-shadow:0 0 12px var(--gold-glow); }
  .profile-sub { font-size:13px; color:var(--text-dim); margin-top:4px; font-style:italic; }
  .profile-stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }
  .profile-stat { background:var(--panel); border:1px solid var(--border);
    border-radius:12px; padding:14px; backdrop-filter:blur(8px); }
  .ps-icon  { font-size:20px; margin-bottom:6px; }
  .ps-value { font-family:'Cinzel',serif; font-size:20px; font-weight:700; color:var(--gold); }
  .ps-label { font-size:11px; color:var(--text-dim); text-transform:uppercase;
    letter-spacing:.08em; font-family:'Cinzel',serif; margin-top:2px; }
  .ref-card { background:var(--panel); border:1px solid rgba(240,192,64,.3);
    border-radius:16px; padding:18px 20px; backdrop-filter:blur(10px);
    position:relative; overflow:hidden; margin-bottom:12px; }
  .ref-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px;
    background:linear-gradient(90deg,transparent,var(--gold),transparent); opacity:.6; }
  .ref-title { font-family:'Cinzel',serif; font-size:13px; font-weight:700; color:var(--gold); margin-bottom:6px; }
  .ref-desc  { font-size:13px; color:var(--text-dim); font-style:italic; margin-bottom:14px; }
  .ref-reward { display:flex; align-items:center; gap:8px; margin-bottom:14px;
    padding:10px 14px; background:rgba(240,192,64,.08); border-radius:10px; border:1px solid rgba(240,192,64,.2); }
  .ref-reward-text { font-family:'Cinzel',serif; font-size:14px; font-weight:600; color:var(--gold); }
  .ref-reward-sub  { font-size:12px; color:var(--text-dim); }
  .ref-link-box { background:rgba(0,0,0,.3); border:1px solid var(--border);
    border-radius:10px; padding:10px 14px; font-size:12px; color:var(--text-dim);
    font-family:monospace; word-break:break-all; margin-bottom:10px; }
  .ref-link-label { font-family:'Cinzel',serif; font-size:10px; color:var(--text-dim);
    text-transform:uppercase; letter-spacing:.1em; margin-bottom:4px; }
  .ref-share-btn { width:100%; padding:13px; background:linear-gradient(135deg,rgba(240,192,64,.15),rgba(240,192,64,.08));
    border:1px solid rgba(240,192,64,.35); border-radius:12px; font-family:'Cinzel',serif;
    font-size:13px; font-weight:700; color:var(--gold); cursor:pointer; transition:all .2s; }
  .ref-share-btn:active { background:rgba(240,192,64,.2); transform:scale(.98); }
  .ref-person { display:flex; align-items:center; gap:12px; padding:12px 14px; margin-bottom:8px;
    background:var(--panel); border:1px solid var(--border); border-radius:12px; backdrop-filter:blur(8px); }
  .ref-person-name { font-family:'Cinzel',serif; font-size:13px; color:var(--text); flex:1; }
  .ref-person-ts   { font-size:11px; color:var(--text-dim); }
  .ref-person-gold { font-family:'Cinzel',serif; font-size:13px; font-weight:600; color:var(--gold); }

  /* Toast */
  #toast { position:fixed; bottom:90px; left:50%; transform:translateX(-50%) translateY(20px);
    z-index:300; background:rgba(20,16,10,.95); border:1px solid var(--border);
    border-radius:12px; padding:12px 20px; font-family:'Cinzel',serif; font-size:13px;
    color:var(--text); white-space:nowrap; opacity:0; pointer-events:none; transition:all .3s;
    box-shadow:0 8px 32px rgba(0,0,0,.5); }
  #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

  .empty-state { text-align:center; padding:50px 20px; }
  .empty-icon  { font-size:52px; margin-bottom:14px; opacity:.4; }
  .empty-text  { font-family:'Cinzel',serif; font-size:14px; color:var(--text-dim); font-weight:600; margin-bottom:6px; }
  .empty-sub   { font-size:13px; color:var(--text-dim); opacity:.6; font-style:italic; }

  /* Error banner */
  #error-banner { display:none; position:fixed; top:0; left:0; right:0; z-index:500;
    background:#c0392b; color:#fff; padding:10px 16px; font-family:'Cinzel',serif;
    font-size:12px; text-align:center; }
</style>
</head>
<body>
<div id="stars"></div>
<div id="error-banner" id="error-banner"></div>

<div id="app">
  <header>
    <div class="logo">Treasure Chest<span>Fantasy Loot Game</span></div>
    <div class="gold-display">
      <span class="gold-coin">ü™ô</span>
      <span class="gold-amount" id="gold-display">‚Äî</span>
    </div>
  </header>
  <nav>
    <button class="nav-btn active" onclick="showScreen('chests')" id="nav-chests">
      <span class="nav-icon">üì¶</span>Chests
    </button>
    <button class="nav-btn" onclick="showScreen('inventory')" id="nav-inventory">
      <span class="nav-icon">üéí</span>Bag
    </button>
    <button class="nav-btn" onclick="showScreen('profile')" id="nav-profile">
      <span class="nav-icon">üë§</span>Profile
    </button>
  </nav>

  <div id="screens">
    <!-- CHESTS -->
    <div class="screen active" id="screen-chests">
      <div class="section-title">Choose Your Chest</div>
      <div class="chest-grid">
        <div class="chest-card wooden" onclick="openChest('wooden')">
          <div class="chest-icon-wrap">üì¶</div>
          <div class="chest-info">
            <div class="chest-name">Wooden Chest</div>
            <div class="chest-desc">A basic chest. Cheap, but worth trying!</div>
            <div class="chest-odds">
              <span class="odds-pill common">50% Cmn</span>
              <span class="odds-pill uncommon">30% Unc</span>
              <span class="odds-pill rare">15% Rare</span>
              <span class="odds-pill epic">4% Epic</span>
              <span class="odds-pill legendary">1% Leg</span>
            </div>
          </div>
          <div class="chest-cost"><span class="cost-amount">30</span><span class="cost-label">Gold</span></div>
        </div>
        <div class="chest-card silver" onclick="openChest('silver')">
          <div class="chest-icon-wrap">ü•à</div>
          <div class="chest-info">
            <div class="chest-name">Silver Chest</div>
            <div class="chest-desc">Better odds for rarer loot.</div>
            <div class="chest-odds">
              <span class="odds-pill common">44% Cmn</span>
              <span class="odds-pill uncommon">27% Unc</span>
              <span class="odds-pill rare">19% Rare</span>
              <span class="odds-pill epic">6% Epic</span>
              <span class="odds-pill legendary">4% Leg</span>
            </div>
          </div>
          <div class="chest-cost"><span class="cost-amount">100</span><span class="cost-label">Gold</span></div>
        </div>
        <div class="chest-card golden" onclick="openChest('golden')">
          <div class="chest-icon-wrap">üèÜ</div>
          <div class="chest-info">
            <div class="chest-name">Golden Chest</div>
            <div class="chest-desc">High chance of Epic & Legendary!</div>
            <div class="chest-odds">
              <span class="odds-pill common">30% Cmn</span>
              <span class="odds-pill uncommon">20% Unc</span>
              <span class="odds-pill rare">28% Rare</span>
              <span class="odds-pill epic">10% Epic</span>
              <span class="odds-pill legendary">12% Leg</span>
            </div>
          </div>
          <div class="chest-cost"><span class="cost-amount">300</span><span class="cost-label">Gold</span></div>
        </div>
      </div>
    </div>

    <!-- INVENTORY -->
    <div class="screen" id="screen-inventory">
      <div class="inv-stats">
        <div class="stat-card"><div class="stat-label">Items</div><div class="stat-value" id="inv-count">‚Äî</div></div>
        <div class="stat-card"><div class="stat-label">Total Value</div><div class="stat-value" id="inv-value">‚Äî</div></div>
      </div>
      <button class="sell-all-btn" onclick="sellAll()">üóëÔ∏è Sell Everything</button>
      <div class="section-title">Your Items</div>
      <div id="inv-list"><div class="loading-wrap"><div class="spinner"></div><div class="loading-text">Loading...</div></div></div>
    </div>

    <!-- PROFILE -->
    <div class="screen" id="screen-profile">
      <div class="profile-hero">
        <div class="profile-avatar">‚öîÔ∏è</div>
        <div class="profile-name" id="profile-name">Adventurer</div>
        <div class="profile-sub">Treasure Hunter</div>
      </div>
      <div class="profile-stats">
        <div class="profile-stat"><div class="ps-icon">üì¶</div><div class="ps-value" id="stat-chests">‚Äî</div><div class="ps-label">Chests Opened</div></div>
        <div class="profile-stat"><div class="ps-icon">üí∏</div><div class="ps-value" id="stat-earned">‚Äî</div><div class="ps-label">Total Sold</div></div>
        <div class="profile-stat"><div class="ps-icon">üë•</div><div class="ps-value" id="stat-refs">‚Äî</div><div class="ps-label">Referrals</div></div>
        <div class="profile-stat"><div class="ps-icon">üíé</div><div class="ps-value" id="stat-networth">‚Äî</div><div class="ps-label">Net Worth</div></div>
      </div>
      <div class="ref-card">
        <div class="ref-title">üë• Referral Program</div>
        <div class="ref-desc">Invite friends and earn gold for each adventurer who joins!</div>
        <div class="ref-reward">
          <div style="font-size:20px">ü™ô</div>
          <div><div class="ref-reward-text">+500 Gold per referral</div><div class="ref-reward-sub">Paid instantly when they join</div></div>
        </div>
        <div class="ref-link-label">Your Link</div>
        <div class="ref-link-box" id="ref-link-display">Loading...</div>
        <button class="ref-share-btn" onclick="shareReferral()">üîó Share Referral Link</button>
      </div>
      <div class="section-title">Your Referrals</div>
      <div id="ref-list"></div>
    </div>
  </div>
</div>

<!-- Opening -->
<div id="open-overlay">
  <div class="opening-chest" id="opening-chest-icon">üì¶</div>
  <div class="opening-text">Opening Chest...</div>
</div>

<!-- Reward -->
<div id="reward-overlay">
  <div class="reward-particles" id="reward-particles"></div>
  <div class="reward-badge" id="reward-badge">Common</div>
  <div class="reward-item-icon" id="reward-icon">üß™</div>
  <div class="reward-item-name" id="reward-name">Item</div>
  <div class="reward-value">Worth <span id="reward-value">0</span>ü™ô</div>
  <div class="reward-actions">
    <button class="btn-primary" onclick="keepItem()">Keep It</button>
    <button class="btn-secondary" onclick="sellItem()">Sell Now</button>
  </div>
</div>

<!-- Sell Modal -->
<div id="sell-modal" onclick="closeSellModal(event)">
  <div class="sell-sheet">
    <div class="sell-handle"></div>
    <div class="sell-item-display">
      <div class="sell-item-icon" id="modal-icon">üß™</div>
      <div><div class="sell-item-name" id="modal-name">Item</div><div class="sell-item-sub" id="modal-rarity"></div></div>
    </div>
    <div class="sell-options" id="sell-options"></div>
    <button class="sell-cancel" onclick="closeSellModal()">Cancel</button>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG ‚Äî –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π —Ä–µ–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å!
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—à—å –ª–æ–∫–∞–ª—å–Ω–æ: "http://localhost:8000"
// –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ: "https://—Ç–≤–æ–π-–¥–æ–º–µ–Ω.com"
const API_BASE = "https://treasure-chest-bot.onrender.com";
const BOT_USERNAME = "plovinhogame_bot";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TELEGRAM INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); }

const initData = tg?.initData || "";

// –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≤—Å–µ—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤
function apiHeaders() {
  const h = { "Content-Type": "application/json" };
  if (initData) h["X-Telegram-Init-Data"] = initData;
  // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ Telegram:
  else if (tg?.initDataUnsafe?.user?.id)
    h["X-User-Id"] = String(tg.initDataUnsafe.user.id);
  return h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = { gold:0, inventory:{}, chests_opened:0, total_earned:0,
              referrals:[], first_name:"Adventurer", username:null };
let pendingItem = null;
let modalItem   = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  API CALLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function apiFetch(path, options={}) {
  try {
    const res = await fetch(API_BASE + path, {
      headers: apiHeaders(),
      ...options,
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>({detail:"Server error"}));
      throw new Error(err.detail || "Error");
    }
    return await res.json();
  } catch(e) {
    if (e.message === "Failed to fetch") {
      showError("Cannot connect to server. Is bot.py running?");
    } else {
      showToast("‚ùå " + e.message);
    }
    throw e;
  }
}

async function loadPlayer() {
  const data = await apiFetch("/api/player");
  state = { ...state, ...data };
  updateGoldDisplay();
}

async function doOpenChest(chestType) {
  const data = await apiFetch("/api/open_chest", {
    method: "POST",
    body: JSON.stringify({ chest_type: chestType }),
  });
  state.gold = data.gold;
  // Update inventory count locally
  const key = data.item_key;
  state.inventory[key] = (state.inventory[key] || 0) + 1;
  return data;
}

async function doSell(itemKey, qty) {
  const data = await apiFetch("/api/sell", {
    method: "POST",
    body: JSON.stringify({ item_key: itemKey, quantity: qty }),
  });
  state.gold = data.gold;
  state.inventory[itemKey] = (state.inventory[itemKey] || 0) - data.sold;
  if (state.inventory[itemKey] <= 0) delete state.inventory[itemKey];
  return data;
}

async function doSellAll() {
  const data = await apiFetch("/api/sell_all", { method: "POST" });
  state.gold = data.gold;
  state.inventory = {};
  return data;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateGoldDisplay() {
  const el = document.getElementById("gold-display");
  el.style.transform = "scale(1.2)";
  el.style.color = "#fff";
  el.textContent = state.gold;
  setTimeout(() => { el.style.transform=""; el.style.color=""; }, 300);
}

function showScreen(name) {
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
  document.getElementById("screen-"+name).classList.add("active");
  document.getElementById("nav-"+name).classList.add("active");
  if (name==="inventory") renderInventory();
  if (name==="profile")   renderProfile();
}

const RARITY_ORDER = ["Common","Uncommon","Rare","Epic","Legendary"];

function renderInventory() {
  const items = Object.entries(state.inventory).filter(([,v])=>v>0);
  const count = items.reduce((a,[,v])=>a+v,0);
  // We need item data ‚Äî fetch from API on first load, then cache
  document.getElementById("inv-count").textContent = count;

  if (!window._items) {
    apiFetch("/api/items").then(d => { window._items=d; renderInventory(); });
    return;
  }
  const ITEMS = window._items;
  const value = items.reduce((a,[k,v])=>a+(ITEMS[k]?.value||0)*v,0);
  document.getElementById("inv-value").textContent = value+"ü™ô";

  const sorted = [...items].sort((a,b)=>
    RARITY_ORDER.indexOf(ITEMS[b[0]]?.rarity) - RARITY_ORDER.indexOf(ITEMS[a[0]]?.rarity)
  );
  const list = document.getElementById("inv-list");
  if (!sorted.length) {
    list.innerHTML=`<div class="empty-state"><div class="empty-icon">üéí</div>
      <div class="empty-text">Inventory Empty</div>
      <div class="empty-sub">Open some chests to find loot!</div></div>`;
    return;
  }
  list.innerHTML = sorted.map(([key,cnt]) => {
    const item = ITEMS[key] || {};
    return `<div class="inv-item rarity-${item.rarity}" onclick="openSellModal('${key}')">
      <div class="item-emoji">${item.emoji||"üì¶"}</div>
      <div class="item-info">
        <div class="item-name">${item.name||key}</div>
        <div class="item-rarity ${item.rarity}">‚¨• ${item.rarity}</div>
      </div>
      <div class="item-right">
        <div class="item-count">√ó${cnt}</div>
        <div class="item-value">${(item.value||0)*cnt}ü™ô</div>
      </div>
    </div>`;
  }).join("");
}

function renderProfile() {
  document.getElementById("profile-name").textContent = state.first_name || "Adventurer";
  document.getElementById("stat-chests").textContent  = state.chests_opened;
  document.getElementById("stat-earned").textContent  = state.total_earned+"ü™ô";
  document.getElementById("stat-refs").textContent    = state.referrals.length;

  const ITEMS = window._items || {};
  const invVal = Object.entries(state.inventory)
    .reduce((a,[k,v])=>a+(ITEMS[k]?.value||0)*v, 0);
  document.getElementById("stat-networth").textContent = (state.gold+invVal)+"ü™ô";

  const uid = tg?.initDataUnsafe?.user?.id || "demo";
  const link = `https://t.me/${BOT_USERNAME}?start=ref_${uid}`;
  document.getElementById("ref-link-display").textContent = link;

  const refList = document.getElementById("ref-list");
  if (!state.referrals.length) {
    refList.innerHTML=`<div class="empty-state"><div class="empty-icon">üë•</div>
      <div class="empty-text">No Referrals Yet</div>
      <div class="empty-sub">Share your link to earn 500ü™ô per friend!</div></div>`;
  } else {
    refList.innerHTML = state.referrals.map(r=>`
      <div class="ref-person">
        <div style="font-size:24px">üë§</div>
        <div class="ref-person-name">${r.name}</div>
        <div class="ref-person-ts">${r.ts}</div>
        <div class="ref-person-gold">+500ü™ô</div>
      </div>`).join("");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHEST OPENING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openChest(chestKey) {
  const costs = {wooden:30, silver:100, golden:300};
  if (state.gold < costs[chestKey]) { showToast("‚ùå Not enough gold!"); return; }

  document.querySelectorAll(".chest-card").forEach(c=>c.classList.add("locked"));
  const icons = {wooden:"üì¶", silver:"ü•à", golden:"üèÜ"};
  document.getElementById("opening-chest-icon").textContent = icons[chestKey];
  document.getElementById("open-overlay").classList.add("visible");

  try {
    // Small delay for animation
    await new Promise(r=>setTimeout(r,1400));
    const result = await doOpenChest(chestKey);
    document.getElementById("open-overlay").classList.remove("visible");
    updateGoldDisplay();
    pendingItem = result.item_key;
    showReward(result.item);
  } catch(e) {
    document.getElementById("open-overlay").classList.remove("visible");
  } finally {
    document.querySelectorAll(".chest-card").forEach(c=>c.classList.remove("locked"));
  }
}

function showReward(item) {
  document.getElementById("reward-badge").textContent = item.rarity;
  document.getElementById("reward-badge").className   = "reward-badge "+item.rarity;
  document.getElementById("reward-icon").textContent  = item.emoji;
  document.getElementById("reward-name").textContent  = item.name;
  document.getElementById("reward-name").className    = "reward-item-name "+item.rarity;
  document.getElementById("reward-value").textContent = item.value;

  // Particles
  const pc = document.getElementById("reward-particles");
  pc.innerHTML="";
  const colors = {Common:"#aaa",Uncommon:"#2ecc71",Rare:"#5dade2",Epic:"#bb8fce",Legendary:"#f0c040"};
  const count  = {Common:10,Uncommon:15,Rare:20,Epic:28,Legendary:45}[item.rarity]||12;
  for (let i=0;i<count;i++) {
    const p=document.createElement("div");
    p.className="particle";
    const sz=Math.random()*6+4;
    p.style.cssText=`width:${sz}px;height:${sz}px;background:${colors[item.rarity]};
      left:50%;top:50%;--tx:${(Math.random()-.5)*300}px;--ty:${(Math.random()-.5)*400}px;
      animation-delay:${Math.random()*.3}s;animation-duration:${Math.random()*.8+.8}s`;
    pc.appendChild(p);
  }
  document.getElementById("reward-overlay").classList.add("visible");
  if (tg?.HapticFeedback) {
    const t={Common:"light",Uncommon:"medium",Rare:"medium",Epic:"heavy",Legendary:"heavy"}[item.rarity];
    tg.HapticFeedback.impactOccurred(t||"light");
    if (item.rarity==="Legendary") setTimeout(()=>tg.HapticFeedback.notificationOccurred("success"),300);
  }
}

function keepItem() {
  document.getElementById("reward-overlay").classList.remove("visible");
  pendingItem=null;
  showToast("üéí Added to inventory!");
}

async function sellItem() {
  if (!pendingItem) return;
  try {
    const data = await doSell(pendingItem, 1);
    updateGoldDisplay();
    document.getElementById("reward-overlay").classList.remove("visible");
    showToast(`üí∞ Sold for ${data.earnings}ü™ô!`);
  } catch(e) {}
  pendingItem=null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SELL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSellModal(itemKey) {
  if (!window._items) return;
  modalItem = itemKey;
  const item  = window._items[itemKey];
  const count = state.inventory[itemKey] || 0;
  document.getElementById("modal-icon").textContent    = item.emoji;
  document.getElementById("modal-name").textContent    = item.name;
  document.getElementById("modal-rarity").textContent  = `${item.rarity} ¬∑ ${item.value}ü™ô each`;

  let html="";
  const addOpt=(label,qty,gold,cls="")=>
    html+=`<div class="sell-option ${cls}" onclick="executeSell(${qty})">
      <div class="sell-opt-count">${label}</div><div class="sell-opt-gold">${gold}ü™ô</div></div>`;

  addOpt("Sell √ó1",1,item.value);
  if(count>=5)  addOpt("Sell √ó5",5,item.value*5);
  if(count>=10) addOpt("Sell √ó10",10,item.value*10);
  if(count>1)   addOpt(`Sell All (√ó${count})`,-1,item.value*count,"sell-all-opt");
  document.getElementById("sell-options").innerHTML=html;
  document.getElementById("sell-modal").classList.add("visible");
}

function closeSellModal(e) {
  if (e && e.target!==document.getElementById("sell-modal")) return;
  document.getElementById("sell-modal").classList.remove("visible");
  modalItem=null;
}

async function executeSell(qty) {
  if (!modalItem) return;
  const ITEMS = window._items||{};
  try {
    const data = await doSell(modalItem, qty);
    updateGoldDisplay();
    renderInventory();
    document.getElementById("sell-modal").classList.remove("visible");
    showToast(`üí∞ Sold for ${data.earnings}ü™ô!`);
  } catch(e) {}
  modalItem=null;
}

async function sellAll() {
  const items=Object.entries(state.inventory).filter(([,v])=>v>0);
  if (!items.length){showToast("üéí Inventory is empty!");return;}
  try {
    const data=await doSellAll();
    updateGoldDisplay();
    renderInventory();
    showToast(`üí∞ Sold everything for ${data.earnings}ü™ô!`);
  } catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REFERRAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shareReferral() {
  const uid  = tg?.initDataUnsafe?.user?.id||"demo";
  const link = `https://t.me/${BOT_USERNAME}?start=ref_${uid}`;
  const text = "‚öîÔ∏è Join me in Treasure Chest ‚Äî a fantasy loot game! Open chests, collect legendary items.";
  if (tg?.openTelegramLink) {
    tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`);
  } else if (navigator.share) {
    navigator.share({title:"Treasure Chest",text,url:link});
  } else {
    navigator.clipboard?.writeText(link);
    showToast("üîó Link copied!");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST / ERROR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function showToast(msg) {
  const t=document.getElementById("toast");
  t.textContent=msg; t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove("show"),2200);
}

function showError(msg) {
  const b=document.getElementById("error-banner");
  b.textContent="‚ö†Ô∏è "+msg; b.style.display="block";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async()=>{
  // Load items catalogue
  apiFetch("/api/items").then(d=>{ window._items=d; });
  // Load player data
  try { await loadPlayer(); }
  catch(e) { console.warn("Could not load player:", e); }
})();
</script>
</body>
</html>
